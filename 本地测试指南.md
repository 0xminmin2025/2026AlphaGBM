# 本地部署测试指南

## 🚀 快速启动

### 1. 检查环境

```bash
# 确认Python版本（需要3.8+）
python3 --version

# 确认虚拟环境已激活（如果使用）
which python3
```

### 2. 安装/更新依赖

```bash
# 确保所有依赖已安装
pip install -r requirements.txt

# 特别检查新增的依赖
pip install akshare  # A股解禁数据需要
```

### 3. 检查环境变量

确认 `.env` 文件存在并包含必要的API密钥：

```bash
# 检查.env文件
cat .env | grep -E "GOOGLE_API_KEY|JWT_SECRET_KEY"
```

必需的环境变量：
- `GOOGLE_API_KEY`: Gemini AI API密钥（必需，用于生成AI报告）
- `JWT_SECRET_KEY`: JWT密钥（可选，用于用户认证）

### 4. 启动服务器

```bash
# 方式1：直接运行
python3 app.py

# 方式2：使用Flask命令（如果配置了FLASK_APP）
flask run

# 方式3：指定端口运行
python3 app.py --port 5000
```

默认启动在：`http://localhost:5000`

## 🧪 测试新功能

### 测试1：IPO与解禁监控（美股/港股）

**测试股票**：选择一个近期IPO的股票

```bash
# 示例：测试一个美股次新股
# 在浏览器中访问：http://localhost:5000
# 输入股票代码，选择投资风格，点击分析
```

**预期结果**：
- 如果股票有IPO日期，系统应计算解禁日期（IPO+180天）
- 如果距离解禁期 < 14天，应在风险评分中增加风险分
- 在AI报告中应显示解禁期警告

**检查点**：
1. 查看返回的JSON数据中是否有 `lockup_data` 字段
2. 查看风险评分是否包含解禁期风险
3. 查看AI报告是否包含解禁期警告

### 测试2：IPO与解禁监控（A股）

**测试股票**：选择一个A股次新股（如：688XXX, 300XXX）

```bash
# 示例：测试A股次新股
# 输入A股代码，如：688111
```

**预期结果**：
- 系统应通过AkShare获取限售股解禁数据
- 显示解禁日期、解禁股数、占总股本比例
- 如果距离解禁期 < 14天，触发供给侧冲击警告

**检查点**：
1. 查看 `lockup_data` 中是否有 `lockup_events` 数组
2. 查看是否有 `lockup_shares_ratio`（解禁股数比例）
3. 查看AI报告中是否显示A股特有的解禁信息

### 测试3：财报日期风险

**测试股票**：任意股票（最好选择接近财报日的股票）

**预期结果**：
- 如果财报日期 < 7天：风险评分+1分，高危警告
- 如果财报日期 7-14天：风险评分+0.5分，中危提醒
- AI报告中应包含财报日避险检查规则

**检查点**：
1. 查看风险评分中是否有"财报日风险"标志
2. 查看AI报告的"交易策略"部分是否包含财报日避险检查
3. 查看AI报告的"卖出策略"部分是否包含财报日避险规则

### 测试4：目标价格周期说明

**测试股票**：任意股票

**预期结果**：
- AI报告中应明确说明"本目标价格为6-12个月的中期目标价"
- 解释周期合理性（3-6个月太短，需要2个季度以上验证）

**检查点**：
1. 查看AI报告的"估值分析与交易策略"部分
2. 确认目标价格部分包含周期定义说明

## 🔍 调试技巧

### 查看日志

```bash
# 实时查看应用日志
tail -f logs/app.log

# 查看错误日志
grep -i error logs/app.log
```

### 测试API接口

```bash
# 测试分析接口（需要先登录获取token）
curl -X POST http://localhost:5000/api/analyze \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "ticker": "AAPL",
    "style": "quality"
  }'
```

### 检查数据获取

在代码中添加调试输出：

```python
# 在 analysis_engine.py 的 get_ipo_lockup_data() 函数中
print(f"IPO数据: {lockup_data}")  # 临时调试输出
```

## ⚠️ 常见问题

### 1. AkShare接口错误

**问题**：A股解禁数据获取失败

**解决方案**：
```bash
# 更新AkShare到最新版本
pip install --upgrade akshare

# 如果接口变更，查看AkShare文档
# https://akshare.readthedocs.io/
```

### 2. IPO日期获取失败

**问题**：美股/港股无法获取IPO日期

**原因**：
- yfinance可能不提供IPO日期（某些股票）
- IPO日期字段名称可能不同

**解决方案**：
- 检查 `info.get('ipoDate')` 是否返回None
- 尝试其他字段名：`info.get('firstTradeDate')` 等
- 系统会优雅降级，不影响其他功能

### 3. Gemini API错误

**问题**：AI报告生成失败

**检查**：
```bash
# 确认API密钥有效
cat .env | grep GOOGLE_API_KEY

# 检查API配额
# 访问：https://makersuite.google.com/app/apikey
```

**降级方案**：系统会自动使用备用分析（`get_fallback_analysis()`）

### 4. 数据库错误

**问题**：SQLite数据库权限错误

**解决方案**：
```bash
# 检查数据库目录权限
ls -la data/

# 如果需要，创建数据库目录
mkdir -p data
chmod 755 data
```

## 📊 测试检查清单

- [ ] 服务器成功启动（无错误）
- [ ] 美股/港股IPO解禁监控正常工作
- [ ] A股解禁数据获取正常（如果测试A股）
- [ ] 财报日期风险评分正常
- [ ] 目标价格周期说明出现在AI报告中
- [ ] 财报日避险检查规则出现在AI报告中
- [ ] 解禁期警告出现在AI报告中（如果适用）
- [ ] 风险评分计算正确（包含新增风险项）
- [ ] 日志文件正常记录

## 🎯 推荐测试股票

### 美股次新股（测试解禁期）
- 选择2024年IPO的股票（如：ARM, RIVN等）
- 检查是否有IPO日期和解禁日期

### A股次新股（测试A股解禁）
- 688XXX（科创板）
- 300XXX（创业板）
- 检查AkShare数据获取是否正常

### 接近财报日的股票
- 任意股票，但最好选择接近财报发布日的
- 检查财报日期风险评分

---

**提示**：如果遇到问题，查看 `logs/app.log` 获取详细错误信息。
