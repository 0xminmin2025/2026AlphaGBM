<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaGBM 股票研究报告生成系统逻辑全景</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --accent-yellow: #f59e0b;
            --accent-pink: #ec4899;
        }
        body {
            background-color: var(--bg-dark);
            color: #e2e8f0;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }
        .section-title {
            border-bottom: 2px solid;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .flow-arrow {
            position: absolute;
            top: 50%;
            right: -20px;
            transform: translateY(-50%);
            color: #64748b;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }
        .hover-card {
            transition: all 0.3s ease;
        }
        .hover-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            border-color: rgba(255,255,255,0.2);
        }
        .badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 9999px;
            font-weight: bold;
        }
        .detail-list li {
            position: relative;
            padding-left: 1rem;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
            color: #94a3b8;
        }
        .detail-list li::before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--accent-blue);
        }
        .logic-box {
            background: #334155;
            border-left: 3px solid;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-family: monospace;
            font-size: 0.8rem;
        }
        /* Mermaid override */
        .mermaid {
            background: transparent !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Header -->
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">
            <i class="fas fa-network-wired mr-3"></i>AlphaGBM 系统全景图
        </h1>
        <p class="text-slate-400">从数据获取到 AI 报告生成的端到端可视化逻辑文档</p>
    </header>

    <!-- Top Level Workflow (Mermaid) -->
    <section class="glass-panel p-6 mb-8 overflow-x-auto">
        <h2 class="text-xl font-bold mb-4 text-blue-400"><i class="fas fa-project-diagram"></i> 核心处理流程</h2>
        <div class="mermaid text-center">
            graph LR
                A[用户请求<br/>Ticker + Style] -->|验证/JWT| B(一阶段: 数据获取)
                B -->|标准化代码| C{市场类型?}
                C -->|美股/港股| D[Yahoo/AlphaVantage]
                C -->|A股| E[AkShare/中国情绪]
                D & E --> F(解禁监控/IPO)
                F --> G(二阶段: 量化分析)
                G -->|G=B+M| H[风险/仓位/目标价/EV]
                H --> I(三阶段: AI生成)
                I -->|Prompt构建| J[Gemini 1.5 Pro]
                J --> K[MD报告生成]
                K --> L[返回结果/存储]
                
                style A fill:#1e293b,stroke:#3b82f6,stroke-width:2px
                style B fill:#1e293b,stroke:#10b981,stroke-width:2px
                style F fill:#1e293b,stroke:#ec4899,stroke-width:2px
                style G fill:#1e293b,stroke:#f59e0b,stroke-width:2px
                style I fill:#1e293b,stroke:#8b5cf6,stroke-width:2px
        </div>
    </section>

    <!-- Main Grid Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Column 1: Data Acquisition -->
        <div class="flex flex-col gap-6">
            <div class="section-title border-green-500 text-green-400">
                <i class="fas fa-database"></i> 第一阶段：数据获取
            </div>

            <!-- Ticker Logic -->
            <div class="glass-panel p-5 hover-card border-l-4 border-green-500">
                <h3 class="font-bold text-lg mb-2">1.1 代码标准化</h3>
                <div class="detail-list">
                    <li><strong>港股:</strong> 4-5位数字 → 去前导0 + .HK (例: 9988.HK)</li>
                    <li><strong>A股沪:</strong> 600/601/688开头 → + .SS (例: 600519.SS)</li>
                    <li><strong>A股深:</strong> 000/002/300开头 → + .SZ</li>
                    <li><strong>美股:</strong> 默认不加后缀</li>
                </div>
            </div>

            <!-- Market Data -->
            <div class="glass-panel p-5 hover-card border-l-4 border-green-500">
                <h3 class="font-bold text-lg mb-2">1.2 & 1.3 市场与宏观数据</h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="bg-slate-800 p-2 rounded">
                        <span class="text-blue-300">个股数据</span>
                        <ul class="detail-list mt-1">
                            <li>价格/52周高低</li>
                            <li>PE/PEG/Forward PE</li>
                            <li>MA50/MA200/成交量</li>
                            <li><strong>财报日 (Next Earnings)</strong></li> 
                        </ul>
                        <!-- Alert Box for Earnings -->
                        <div class="mt-2 p-1.5 bg-yellow-900/30 border border-yellow-700/50 rounded text-xs text-yellow-200">
                            <i class="fas fa-bell"></i> <strong>财报日监测:</strong>
                            <br>距离 < 7天 = <span class="text-red-400 font-bold">高危警告</span>
                        </div>
                    </div>
                    <div class="bg-slate-800 p-2 rounded">
                        <span class="text-purple-300">宏观指标</span>
                        <ul class="detail-list mt-1">
                            <li>10年美债 (^TNX)</li>
                            <li>美元指数 (DXY)</li>
                            <li>黄金/原油</li>
                            <li>Fed决议/CPI数据</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Lock-up & IPO Logic -->
            <div class="glass-panel p-5 hover-card border-l-4 border-pink-500">
                <h3 class="font-bold text-lg mb-2 text-pink-400"><i class="fas fa-unlock-alt"></i> 1.X IPO与解禁监控</h3>
                <div class="text-sm space-y-3">
                    <div class="bg-slate-800 p-2 rounded border-l-2 border-blue-500">
                        <span class="text-blue-300 font-bold text-xs">美股 (US) / 港股 (HK)</span>
                        <ul class="detail-list mt-1 text-xs">
                            <li><strong>数据源:</strong> YFinance Profile (IPO Date)</li>
                            <li><strong>计算逻辑:</strong> <code>IPO Date + 180 Days</code></li>
                            <li><strong>港股:</strong> 默认基石投资者禁售期为6个月</li>
                        </ul>
                    </div>
                    
                    <div class="bg-slate-800 p-2 rounded border-l-2 border-yellow-500">
                        <span class="text-yellow-300 font-bold text-xs">A股 (China A)</span>
                        <ul class="detail-list mt-1 text-xs">
                            <li><strong>数据源:</strong> AkShare (<code>stock_restricted_release</code>)</li>
                            <li><strong>逻辑:</strong> 直接抓取精确解禁日期表</li>
                            <li><strong>规则:</strong> 大股东36个月 / 小股东12个月</li>
                        </ul>
                    </div>

                    <div class="logic-box border-pink-500">
                        <div class="flex justify-between items-center">
                            <span><i class="fas fa-exclamation-circle text-pink-400"></i> 解禁预警:</span>
                            <span class="text-pink-300 text-xs">距离 &lt; 14天</span>
                        </div>
                        <div class="text-[10px] text-slate-400 mt-1">后果: 触发"供给侧冲击"风险旗标，建议观望</div>
                    </div>
                </div>
            </div>

            <!-- Options & Risk Data -->
            <div class="glass-panel p-5 hover-card border-l-4 border-red-500">
                <h3 class="font-bold text-lg mb-2">1.4 期权与风险数据</h3>
                <div class="logic-box border-red-500">
                    <div class="flex justify-between"><span>VIX恐慌指数:</span> <span class="text-red-400">>30 高危</span></div>
                    <div class="flex justify-between"><span>Put/Call比率:</span> <span class="text-red-400">>1.2 极度看跌</span></div>
                    <div class="flex justify-between"><span>地缘政治:</span> <span class="text-red-400">0-10分评分</span></div>
                </div>
            </div>

            <!-- China Special -->
            <div class="glass-panel p-5 hover-card border-l-4 border-yellow-500 bg-yellow-900/10">
                <h3 class="font-bold text-lg mb-2 text-yellow-400"><i class="fas fa-star"></i> 1.5 中国特色数据 (A/HK)</h3>
                <p class="text-xs text-yellow-200 mb-2">规则: Policy is King (政策 > 一切)</p>
                <div class="detail-list">
                    <li><strong>主力资金流:</strong> 净流入/流出 (±1.5-2.0分)</li>
                    <li><strong>龙虎榜:</strong> 游资热度/买卖额 (±1.0-1.5分)</li>
                    <li><strong>政策风向:</strong> 央行/证监会/国务院 (±2.0分 权重Max)</li>
                    <li><strong>关键词:</strong> "印发"、"规划"、"立案调查"</li>
                </div>
            </div>
        </div>

        <!-- Column 2: Quantitative Analysis -->
        <div class="flex flex-col gap-6">
            <div class="section-title border-orange-500 text-orange-400">
                <i class="fas fa-calculator"></i> 第二阶段：量化分析
            </div>

            <!-- Risk Score -->
            <div class="glass-panel p-5 hover-card border-l-4 border-red-500">
                <h3 class="font-bold text-lg mb-2 flex justify-between">
                    2.1 风险评分模型
                    <span class="badge bg-red-600 text-white">0-10分</span>
                </h3>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="w-16 font-bold text-slate-400">基本面:</span>
                        <span class="text-xs text-slate-300">营收<0%(+3), 利润率<5%(+2), PEG>2.5(+1)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-16 font-bold text-slate-400">技术面:</span>
                        <span class="text-xs text-slate-300">价<MA200(+1), 追高>80%(+1)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-16 font-bold text-slate-400">情绪面:</span>
                        <span class="text-xs text-slate-300">VIX>30(+2), P/C>1.5(+2)</span>
                    </div>
                    <div class="logic-box border-red-500 mt-2">
                        <div>Risk >= 6: <span class="text-red-400">熔断 (仓位0%)</span></div>
                        <div>Risk >= 8: <span class="text-red-500">强烈禁止</span></div>
                    </div>
                </div>
            </div>

            <!-- Style Weighted Logic -->
            <div class="glass-panel p-5 hover-card border-l-4 border-cyan-500">
                <h3 class="font-bold text-lg mb-2 text-cyan-400">
                    <i class="fas fa-balance-scale"></i> 2.X 风格权重动态调整
                </h3>
                <p class="text-xs text-slate-400 mb-3">系统根据所选风格，自动调整评分指标的权重占比：</p>
                <div class="space-y-4 text-xs">
                    <!-- Quality -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="font-bold text-slate-200">Quality (质量)</span>
                            <span class="text-slate-500">核心: 利润率/债务/护城河</span>
                        </div>
                        <div class="flex h-2.5 bg-slate-800 rounded overflow-hidden">
                            <div class="bg-blue-500" style="width: 50%" title="基本面 50%"></div>
                            <div class="bg-green-500" style="width: 30%" title="估值 30%"></div>
                            <div class="bg-purple-500" style="width: 20%" title="动量 20%"></div>
                        </div>
                        <div class="flex justify-between text-[10px] text-slate-500 mt-0.5 px-0.5">
                            <span class="text-blue-400">基本面 50%</span> <span class="text-green-400">估值 30%</span> <span class="text-purple-400">动量 20%</span>
                        </div>
                    </div>

                    <!-- Value -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="font-bold text-slate-200">Value (价值)</span>
                            <span class="text-slate-500">核心: 低估值/安全边际</span>
                        </div>
                        <div class="flex h-2.5 bg-slate-800 rounded overflow-hidden">
                            <div class="bg-green-500" style="width: 60%" title="估值 60%"></div>
                            <div class="bg-blue-500" style="width: 30%" title="基本面 30%"></div>
                            <div class="bg-purple-500" style="width: 10%" title="动量 10%"></div>
                        </div>
                    </div>

                    <!-- Growth -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="font-bold text-slate-200">Growth (成长)</span>
                            <span class="text-slate-500">核心: 营收增速/预期</span>
                        </div>
                        <div class="flex h-2.5 bg-slate-800 rounded overflow-hidden">
                            <div class="bg-blue-400" style="width: 50%" title="增长率 50%"></div>
                            <div class="bg-purple-500" style="width: 30%" title="趋势 30%"></div>
                            <div class="bg-green-500" style="width: 20%" title="估值 20%"></div>
                        </div>
                    </div>

                    <!-- Momentum -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="font-bold text-slate-200">Momentum (动量)</span>
                            <span class="text-slate-500">核心: 趋势/成交量/情绪</span>
                        </div>
                        <div class="flex h-2.5 bg-slate-800 rounded overflow-hidden">
                            <div class="bg-purple-500" style="width: 70%" title="动量/情绪 70%"></div>
                            <div class="bg-blue-500" style="width: 20%" title="基本面 20%"></div>
                            <div class="bg-green-500" style="width: 10%" title="估值 10%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sentiment & Position -->
            <div class="glass-panel p-5 hover-card border-l-4 border-blue-500">
                <h3 class="font-bold text-lg mb-2">2.2 & 2.3 仓位与情绪</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-sm font-bold text-blue-300 mb-1">风格仓位上限</h4>
                        <ul class="text-xs space-y-1">
                            <li class="flex justify-between"><span>Quality:</span> <span>20%</span></li>
                            <li class="flex justify-between"><span>Growth:</span> <span>15%</span></li>
                            <li class="flex justify-between"><span>Value:</span> <span>10%</span></li>
                            <li class="flex justify-between"><span>Momentum:</span> <span>5%</span></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-blue-300 mb-1">市场情绪 (0-10)</h4>
                        <p class="text-xs text-slate-400">
                            趋势(30%) + 估值(30%) + 期权(20%) + 宏观(20%)
                        </p>
                        <p class="text-xs text-yellow-400 mt-1">
                            *中国市场: 60%传统 + 40%特色
                        </p>
                    </div>
                </div>
            </div>

            <!-- Target Price -->
            <div class="glass-panel p-5 hover-card border-l-4 border-green-500">
                <h3 class="font-bold text-lg mb-2 flex justify-between items-center">
                    2.4 目标价计算
                    <span class="badge bg-green-900 text-green-300 border border-green-500">周期: 6-12月</span>
                </h3>
                <div class="text-xs text-slate-400 mb-2 italic text-center">
                    (基于基本面回归的中期目标)
                </div>
                <div class="space-y-2">
                    <div class="flex items-center p-2 bg-slate-800 rounded border border-green-900">
                        <div class="w-6 h-6 rounded-full bg-green-600 text-center text-xs leading-6 mr-2">1</div>
                        <div class="text-sm">
                            <div class="font-bold">PEG 估值法 (首选)</div>
                            <div class="text-xs text-slate-400">Target = Price * (1+Growth) / PEG</div>
                        </div>
                    </div>
                    <div class="flex items-center p-2 bg-slate-800 rounded border border-slate-700 opacity-80">
                        <div class="w-6 h-6 rounded-full bg-slate-600 text-center text-xs leading-6 mr-2">2</div>
                        <div class="text-sm">
                            <div class="font-bold">增长率折现 (备用)</div>
                            <div class="text-xs text-slate-400">折现因子 0.6</div>
                        </div>
                    </div>
                    <div class="flex items-center p-2 bg-slate-800 rounded border border-slate-700 opacity-60">
                        <div class="w-6 h-6 rounded-full bg-slate-600 text-center text-xs leading-6 mr-2">3</div>
                        <div class="text-sm">
                            <div class="font-bold">技术面 (保底)</div>
                            <div class="text-xs text-slate-400">52周高点 * 0.9</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stop Loss -->
            <div class="glass-panel p-5 hover-card border-l-4 border-purple-500">
                <h3 class="font-bold text-lg mb-2">2.5 动态止损 (ATR) & EV</h3>
                <div class="logic-box border-purple-500">
                    <div>ATR止损: Price - (ATR * 2.5)</div>
                    <div>Beta调整: Beta>1.5 则 ATR*3.0</div>
                    <div>最小幅度: 至少 5%</div>
                    <div>降级方案: 固定 15%</div>
                </div>
                <div class="mt-2 text-xs text-slate-400">
                    <strong>EV模型:</strong> 计算1周-3个月的上涨/下跌概率分布
                </div>
            </div>
        </div>

        <!-- Column 3: AI Generation & Report -->
        <div class="flex flex-col gap-6">
            <div class="section-title border-purple-500 text-purple-400">
                <i class="fas fa-robot"></i> 第三阶段：AI 报告生成
            </div>

            <!-- Prompt Logic -->
            <div class="glass-panel p-5 hover-card border-l-4 border-purple-500">
                <h3 class="font-bold text-lg mb-2">3.2 Prompt 构建逻辑</h3>
                <div class="detail-list">
                    <li><strong>角色:</strong> AlphaGBM 基金经理</li>
                    <li><strong>输入上下文:</strong> 完整量化数据 + 宏观 + 风险Flag</li>
                    <li><strong>特殊分支:</strong>
                        <ul class="pl-4 mt-1 border-l border-slate-600">
                            <li><span class="text-yellow-400">ETF:</span> 忽略PE/营收，重流动性/跟踪误差</li>
                            <li><span class="text-red-400">中国:</span> 注入"Policy is King"指令，关键词检测</li>
                        </ul>
                    </li>
                </div>
            </div>

            <!-- Report Structure (The Core Output) -->
            <div class="glass-panel p-5 hover-card border-l-4 border-indigo-500 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-2 opacity-10">
                    <i class="fas fa-file-alt text-6xl"></i>
                </div>
                <h3 class="font-bold text-lg mb-3">3.3 七大报告板块 (强制结构)</h3>
                
                <div class="space-y-3 text-sm">
                    <div class="p-2 bg-slate-800/50 rounded">
                        <span class="text-indigo-400 font-bold">1. 风格重申</span>
                        <p class="text-xs text-slate-400">确认当前风格与原则</p>
                    </div>
                    <div class="p-2 bg-slate-800/50 rounded">
                        <span class="text-indigo-400 font-bold">2. 公司概况</span>
                        <p class="text-xs text-slate-400">业务简介 + 3-5条最新新闻</p>
                    </div>
                    <div class="p-2 bg-slate-800/50 rounded">
                        <span class="text-indigo-400 font-bold">3. AlphaGBM 解构</span>
                        <p class="text-xs text-slate-400">G(价格差) = B(基本面) + M(动量/情绪)</p>
                    </div>
                    <div class="p-2 bg-slate-800/50 rounded">
                        <span class="text-indigo-400 font-bold">4. 五大支柱检查</span>
                        <p class="text-xs text-slate-400">怀疑主义(空头理由) + 事前验尸</p>
                    </div>
                    <div class="p-2 bg-slate-800/50 rounded border border-red-900/50">
                        <span class="text-red-400 font-bold">4.5 风险控制 (必填)</span>
                        <p class="text-xs text-slate-400">系统评分 + 主要风险点 + 短期EV概率</p>
                    </div>
                    <div class="p-2 bg-slate-800/50 rounded">
                        <span class="text-indigo-400 font-bold">5. 估值与交易</span>
                        <p class="text-xs text-slate-400">
                            如果 Price >= Target: <span class="text-red-400">禁止建议买入</span>
                        </p>
                    </div>
                    <div class="p-2 bg-red-900/20 rounded border border-red-500">
                        <span class="text-red-400 font-bold"><i class="fas fa-exclamation-triangle"></i> 6. 卖出策略 (核心)</span>
                        <div class="text-xs text-slate-300 mt-1">
                            <ul class="list-disc pl-3">
                                <li>具体的止盈点位 (分批/一次性)</li>
                                <li>严格的止损纪律 (ATR/固定)</li>
                                <li><span class="text-yellow-400">财报避险:</span> 财报前<7天不建议重仓/开仓</li>
                                <li><span class="text-pink-400">解禁避险:</span> 解禁前<14天建议观望</li>
                                <li><b>必须具体、可执行、不论情面</b></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fallback -->
            <div class="glass-panel p-5 hover-card border-l-4 border-gray-500">
                <h3 class="font-bold text-lg mb-2">异常处理与降级</h3>
                <div class="text-xs text-slate-400 space-y-1">
                    <p><i class="fas fa-shield-alt text-green-400"></i> <b>数据源:</b> YFinance失败 -> Alpha Vantage</p>
                    <p><i class="fas fa-shield-alt text-blue-400"></i> <b>AI服务:</b> Gemini API失败 -> 备用模板(仅量化数据)</p>
                    <p><i class="fas fa-shield-alt text-red-400"></i> <b>限流:</b> 普通用户 5次/日 -> 返回429</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer Legend -->
    <footer class="mt-8 text-center text-xs text-slate-500 border-t border-slate-800 pt-4">
        <div class="flex justify-center gap-4 mb-2">
            <span class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span> 正常/数据</span>
            <span class="flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-full mr-1"></span> 逻辑/计算</span>
            <span class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span> 风险/警告</span>
            <span class="flex items-center"><span class="w-3 h-3 bg-purple-500 rounded-full mr-1"></span> AI/生成</span>
            <span class="flex items-center"><span class="w-3 h-3 bg-pink-500 rounded-full mr-1"></span> 解禁/Lock-up</span>
            <span class="flex items-center"><span class="w-3 h-3 bg-yellow-500 rounded-full mr-1"></span> 特殊/中国市场</span>
        </div>
        AlphaGBM System Logic Visualization v1.1
    </footer>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            securityLevel: 'loose',
            flowchart: {
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
