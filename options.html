<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha GBM - 期权分析</title>
    <!-- Lightweight Charts for candlestick chart (使用4.x版本以确保API兼容性) -->
    <script src="https://unpkg.com/lightweight-charts@4.1.2/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        /**
         * AlphaGBM 设计系统
         * 金融终端深色主题
         */

        /* ==================== 颜色系统 ==================== */

        :root {
          /* 背景色 - 使用十六进制精确匹配 */
          --background: #09090B;                    /* 深色背景 */
          --background-secondary: #0F0F11;         /* 次要背景 */
          --foreground: #FAFAFA;                    /* 白色文本 */
          
          /* 卡片 */
          --card: #18181B;                          /* 卡片背景 */
          --card-hover: #1F1F23;                    /* 卡片悬停 */
          --card-foreground: #FAFAFA;               /* 卡片文本 */
          
          /* 主色调（品牌色 - 青色）*/
          --primary: #0D9B97;                       /* 品牌青色 */
          --primary-rgb: 13, 155, 151;              /* RGB 值 */
          --primary-foreground: #FAFAFA;            /* 主色上的文字 */
          
          /* 次要色 */
          --secondary: #27272A;                     /* 次要按钮 */
          --secondary-foreground: #FAFAFA;
          
          /* 静音色 */
          --muted: #27272A;                         /* 不活跃状态 */
          --muted-foreground: #9CA3AF;              /* 静音文本 */
          
          /* 强调色（使用品牌色）*/
          --accent: #0D9B97;                        /* 悬停、焦点 */
          --accent-foreground: #FAFAFA;
          
          /* 边框 */
          --border: #27272A;                        /* 边框颜色 */
          --border-hover: #0D9B97;                  /* 边框悬停使用品牌色 */
          --input: #27272A;                         /* 输入框背景 */
          --ring: #0D9B97;                          /* 焦点环使用品牌色 */
          
          /* 金融专用色（中国市场习惯：红跌绿涨）*/
          --bull: #10B981;                          /* 上涨/看涨 */
          --bear: #EF4444;                          /* 下跌/看跌 */
          --neutral: #6B7280;                       /* 中性 */
          
          /* 语义化颜色 */
          --success: hsl(142, 76%, 36%);            /* 成功 */
          --error: hsl(0, 72%, 51%);                /* 错误 */
          --warning: hsl(38, 92%, 50%);             /* #F59E0B - 警告 */
          --info: hsl(178, 78%, 32%);               /* #0D9B97 - 信息（使用品牌色）*/
          
          /* 数据可视化 */
          --chart-1: hsl(142, 76%, 36%);            /* 绿色 */
          --chart-2: hsl(0, 72%, 51%);              /* 红色 */
          --chart-3: hsl(178, 78%, 32%);            /* 青色（品牌色）*/
          --chart-4: hsl(280, 65%, 60%);            /* 紫色 */
          --chart-5: hsl(43, 74%, 66%);             /* 黄色 */
          
          /* 阴影 */
          --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
          --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
          --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
          --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
          --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ==================== 基础样式 ==================== */

        body {
            background-color: var(--background) !important;
            color: var(--foreground) !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
            padding: 1rem;
        }

        /* ==================== 容器 ==================== */

        .container {
            max-width: 1440px;
            width: 100%;
            margin: 0 auto;
            background: var(--background);
            overflow: visible;
        }

        .container-main {
            max-width: 1440px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* ==================== 卡片组件 ==================== */

        .card {
            background-color: var(--card) !important;
            border: 1px solid var(--border) !important;
            border-radius: 0.75rem !important; /* 12px */
            color: var(--card-foreground) !important;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            background-color: var(--card-hover) !important;
            border-color: var(--border-hover) !important;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .header {
            background-color: var(--card) !important;
            border: 1px solid var(--border) !important;
            border-radius: 0.75rem 0.75rem 0 0 !important;
            color: var(--foreground) !important;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--foreground) !important;
        }

        .header p {
            font-size: 1rem;
            color: var(--muted-foreground) !important;
        }

        .controls {
            padding: 1.5rem;
            background-color: var(--card) !important;
            border: 1px solid var(--border) !important;
            border-radius: 0.75rem !important;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            gap: 1rem;
            align-items: end;
            flex-wrap: wrap;
        }

        .form-field {
            flex: 1;
            min-width: 200px;
        }

        .form-label {
            color: var(--foreground);
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-field label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--foreground);
        }

        .form-control,
        .form-select,
        .form-field input,
        .form-field select {
            background-color: var(--input) !important;
            border: 1px solid var(--border) !important;
            border-radius: 0.5rem !important;
            color: var(--foreground) !important;
            padding: 0.5rem 0.75rem;
            width: 100%;
            font-size: 14px;
            transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .form-control:focus,
        .form-select:focus,
        .form-field input:focus,
        .form-field select:focus {
            background-color: var(--input) !important;
            border-color: var(--ring) !important;
            box-shadow: 0 0 0 2px rgba(13, 155, 151, 0.2) !important;
            color: var(--foreground) !important;
            outline: none;
        }

        .form-control::placeholder,
        .form-field input::placeholder {
            color: var(--muted-foreground);
        }

        /* ==================== 按钮组件 ==================== */

        .btn {
            border-radius: 0.5rem !important; /* 8px */
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
            font-size: 14px;
            min-height: 40px;
        }

        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--ring);
        }

        .btn-primary {
            background-color: var(--primary) !important;
            color: white !important;
            border: none !important;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: hsl(178, 78%, 40%) !important;  /* 稍亮的青色 */
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(13, 155, 151, 0.3);
        }

        .btn-secondary {
            background-color: var(--secondary) !important;
            color: var(--secondary-foreground) !important;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #3F3F46 !important;
        }

        .btn-outline {
            background-color: transparent !important;
            border: 1px solid var(--border) !important;
            color: var(--foreground) !important;
        }

        .btn-outline:hover:not(:disabled) {
            background-color: var(--accent) !important;
            border-color: var(--border-hover) !important;
        }

        .btn-ghost {
            background-color: transparent !important;
            color: var(--foreground) !important;
        }

        .btn-ghost:hover:not(:disabled) {
            background-color: var(--accent) !important;
        }

        .btn:disabled {
            background-color: var(--muted) !important;
            color: var(--muted-foreground) !important;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: var(--muted-foreground);
        }

        .loading .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--muted);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            padding: 1.5rem;
            display: none;
            background-color: var(--card) !important;
            border: 1px solid var(--border) !important;
            border-radius: 0.75rem !important;
        }

        .results-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border) !important;
        }

        .results-header h2 {
            color: var(--foreground) !important;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .results-meta {
            color: var(--muted-foreground) !important;
            font-size: 0.875rem;
        }

        .option-tables {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .option-section {
            background-color: var(--card) !important;
            border: 1px solid var(--border) !important;
            border-radius: 0.75rem !important;
            padding: 1.5rem;
            width: 100%;
            min-width: 0;
        }

        .table-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            position: relative;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            flex: 1;
            scroll-behavior: smooth;
        }

        .table-scroll-controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            position: sticky;
            top: 1rem;
            z-index: 20;
            align-self: flex-start;
        }

        .scroll-btn-vertical {
            width: 40px;
            height: 40px;
            border: none;
            background-color: var(--primary) !important;
            color: white !important;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 16px;
            transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scroll-btn-vertical:hover:not(:disabled) {
            background-color: hsl(178, 78%, 40%) !important;
            transform: scale(1.05);
        }

        .scroll-btn-vertical:disabled {
            background-color: var(--muted) !important;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .scroll-indicator-vertical {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            background-color: var(--muted);
            padding: 0.5rem 0.25rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            color: var(--muted-foreground);
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ==================== 滚动条 ==================== */

        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background-color: var(--background);
        }

        .table-container::-webkit-scrollbar-thumb {
            background-color: var(--muted);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background-color: var(--muted-foreground);
        }

        .option-section h3 {
            color: var(--foreground) !important;
            margin-bottom: 1rem;
            text-align: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
        }

        .calls h3 {
            background-color: var(--bull) !important;
            color: white !important;
        }

        .puts h3 {
            background-color: var(--bear) !important;
            color: white !important;
        }

        /* ==================== 表格 ==================== */

        .option-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background-color: var(--card) !important;
            border-radius: 0.5rem;
            overflow: hidden;
            min-width: 1100px;
            position: relative;
            color: var(--foreground) !important;
            border-color: var(--border) !important;
        }

        /* Sticky/frozen columns for key data */
        .option-table .sticky-col {
            position: sticky;
            background-color: var(--card) !important;
            z-index: 10;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .option-table th.sticky-col {
            background-color: var(--muted) !important;
        }

        .option-table .sticky-col-1 { left: 0; z-index: 15; min-width: 90px; }
        .option-table .sticky-col-2 { left: 90px; z-index: 14; min-width: 100px; }
        .option-table .sticky-col-3 { left: 190px; z-index: 13; min-width: 90px; }
        .option-table .sticky-col-4 { left: 280px; z-index: 12; min-width: 100px; }

        /* Current stock price indicator */
        .stock-price-indicator {
            display: inline-block;
            background-color: var(--primary) !important;
            color: white !important;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            margin-left: 0.5rem;
            font-size: 0.875rem;
        }

        .option-table th {
            background-color: var(--muted) !important;
            color: var(--foreground) !important;
            padding: 0.75rem 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            text-align: center;
            border-color: var(--border) !important;
        }

        .option-table td {
            padding: 0.75rem 0.5rem;
            text-align: center;
            border-bottom: 1px solid var(--border) !important;
            font-size: 0.875rem;
            color: var(--foreground) !important;
        }

        .option-table tbody tr {
            transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .option-table tbody tr:hover {
            background-color: var(--accent) !important;
            transform: scale(1.01);
        }

        .option-table tbody tr[style*="cursor: pointer"]:hover::after {
            content: '点击查看风险分析';
            position: absolute;
            right: 1rem;
            background-color: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            z-index: 100;
        }

        .strike {
            font-weight: 600;
            color: var(--foreground) !important;
        }

        .price {
            font-weight: 600;
            color: var(--bull) !important;
        }

        .market-data {
            font-weight: 500;
            color: var(--foreground) !important;
        }

        .greeks {
            color: var(--muted-foreground) !important;
            font-size: 0.8rem;
        }

        .score {
            font-weight: 600;
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            text-align: center;
        }

        .score-high {
            background-color: var(--bull) !important;
            color: white !important;
        }

        .score-medium {
            background-color: var(--warning) !important;
            color: white !important;
        }

        .score-low {
            background-color: var(--bear) !important;
            color: white !important;
        }

        /* 特别推荐高亮样式 */
        .recommended-row {
            background-color: rgba(13, 155, 151, 0.15) !important;
            border-left: 3px solid var(--primary) !important;
        }

        .recommended-row:hover {
            background-color: rgba(13, 155, 151, 0.25) !important;
        }

        .recommended-score {
            background-color: var(--primary) !important;
            color: white !important;
            font-weight: 700 !important;
            font-size: 1.05em !important;
            box-shadow: 0 0 8px rgba(13, 155, 151, 0.5) !important;
        }

        .score-header {
            background-color: var(--primary) !important;
            color: white !important;
        }

        /* ==================== 表格排序功能 ==================== */
        .option-table th {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 1.5rem !important;
        }

        .option-table th:hover {
            background-color: rgba(13, 155, 151, 0.1) !important;
        }

        .sort-icon {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .option-table th:hover .sort-icon {
            opacity: 1;
        }

        .sort-icon.active {
            opacity: 1;
            color: var(--primary);
        }

        .sort-icon.asc::after {
            content: '▲';
        }

        .sort-icon.desc::after {
            content: '▼';
        }

        .sort-icon.none::after {
            content: '⇅';
        }

        .table-controls {
            display: flex;
            justify-content: center; /* 居中显示控件 */
            align-items: center;
            margin-bottom: 10px;
            width: 100%;
        }

        .scroll-btn {
            background-color: var(--primary) !important;
            color: white !important;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            box-shadow: var(--shadow-md);
            transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
        }

        .scroll-btn:hover:not(:disabled) {
            background-color: hsl(178, 78%, 40%) !important;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .scroll-btn:disabled {
            background-color: var(--muted) !important;
            cursor: not-allowed;
            transform: none;
            opacity: 0.5;
        }

        .scroll-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem;
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 1.5rem;
            box-shadow: var(--shadow);
        }

        .scroll-indicator {
            font-size: 0.875rem;
            color: var(--foreground);
            white-space: nowrap;
            font-weight: 500;
            min-width: 120px;
            text-align: center;
        }

        .error {
            display: none;
            background-color: var(--error) !important;
            border: 1px solid var(--error);
            color: white !important;
            padding: 1.25rem;
            border-radius: 0.5rem;
            margin: 1.25rem 1.5rem;
        }

        /* ==================== 徽章 (Badges) ==================== */

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .badge-primary {
            background-color: var(--primary) !important;
            color: white !important;
        }

        .badge-secondary {
            background-color: var(--secondary) !important;
            color: var(--secondary-foreground) !important;
        }

        .badge-bull {
            background-color: var(--bull) !important;
            color: white !important;
        }

        .badge-bear {
            background-color: var(--bear) !important;
            color: white !important;
        }

        .badge-neutral {
            background-color: var(--muted) !important;
            color: var(--muted-foreground) !important;
        }

        /* ==================== 导航栏 ==================== */

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(9, 9, 11, 0.8) !important;
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(39, 39, 42, 0.8);
            z-index: 1000;
            padding: 0;
        }

        .navbar-content {
            max-width: 1280px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 4rem;
            padding: 0 1rem;
        }

        .navbar-nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .navbar-brand {
            color: var(--foreground) !important;
            font-weight: 700;
            font-size: 1.25rem;
            text-decoration: none;
            letter-spacing: -0.025em;
        }

        .navbar-brand .brand-highlight {
            color: #0D9B97;
        }

        .nav-link {
            color: var(--muted-foreground) !important;
            text-decoration: none;
            font-size: 0.875rem;
            padding: 0.5rem 0;
            border-bottom: 2px solid transparent;
            transition: color 150ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-link:hover:not(.disabled) {
            color: #0D9B97 !important;
        }

        .nav-link.active {
            color: #0D9B97 !important;
            border-bottom-color: #0D9B97;
        }

        .nav-link.disabled {
            color: var(--muted-foreground) !important;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .navbar-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .lang-btn-compact {
            padding: 0.25rem 0.75rem;
            border: 1px solid rgba(51, 65, 85, 0.8);
            background-color: transparent;
            color: var(--foreground);
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-family: 'Courier New', monospace;
            min-width: 40px;
            transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .lang-btn-compact:hover {
            background-color: rgba(51, 65, 85, 0.3);
            border-color: rgba(51, 65, 85, 0.6);
        }

        /* ==================== 模态框 ==================== */

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(9, 9, 11, 0.8);
            backdrop-filter: blur(12px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(9, 9, 11, 0.95) !important;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(39, 39, 42, 0.8) !important;
            border-radius: 0.75rem !important;
            color: var(--foreground) !important;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }

        .modal-large {
            max-width: 1200px !important;
            max-height: 65vh !important;
            overflow-y: visible !important;
        }

        .modal-header {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(39, 39, 42, 0.8) !important;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            color: var(--foreground) !important;
            font-weight: 600;
            font-size: 1rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--muted-foreground);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-close:hover {
            background-color: var(--muted);
            color: var(--foreground);
        }

        .modal-body {
            padding: 0.75rem;
            overflow-y: visible !important;
        }

        .modal-footer {
            padding: 0.75rem;
            border-top: 1px solid rgba(39, 39, 42, 0.8) !important;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* ==================== 事前验尸仪表盘 ==================== */

        .premortem-content {
            padding: 0.5rem 0;
        }

        .premortem-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            background-color: var(--muted);
            border-radius: 0.4rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--muted-foreground);
            margin-bottom: 0.3rem;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--foreground);
        }

        .premortem-warning {
            background-color: rgba(245, 158, 11, 0.1) !important;
            border-left: 4px solid var(--warning) !important;
        }

        /* ==================== 期权详情弹窗 ==================== */

        .option-detail-content {
            padding: 0.25rem 0;
        }

        .risk-confirmation-section {
            margin-top: 1.5rem !important;
        }

        .option-info-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.4rem;
            margin-bottom: 0.5rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            padding: 0.4rem;
            background-color: var(--muted);
            border-radius: 0.4rem;
        }

        .info-label {
            font-size: 0.7rem;
            color: var(--muted-foreground);
            margin-bottom: 0.2rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .info-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--foreground);
        }

        .chart-container {
            width: 100%;
            height: 200px;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: var(--background);
            border-radius: 0.4rem;
            padding: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .chart-container > div {
            width: 100% !important;
            height: 100% !important;
        }

        @media (max-width: 768px) {
            .option-info-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-large {
                max-width: 95% !important;
            }

            .chart-container {
                height: 300px;
            }
        }

        /* 为导航栏添加 body padding */
        body.has-navbar {
            padding-top: 60px;
        }

        /* ==================== 高级选项面板 ==================== */

        .advanced-options {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .advanced-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .advanced-header h4 {
            color: var(--foreground);
            font-weight: 600;
            font-size: 1rem;
            margin: 0;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            min-height: 32px;
        }

        /* ==================== 风险提示 ==================== */

        .risk-warning {
            background-color: rgba(245, 158, 11, 0.15) !important;
            border: 1px solid var(--warning) !important;
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            border-left: 4px solid var(--warning);
        }

        .risk-warning strong {
            color: var(--warning);
            font-weight: 600;
        }

        .risk-warning p {
            color: var(--foreground);
            opacity: 0.9;
            line-height: 1.5;
        }

        /* 警告图标 - 线条三角形 */
        .warning-icon-line {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 14px solid var(--warning);
            position: relative;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .warning-icon-line::after {
            content: '';
            position: absolute;
            left: -6px;
            top: 10px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 8px solid var(--background);
        }

        /* 箭头线条样式 */
        .arrow-line {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid currentColor;
            border-top: none;
            border-right: none;
        }

        .arrow-left {
            transform: rotate(45deg);
            margin-left: 2px;
        }

        .arrow-right {
            transform: rotate(-135deg);
            margin-right: 2px;
        }

        /* ==================== 响应式调整 ==================== */

        @media (max-width: 1024px) {
            .option-tables {
                grid-template-columns: 1fr;
            }

            .container {
                max-width: 98vw;
                margin: 0 1vw;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0.75rem;
            }

            .form-group {
                flex-direction: column;
            }

            .form-field {
                min-width: 100%;
            }

            .header {
                padding: 1.5rem !important;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .controls {
                padding: 1rem !important;
            }

            .results {
                padding: 1rem !important;
            }

            .option-table {
                min-width: 1000px;
            }

            .option-table th, .option-table td {
                padding: 0.5rem 0.25rem;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .table-container {
                margin: 0;
            }

            .option-section {
                padding: 1rem !important;
            }

            .scroll-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .scroll-controls {
                gap: 0.5rem;
                padding: 0.5rem;
            }

            .scroll-indicator {
                font-size: 0.75rem;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-nav">
                <a href="#" class="navbar-brand">Alpha<span class="brand-highlight">GBM</span></a>
                <a href="#" class="nav-link" data-i18n="nav.stockAnalysis">股票分析</a>
                <a href="#" class="nav-link active" data-i18n="nav.optionResearch">期权研究</a>
                <a href="#" class="nav-link disabled" data-i18n="nav.agent">智能体（敬请期待）</a>
                <a href="#" class="nav-link disabled" data-i18n="nav.researchNotes">研究笔记（敬请期待）</a>
            </div>
            <div class="navbar-actions">
                <button class="lang-btn-compact" onclick="toggleLanguage()" id="langToggleBtn">EN</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1 data-i18n="header.title">Alpha GBM 期权工具</h1>
            <p data-i18n="header.subtitle">期权不是赌博，是给投资上安全锁或加速器。基于 G=B+M 理念，将期权作为实现投资目标的高级工具。</p>
        </div>

        <div class="controls card">
            <div class="form-group">
                <div class="form-field">
                    <label for="symbol" data-i18n="form.symbol">股票代码</label>
                    <input type="text" id="symbol" data-i18n-placeholder="form.symbolPlaceholder" placeholder="输入代码 (例如: AAPL)" value="AAPL">
                </div>
                <div class="form-field">
                    <label for="expiry" data-i18n="form.expiry">到期日期</label>
                    <select id="expiry">
                        <option value="" data-i18n="form.selectExpiry">选择到期日期...</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="tradeType" data-i18n="form.tradeType">交易类型</label>
                    <select id="tradeType">
                        <option value="all" data-i18n="form.tradeType.all">全部</option>
                        <option value="sell_put" data-i18n="form.tradeType.sellPut">卖出看跌 (Sell Put) - Value风格：现金担保看跌</option>
                        <option value="sell_call" data-i18n="form.tradeType.sellCall">卖出看涨 (Sell Call) - Quality风格：备兑看涨</option>
                        <option value="buy_call" data-i18n="form.tradeType.buyCall">买入看涨 (Buy Call) - Growth/Momentum风格：看涨价差</option>
                        <option value="buy_put" data-i18n="form.tradeType.buyPut">买入看跌 (Buy Put)</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="loadOptionChain()" disabled id="queryBtn" data-i18n="button.queryOptions">查询期权</button>
            </div>
            
            <!-- 高级选项面板 -->
            <div class="advanced-options" id="advancedOptions" style="display: none;">
                <div class="advanced-header">
                    <h4 data-i18n="form.advanced.title">高级筛选选项</h4>
                    <button class="btn btn-ghost btn-sm" onclick="toggleAdvancedOptions()" data-i18n="form.advanced.collapse">收起</button>
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <div class="form-field">
                        <label for="minAnnualReturn" data-i18n="form.advanced.minAnnualReturn">最低年化收益 (%)</label>
                        <input type="number" id="minAnnualReturn" min="0" max="100" step="0.1" placeholder="0">
                    </div>
                    <div class="form-field">
                        <label for="maxAnnualReturn" data-i18n="form.advanced.maxAnnualReturn">最高年化收益 (%)</label>
                        <input type="number" id="maxAnnualReturn" min="0" max="100" step="0.1" placeholder="100">
                    </div>
                    <div class="form-field">
                        <label for="minPremium" data-i18n="form.advanced.minPremium">最低权利金 ($)</label>
                        <input type="number" id="minPremium" min="0" step="0.01" placeholder="0">
                    </div>
                    <div class="form-field">
                        <label for="maxPremium" data-i18n="form.advanced.maxPremium">最高权利金 ($)</label>
                        <input type="number" id="maxPremium" min="0" step="0.01" placeholder="10000">
                    </div>
                    <div class="form-field">
                        <label for="maxBidAskSpread" data-i18n="form.advanced.maxSpread">最大买卖价差 ($)</label>
                        <input type="number" id="maxBidAskSpread" min="0" step="0.01" placeholder="1.00">
                    </div>
                    <div class="form-field" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-secondary" onclick="clearAdvancedFilters()" data-i18n="form.advanced.clear">清除筛选</button>
                    </div>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 0.5rem;">
                <button class="btn btn-primary btn-sm" onclick="toggleAdvancedOptions()" id="toggleAdvancedBtn" data-i18n="form.advanced.expand">展开高级选项</button>
            </div>
        </div>

        <!-- 投资风险提示 -->
        <div class="risk-warning card" style="margin-bottom: 1rem; background-color: var(--warning); border-color: var(--warning);">
            <div style="display: flex; align-items: start; gap: 0.75rem;">
                <div class="warning-icon-line"></div>
                <div>
                    <strong data-i18n="risk.title" style="display: block; margin-bottom: 0.25rem;">投资风险提示</strong>
                    <p data-i18n="risk.message" style="margin: 0; font-size: 0.875rem; opacity: 0.9;">所有数据分析由AI生成，不构成投资建议。投资有风险，入市需谨慎。</p>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p data-i18n="loading.text">正在加载期权数据...</p>
        </div>

        <div class="error" id="error"></div>

        <!-- 期权详情和风险确认弹窗 -->
        <div class="modal" id="optionDetailModal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3 class="modal-title" data-i18n="modal.riskConfirm">风险确认</h3>
                    <button class="modal-close" onclick="closeOptionDetailModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="option-detail-content">
                        <!-- 期权基本信息 -->
                        <div class="option-info-grid">
                            <div class="info-item">
                                <span class="info-label" data-i18n="detail.strike">行权价</span>
                                <span class="info-value" id="detailStrike">$0.00</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label" data-i18n="detail.annualReturn">年化收益</span>
                                <span class="info-value" id="detailAnnualReturn">0%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label" data-i18n="detail.assignProb">行权概率</span>
                                <span class="info-value" id="detailAssignProb">0%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label" data-i18n="detail.premium">权利金</span>
                                <span class="info-value" id="detailPremium">$0.00</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label" data-i18n="detail.latestPrice">最新价</span>
                                <span class="info-value" id="detailLatestPrice">$0.00</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label" data-i18n="detail.stopLoss">止损价</span>
                                <span class="info-value" id="detailStopLoss">$0.00</span>
                            </div>
                        </div>
                        
                        <!-- VRP分析区域 -->
                        <div class="vrp-analysis-section" id="vrpAnalysisSection" style="display: none; margin-bottom: 0.75rem; padding: 0.75rem; background-color: rgba(13, 155, 151, 0.1); border-left: 4px solid var(--primary); border-radius: 0.5rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--primary); font-size: 0.875rem; font-weight: 600;">波动率风险溢价 (VRP) 分析</h4>
                            <div class="vrp-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
                                <div class="vrp-stat-item">
                                    <span class="stat-label" style="font-size: 0.7rem; color: var(--muted-foreground);">VRP值</span>
                                    <span class="stat-value" id="detailVRP" style="font-size: 1rem; font-weight: 600; color: var(--foreground);">-</span>
                                </div>
                                <div class="vrp-stat-item">
                                    <span class="stat-label" style="font-size: 0.7rem; color: var(--muted-foreground);">IV Rank</span>
                                    <span class="stat-value" id="detailIVRank" style="font-size: 1rem; font-weight: 600; color: var(--foreground);">-</span>
                                </div>
                                <div class="vrp-stat-item">
                                    <span class="stat-label" style="font-size: 0.7rem; color: var(--muted-foreground);">推荐</span>
                                    <span class="stat-value" id="detailVRPRecommendation" style="font-size: 1rem; font-weight: 600; color: var(--foreground);">-</span>
                                </div>
                            </div>
                            <div style="margin-top: 0.75rem; font-size: 0.875rem; color: var(--muted-foreground);">
                                <span>隐含波动率: <span id="detailIV">-</span></span>
                                <span style="margin-left: 1rem;">预测已实现波动率: <span id="detailRV">-</span></span>
                            </div>
                        </div>
                        
                        <!-- 风险分析区域 -->
                        <div class="risk-analysis-section" id="riskAnalysisSection" style="display: none; margin-bottom: 0.5rem; padding: 0.5rem; background-color: rgba(245, 158, 11, 0.1); border-left: 4px solid var(--warning); border-radius: 0.4rem;">
                            <h4 style="margin: 0 0 0.4rem 0; color: var(--warning); font-size: 0.8rem; font-weight: 600;">风险调整分析</h4>
                            <div class="risk-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                                <div class="risk-stat-item">
                                    <span class="stat-label" style="font-size: 0.65rem; color: var(--muted-foreground);">期望值</span>
                                    <span class="stat-value" id="detailExpectedValue" style="font-size: 0.9rem; font-weight: 600; color: var(--foreground);">-</span>
                                </div>
                                <div class="risk-stat-item">
                                    <span class="stat-label" style="font-size: 0.65rem; color: var(--muted-foreground);">风险调整后期望值</span>
                                    <span class="stat-value" id="detailRAE" style="font-size: 0.9rem; font-weight: 600; color: var(--foreground);">-</span>
                                </div>
                                <div class="risk-stat-item">
                                    <span class="stat-label" style="font-size: 0.65rem; color: var(--muted-foreground);">风险等级</span>
                                    <span class="stat-value" id="detailRiskLevel" style="font-size: 0.9rem; font-weight: 600; color: var(--foreground);">-</span>
                                </div>
                            </div>
                            <div id="detailRiskWarning" style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--warning); display: none;"></div>
                        </div>
                        
                        <!-- K线图容器 -->
                        <div class="chart-container">
                            <div id="optionChart"></div>
                        </div>
                        
                        <!-- 风险确认信息 -->
                        <div class="risk-confirmation-section">
                            <div class="premortem-warning" style="padding: 0.5rem; background-color: rgba(245, 158, 11, 0.1); border-left: 4px solid var(--warning); border-radius: 0.4rem;">
                                <p data-i18n="risk.confirm" style="margin: 0; color: var(--foreground); font-size: 0.75rem;">
                                    你能接受这个风险吗？请确认你理解并接受最大损失。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeOptionDetailModal()" data-i18n="button.thinkAgain">我再想想</button>
                    <button class="btn btn-primary" onclick="confirmTrade()" data-i18n="button.confirm">我确认</button>
                </div>
            </div>
        </div>


        <div class="results card" id="results">
            <div class="results-header">
                <h2 id="resultsTitle" data-i18n="results.title">期权链</h2>
                <div class="results-meta" id="resultsMeta"></div>
            </div>

            <div class="option-tables">
                <div class="option-section calls card">
                    <h3><span id="callsTitle" data-i18n="table.calls.title">看涨期权 (备兑看涨策略)</span> <span class="stock-price-indicator" id="callsStockPrice"><span data-i18n="table.current">当前</span>: <span data-i18n="loading.text">加载中...</span></span></h3>
                    <div class="table-wrapper">
                        <div class="table-container" id="callsTableContainer">
                            <table class="option-table">
                                <thead>
                                    <tr>
                                        <th class="sticky-col sticky-col-1 sortable" data-sort="strike" data-i18n="table.strike">行权价<span class="sort-icon none"></span></th>
                                        <th class="sticky-col sticky-col-2 sortable" data-sort="lastPrice" data-i18n="table.lastPrice">最新价格<span class="sort-icon none"></span></th>
                                        <th class="sticky-col sticky-col-3 sortable" data-sort="priceDiff" data-i18n="table.priceDiff">价差<span class="sort-icon none"></span></th>
                                        <th class="sticky-col sticky-col-4 sortable" data-sort="assignProb" data-i18n="table.assignPercent">行权概率<span class="sort-icon none"></span></th>
                                        <th class="sortable" data-sort="annualReturn" data-i18n="table.annualPercent">年化收益<span class="sort-icon none"></span></th>
                                        <th class="sortable" data-sort="margin" data-i18n="table.margin">保证金<span class="sort-icon none"></span></th>
                                        <th class="sortable" data-sort="bid" data-i18n="table.bid">买价<span class="sort-icon none"></span></th>
                                        <th class="sortable" data-sort="ask" data-i18n="table.ask">卖价<span class="sort-icon none"></span></th>
                                        <th class="sortable" data-sort="liquidity" data-i18n="table.liq" data-i18n-title="liquidity.tooltip" title="流动性：0-100%，数值越高流动性越好">流动性<span class="sort-icon none"></span></th>
                                        <th class="score-header sortable" data-sort="recommendation" data-i18n="table.recommendation">推荐值<span class="sort-icon none"></span></th>
                                    </tr>
                                </thead>
                                <tbody id="callsTable">
                                </tbody>
                            </table>
                        </div>
                        <div class="table-scroll-controls">
                            <button class="scroll-btn-vertical" onclick="scrollTable('calls', -200)">
                                <span class="arrow-line arrow-left"></span>
                            </button>
                            <div class="scroll-indicator-vertical">Scroll</div>
                            <button class="scroll-btn-vertical" onclick="scrollTable('calls', 200)">
                                <span class="arrow-line arrow-right"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="option-section puts card">
                    <h3><span id="putsTitle" data-i18n="table.puts.title">看跌期权 (现金担保看跌策略)</span> <span class="stock-price-indicator" id="putsStockPrice"><span data-i18n="table.current">当前</span>: <span data-i18n="loading.text">加载中...</span></span></h3>
                    <div class="table-wrapper">
                        <div class="table-container" id="putsTableContainer">
                            <table class="option-table">
                                <thead>
                                    <tr>
                                        <th class="sticky-col sticky-col-1 sortable" data-sort="strike" data-i18n="table.strike">行权价<span class="sort-icon none"></span></th>
                                        <th class="sticky-col sticky-col-2 sortable" data-sort="lastPrice" data-i18n="table.lastPrice">最新价格<span class="sort-icon none"></span></th>
                                        <th class="sticky-col sticky-col-3 sortable" data-sort="priceDiff" data-i18n="table.priceDiff">价差<span class="sort-icon none"></span></th>
                                        <th class="sticky-col sticky-col-4 sortable" data-sort="assignProb" data-i18n="table.assignPercent">行权概率<span class="sort-icon none"></span></th>
                                        <th class="sortable" data-sort="annualReturn" data-i18n="table.annualPercent">年化收益<span class="sort-icon none"></span></th>
                                        <th class="sortable" data-sort="margin" data-i18n="table.margin">保证金<span class="sort-icon none"></span></th>
                                        <th class="sortable" data-sort="bid" data-i18n="table.bid">买价<span class="sort-icon none"></span></th>
                                        <th class="sortable" data-sort="ask" data-i18n="table.ask">卖价<span class="sort-icon none"></span></th>
                                        <th class="sortable" data-sort="liquidity" data-i18n="table.liq" data-i18n-title="liquidity.tooltip" title="流动性：0-100%，数值越高流动性越好">流动性<span class="sort-icon none"></span></th>
                                        <th class="score-header sortable" data-sort="recommendation" data-i18n="table.recommendation">推荐值<span class="sort-icon none"></span></th>
                                    </tr>
                                </thead>
                                <tbody id="putsTable">
                                </tbody>
                            </table>
                        </div>
                        <div class="table-scroll-controls">
                            <button class="scroll-btn-vertical" onclick="scrollTable('puts', -200)">
                                <span class="arrow-line arrow-left"></span>
                            </button>
                            <div class="scroll-indicator-vertical">Scroll</div>
                            <button class="scroll-btn-vertical" onclick="scrollTable('puts', 200)">
                                <span class="arrow-line arrow-right"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';

        // ==================== 国际化系统 ====================
        const i18n = {
            zh: {
                'app.title': 'Alpha GBM - 期权分析',
                'nav.stockAnalysis': '股票分析',
                'nav.optionResearch': '期权研究',
                'nav.agent': '智能体（敬请期待）',
                'nav.researchNotes': '研究笔记（敬请期待）',
                'header.title': 'Alpha GBM 期权工具',
                'header.subtitle': '期权不是赌博，是给投资上安全锁或加速器。基于 G=B+M 理念，将期权作为实现投资目标的高级工具。',
                'form.symbol': '股票代码',
                'form.symbolPlaceholder': '输入代码 (例如: AAPL)',
                'form.expiry': '到期日期',
                'form.selectExpiry': '选择到期日期...',
                'form.tradeType': '交易类型',
                'form.tradeType.all': '全部',
                'form.tradeType.sellPut': '卖出看跌 (Sell Put) - Value风格：现金担保看跌',
                'form.tradeType.sellCall': '卖出看涨 (Sell Call) - Quality风格：备兑看涨',
                'form.tradeType.buyCall': '买入看涨 (Buy Call) - Growth/Momentum风格：看涨价差',
                'form.tradeType.buyPut': '买入看跌 (Buy Put)',
                'form.advanced.title': '高级筛选选项',
                'form.advanced.expand': '展开高级选项',
                'form.advanced.collapse': '收起',
                'form.advanced.minAnnualReturn': '最低年化收益 (%)',
                'form.advanced.maxAnnualReturn': '最高年化收益 (%)',
                'form.advanced.minPremium': '最低权利金 ($)',
                'form.advanced.maxPremium': '最高权利金 ($)',
                'form.advanced.maxSpread': '最大买卖价差 ($)',
                'form.advanced.clear': '清除筛选',
                'button.queryOptions': '查询期权',
                'risk.title': '投资风险提示',
                'risk.message': '所有数据分析由AI生成，不构成投资建议。投资有风险，入市需谨慎。',
                'loading.text': '正在加载期权数据...',
                'results.title': '期权链',
                'table.current': '当前',
                'table.calls.title': '看涨期权 (备兑看涨策略)',
                'table.calls.title.quality': '看涨期权 - Quality风格：备兑看涨策略（收租金模式）',
                'table.calls.title.growth': '看涨期权 - Growth风格：看涨价差策略（趋势加速器）',
                'table.puts.title': '看跌期权 (现金担保看跌策略)',
                'table.puts.title.value': '看跌期权 - Value风格：现金担保看跌（低价接货，还能收钱）',
                'table.strike': '行权价',
                'table.lastPrice': '最新价格',
                'table.priceDiff': '价差',
                'table.bid': '买价',
                'table.ask': '卖价',
                'table.assignPercent': '行权概率',
                'table.annualPercent': '年化收益',
                'table.margin': '保证金',
                'table.liq': '流动性',
                'table.winRate': '胜率',
                'table.winRateTooltip': '盈利概率：根据历史波动率计算的策略盈利概率',
                'table.recommendation': '推荐值',
                'recommendation.excellent': '优秀',
                'recommendation.good': '良好',
                'recommendation.fair': '一般',
                'recommendation.poor': '较差',
                'modal.riskConfirm': '风险确认',
                'risk.question': '如果这笔交易完全失败，你将损失：',
                'risk.maxLoss': '最大损失',
                'risk.accountPercent': '占账户比例',
                'risk.winRate': '盈利概率',
                'risk.confirm': '你能接受这个风险吗？请确认你理解并接受最大损失。',
                'button.thinkAgain': '我再想想',
                'button.confirm': '我确认',
                'button.confirmAccept': '我接受，继续交易',
                'premortem.confirmed': '交易已确认！',
                'detail.strike': '行权价',
                'detail.annualReturn': '年化收益',
                'detail.assignProb': '行权概率',
                'detail.premium': '权利金',
                'detail.latestPrice': '最新价',
                'detail.stopLoss': '止损价',
                'liquidity.good': '良好',
                'liquidity.medium': '中等',
                'liquidity.low': '较低',
                'table.sprv': 'SPRV',
                'table.bprv': 'BPRV',
                'error.loadExpirations': '加载到期日期失败',
                'error.loadOptions': '加载期权链失败',
                'error.enterSymbol': '请输入股票代码',
                'error.selectExpiry': '请输入代码并选择到期日期',
                'error.selectTradeType': '请选择交易类型',
                'alert.monthly': '月度',
                'alert.weekly': '周度',
                'meta.expiration': '到期',
                'meta.calls': '看涨期权',
                'meta.puts': '看跌期权',
                'meta.options': '个期权'
            },
            en: {
                'app.title': 'Alpha GBM - Option Analysis',
                'nav.stockAnalysis': 'Stock Analysis',
                'nav.optionResearch': 'Option Research',
                'nav.agent': 'Agent (Coming Soon)',
                'nav.researchNotes': 'Research Notes (Coming Soon)',
                'header.title': 'Alpha GBM Option Tools',
                'header.subtitle': 'Options are not gambling, but a "safety lock" or "accelerator" for your Alpha GBM. Based on G=B+M philosophy, use options as advanced tools to achieve investment goals.',
                'form.symbol': 'Stock Symbol',
                'form.symbolPlaceholder': 'Enter symbol (e.g., AAPL)',
                'form.expiry': 'Expiration Date',
                'form.selectExpiry': 'Select an expiration date...',
                'form.tradeType': 'Trade Type',
                'form.tradeType.all': 'All',
                'form.tradeType.sellPut': 'Sell Put - Value Style: Cash Secured Put',
                'form.tradeType.sellCall': 'Sell Call - Quality Style: Covered Call',
                'form.tradeType.buyCall': 'Buy Call - Growth/Momentum Style: Bull Call Spread',
                'form.tradeType.buyPut': 'Buy Put',
                'form.advanced.title': 'Advanced Filter Options',
                'form.advanced.expand': 'Show Advanced Options',
                'form.advanced.collapse': 'Hide',
                'form.advanced.minAnnualReturn': 'Min Annual Return (%)',
                'form.advanced.maxAnnualReturn': 'Max Annual Return (%)',
                'form.advanced.minPremium': 'Min Premium ($)',
                'form.advanced.maxPremium': 'Max Premium ($)',
                'form.advanced.maxSpread': 'Max Bid-Ask Spread ($)',
                'form.advanced.clear': 'Clear Filters',
                'button.queryOptions': 'Query Options',
                'risk.title': 'Investment Risk Warning',
                'risk.message': 'All data analysis is AI-generated and does not constitute investment advice. Investment involves risks, please invest with caution.',
                'loading.text': 'Loading option data...',
                'results.title': 'Option Chain',
                'table.current': 'Current',
                'table.calls.title': 'CALL Options (Covered Call Strategy)',
                'table.calls.title.quality': 'CALL Options - Quality Style: Covered Call (Rent Collection)',
                'table.calls.title.growth': 'CALL Options - Growth Style: Bull Call Spread (Trend Accelerator)',
                'table.puts.title': 'PUT Options (Cash-Secured Put Strategy)',
                'table.puts.title.value': 'PUT Options - Value Style: Cash Secured Put (Buy Low, Get Paid)',
                'table.strike': 'Strike',
                'table.lastPrice': 'Last Price',
                'table.priceDiff': 'Price Diff',
                'table.bid': 'Bid',
                'table.ask': 'Ask',
                'table.assignPercent': 'Assign %',
                'table.annualPercent': 'Annual Return',
                'table.margin': 'Margin',
                'table.liq': 'Liquidity',
                'table.winRate': 'Win Rate',
                'table.winRateTooltip': 'Probability of Profit: Calculated based on historical volatility',
                'table.recommendation': 'Recommendation',
                'recommendation.excellent': 'Excellent',
                'recommendation.good': 'Good',
                'recommendation.fair': 'Fair',
                'recommendation.poor': 'Poor',
                'modal.riskConfirm': 'Risk Confirmation',
                'risk.question': 'If this trade fails completely, you will lose:',
                'risk.maxLoss': 'Max Loss',
                'risk.accountPercent': 'Account %',
                'risk.winRate': 'Win Rate',
                'risk.confirm': 'Can you accept this risk? Please confirm you understand and accept the maximum loss.',
                'button.thinkAgain': 'Let me think',
                'button.confirm': 'I Confirm',
                'button.confirmAccept': 'I Accept, Proceed',
                'premortem.confirmed': 'Trade Confirmed!',
                'detail.strike': 'Strike Price',
                'detail.annualReturn': 'Annual Return',
                'detail.assignProb': 'Exercise Probability',
                'detail.premium': 'Premium',
                'detail.latestPrice': 'Latest Price',
                'detail.stopLoss': 'Stop Loss',
                'liquidity.good': 'Good',
                'liquidity.medium': 'Medium',
                'liquidity.low': 'Low',
                'liquidity.tooltip': 'Liquidity: 0-100%, higher value means better liquidity',
                'table.scrv': 'SCRV',
                'table.bcrv': 'BCRV',
                'error.loadExpirations': 'Failed to load expiration dates',
                'error.loadOptions': 'Failed to load option chain',
                'error.enterSymbol': 'Please enter a stock symbol',
                'error.selectExpiry': 'Please enter a symbol and select an expiration date',
                'error.selectTradeType': 'Please select a trade type',
                'alert.monthly': 'Monthly',
                'alert.weekly': 'Weekly',
                'meta.expiration': 'Expiration',
                'meta.calls': 'CALL options',
                'meta.puts': 'PUT options',
                'meta.options': 'options'
            }
        };

        let currentLang = localStorage.getItem('lang') || 'zh';

        function t(key) {
            return i18n[currentLang][key] || key;
        }

        function toggleLanguage() {
            const newLang = currentLang === 'zh' ? 'en' : 'zh';
            switchLanguage(newLang);
        }

        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            
            // 更新语言切换按钮文本（显示另一种语言）
            const langToggleBtn = document.getElementById('langToggleBtn');
            if (langToggleBtn) {
                langToggleBtn.textContent = lang === 'zh' ? 'EN' : '中文';
            }

            // 更新所有文本
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key) {
                    el.textContent = t(key);
                }
            });

            // 更新 placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (key) {
                    el.placeholder = t(key);
                }
            });

            // 更新 title 属性
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (key) {
                    el.title = t(key);
                }
            });

            // 更新高级选项按钮文本
            const advancedOptions = document.getElementById('advancedOptions');
            const toggleBtn = document.getElementById('toggleAdvancedBtn');
            if (toggleBtn && advancedOptions) {
                const isVisible = advancedOptions.style.display !== 'none';
                toggleBtn.textContent = isVisible ? t('form.advanced.collapse') : t('form.advanced.expand');
            }

            // 更新 HTML lang 属性
            document.documentElement.lang = lang;
        }

        // 初始化语言
        document.addEventListener('DOMContentLoaded', () => {
            switchLanguage(currentLang);
            document.body.classList.add('has-navbar');
            
            // 初始化语言切换按钮文本
            const langToggleBtn = document.getElementById('langToggleBtn');
            if (langToggleBtn) {
                langToggleBtn.textContent = currentLang === 'zh' ? 'EN' : '中文';
            }
            
            // 初始化查询按钮状态
            checkQueryButtonState();
        });

        // ==================== 表格排序功能 ====================
        let sortState = {
            calls: { column: null, direction: null },
            puts: { column: null, direction: null }
        };

        // 排序函数
        function sortOptions(options, column, direction, stockPrice, optionType, tradeType) {
            if (!column || !direction) return options;
            
            const sorted = [...options].sort((a, b) => {
                const scoresA = a.scores || {};
                const scoresB = b.scores || {};
                let valueA, valueB;
                
                switch(column) {
                    case 'strike':
                        valueA = parseFloat(a.strike) || 0;
                        valueB = parseFloat(b.strike) || 0;
                        break;
                    case 'lastPrice':
                        valueA = parseFloat(a.latest_price) || 0;
                        valueB = parseFloat(b.latest_price) || 0;
                        break;
                    case 'priceDiff':
                        const priceDiffA = parseFloat(calculatePriceDiff(stockPrice, a.strike, optionType)) || 0;
                        const priceDiffB = parseFloat(calculatePriceDiff(stockPrice, b.strike, optionType)) || 0;
                        valueA = priceDiffA;
                        valueB = priceDiffB;
                        break;
                    case 'assignProb':
                        valueA = parseFloat(scoresA.assignment_probability) || 0;
                        valueB = parseFloat(scoresB.assignment_probability) || 0;
                        break;
                    case 'annualReturn':
                        valueA = parseFloat(scoresA.annualized_return) || 0;
                        valueB = parseFloat(scoresB.annualized_return) || 0;
                        break;
                    case 'margin':
                        valueA = parseFloat(scoresA.margin_requirement) || 0;
                        valueB = parseFloat(scoresB.margin_requirement) || 0;
                        break;
                    case 'bid':
                        valueA = parseFloat(a.bid_price) || 0;
                        valueB = parseFloat(b.bid_price) || 0;
                        break;
                    case 'ask':
                        valueA = parseFloat(a.ask_price) || 0;
                        valueB = parseFloat(b.ask_price) || 0;
                        break;
                    case 'liquidity':
                        valueA = parseFloat(scoresA.liquidity_factor) || 0;
                        valueB = parseFloat(scoresB.liquidity_factor) || 0;
                        break;
                    case 'recommendation':
                        const recA = calculateRecommendation(a, scoresA, stockPrice, optionType, tradeType);
                        const recB = calculateRecommendation(b, scoresB, stockPrice, optionType, tradeType);
                        valueA = recA.value;
                        valueB = recB.value;
                        break;
                    default:
                        return 0;
                }
                
                if (direction === 'asc') {
                    return valueA - valueB;
                } else {
                    return valueB - valueA;
                }
            });
            
            return sorted;
        }

        // 更新排序图标
        function updateSortIcons(tableType, column, direction) {
            const tableId = tableType === 'calls' ? 'callsTable' : 'putsTable';
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const thead = table.closest('table').querySelector('thead');
            if (!thead) return;
            
            const headers = thead.querySelectorAll('th.sortable');
            headers.forEach(header => {
                const icon = header.querySelector('.sort-icon');
                if (!icon) return;
                
                const sortColumn = header.getAttribute('data-sort');
                if (sortColumn === column) {
                    icon.className = 'sort-icon active ' + direction;
                } else {
                    icon.className = 'sort-icon none';
                }
            });
        }

        // 处理表头点击
        function handleHeaderClick(event, tableType) {
            const header = event.target.closest('th.sortable');
            if (!header) return;
            
            // 如果点击的是排序图标，也要处理
            if (event.target.classList.contains('sort-icon')) {
                const parentHeader = event.target.closest('th.sortable');
                if (parentHeader) {
                    const column = parentHeader.getAttribute('data-sort');
                    if (column) {
                        handleSort(column, tableType);
                    }
                }
                return;
            }
            
            const column = header.getAttribute('data-sort');
            if (!column) return;
            
            handleSort(column, tableType);
        }

        // 执行排序
        function handleSort(column, tableType) {
            const currentState = sortState[tableType];
            let newDirection = 'asc';
            
            if (currentState.column === column) {
                // 切换排序方向：asc -> desc -> null
                if (currentState.direction === 'asc') {
                    newDirection = 'desc';
                } else if (currentState.direction === 'desc') {
                    newDirection = null;
                    sortState[tableType] = { column: null, direction: null };
                    updateSortIcons(tableType, null, null);
                    // 重新加载表格以恢复原始顺序
                    const symbol = document.getElementById('symbol').value.toUpperCase().trim();
                    const expiry = document.getElementById('expiry').value;
                    if (symbol && expiry) {
                        loadOptionChain();
                    }
                    return;
                }
            }
            
            sortState[tableType] = { column: column, direction: newDirection };
            updateSortIcons(tableType, column, newDirection);
            
            // 重新加载表格以应用排序
            const symbol = document.getElementById('symbol').value.toUpperCase().trim();
            const expiry = document.getElementById('expiry').value;
            if (symbol && expiry) {
                loadOptionChain();
            }
        }

        // 初始化排序功能
        function initializeSorting() {
            // 为Calls表格添加点击事件
            const callsTable = document.getElementById('callsTable');
            if (callsTable) {
                const callsThead = callsTable.closest('table').querySelector('thead');
                if (callsThead) {
                    callsThead.addEventListener('click', (e) => handleHeaderClick(e, 'calls'));
                }
            }
            
            // 为Puts表格添加点击事件
            const putsTable = document.getElementById('putsTable');
            if (putsTable) {
                const putsThead = putsTable.closest('table').querySelector('thead');
                if (putsThead) {
                    putsThead.addEventListener('click', (e) => handleHeaderClick(e, 'puts'));
                }
            }
        }

        // ==================== 期权详情弹窗 ====================
        let optionDetailChart = null;
        let currentOptionData = null;

        async function showOptionDetailModal(option, scores, optionType, stockPrice, symbol, expiryDate) {
            currentOptionData = { option, scores, optionType, stockPrice, symbol, expiryDate };
            const modal = document.getElementById('optionDetailModal');
            
            // 更新基本信息
            document.getElementById('detailStrike').textContent = formatCurrency(option.strike);
            document.getElementById('detailAnnualReturn').textContent = formatPercentDirect(scores.annualized_return, 2);
            document.getElementById('detailAssignProb').textContent = formatAssignmentPercent(scores.assignment_probability);
            document.getElementById('detailPremium').textContent = formatCurrency(scores.premium_income || 0);
            document.getElementById('detailLatestPrice').textContent = formatCurrency(option.latest_price || stockPrice);
            
            // 计算止损价（简化：行权价的1.25倍作为止损价）
            const stopLoss = option.strike * 1.25;
            document.getElementById('detailStopLoss').textContent = formatCurrency(stopLoss);
            
            
            // 隐藏VRP和风险分析区域（等待数据加载）
            document.getElementById('vrpAnalysisSection').style.display = 'none';
            document.getElementById('riskAnalysisSection').style.display = 'none';
            
            // 显示模态框
            modal.classList.add('show');
            
            // 等待模态框完全显示后再绘制图表
            setTimeout(() => {
                drawOptionChart(option, scores, stockPrice, symbol);
            }, 200);
            
            // 异步加载VRP和风险分析数据
            try {
                // 构建option identifier
                const optionIdentifier = option.identifier || `${symbol} ${expiryDate.replace(/-/g, '')}${optionType === 'call' ? 'C' : 'P'}${String(Math.round(option.strike * 1000)).padStart(8, '0')}`;
                await loadEnhancedAnalysis(symbol, optionIdentifier, option, scores, stockPrice, optionType);
            } catch (error) {
                console.error('Error loading enhanced analysis:', error);
                // 静默失败，不影响主功能
            }
        }
        
        // 加载增强分析数据（VRP和风险分析）
        async function loadEnhancedAnalysis(symbol, optionIdentifier, option, scores, stockPrice, optionType) {
            try {
                const response = await fetch(`${API_BASE}/enhanced-analysis/${symbol}/${encodeURIComponent(optionIdentifier)}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // 显示VRP分析
                if (data.vrp_result && data.available) {
                    const vrp = data.vrp_result;
                    document.getElementById('detailVRP').textContent = formatPercent(vrp.vrp, 2);
                    document.getElementById('detailIVRank').textContent = formatNumber(vrp.iv_rank, 1) + '%';
                    document.getElementById('detailIV').textContent = formatPercent(vrp.iv, 2);
                    document.getElementById('detailRV').textContent = formatPercent(vrp.rv_forecast, 2);
                    
                    // 显示推荐
                    let recommendationText = '-';
                    let recommendationColor = 'var(--foreground)';
                    if (vrp.recommendation === 'sell') {
                        recommendationText = '卖出波动率';
                        recommendationColor = 'var(--primary)';
                    } else if (vrp.recommendation === 'buy') {
                        recommendationText = '买入波动率';
                        recommendationColor = 'var(--warning)';
                    } else if (vrp.recommendation === 'neutral') {
                        recommendationText = '中性';
                    }
                    document.getElementById('detailVRPRecommendation').textContent = recommendationText;
                    document.getElementById('detailVRPRecommendation').style.color = recommendationColor;
                    
                    document.getElementById('vrpAnalysisSection').style.display = 'block';
                }
                
                // 显示风险分析
                if (data.risk_analysis && data.available) {
                    const risk = data.risk_analysis;
                    document.getElementById('detailExpectedValue').textContent = formatCurrency(risk.expected_value);
                    document.getElementById('detailRAE').textContent = formatPercent(risk.risk_adjusted_expectancy, 2);
                    
                    // 显示风险等级
                    let riskLevelText = '-';
                    let riskLevelColor = 'var(--foreground)';
                    const riskLevel = risk.risk_level?.toLowerCase() || '';
                    if (riskLevel === 'low') {
                        riskLevelText = '低';
                        riskLevelColor = 'var(--primary)';
                    } else if (riskLevel === 'medium') {
                        riskLevelText = '中';
                        riskLevelColor = 'var(--warning)';
                    } else if (riskLevel === 'high') {
                        riskLevelText = '高';
                        riskLevelColor = 'var(--warning)';
                    } else if (riskLevel === 'extreme') {
                        riskLevelText = '极高';
                        riskLevelColor = '#ef4444';
                    }
                    document.getElementById('detailRiskLevel').textContent = riskLevelText;
                    document.getElementById('detailRiskLevel').style.color = riskLevelColor;
                    
                    // 显示风险警告
                    if (risk.tail_risk_warning) {
                        const warningEl = document.getElementById('detailRiskWarning');
                        warningEl.textContent = risk.tail_risk_warning;
                        warningEl.style.display = 'block';
                    }
                    
                    document.getElementById('riskAnalysisSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load enhanced analysis:', error);
                // 静默失败，不显示错误信息
            }
        }

        function closeOptionDetailModal() {
            const modal = document.getElementById('optionDetailModal');
            modal.classList.remove('show');
            currentOptionData = null;
            if (optionDetailChart) {
                try {
                    optionDetailChart.remove();
                } catch (e) {
                    console.error('Error removing chart:', e);
                }
                optionDetailChart = null;
            }
            // 清空图表容器
            const chartContainer = document.getElementById('optionChart');
            if (chartContainer) {
                chartContainer.innerHTML = '';
            }
        }

        function confirmTrade() {
            // 直接关闭弹窗，回到原页面
            // 这里可以添加实际的交易确认逻辑（如发送到后端API）
            closeOptionDetailModal();
        }

        function drawOptionChart(option, scores, stockPrice, symbol) {
            // 检查库是否已加载
            if (typeof LightweightCharts === 'undefined') {
                console.error('LightweightCharts library not loaded');
                return;
            }
            
            const chartContainer = document.getElementById('optionChart');
            if (!chartContainer) {
                console.error('Chart container not found');
                return;
            }
            
            // 清空容器
            chartContainer.innerHTML = '';
            
            // 获取容器实际尺寸（等待一下确保容器已渲染）
            const getContainerSize = () => {
                const rect = chartContainer.getBoundingClientRect();
                return {
                    width: rect.width > 0 ? rect.width - 32 : 800, // 减去padding
                    height: 180  // 减小高度以避免遮挡下方内容
                };
            };
            
            const size = getContainerSize();
            
            // 清空容器（移除之前的加载提示）
            chartContainer.innerHTML = '';
            
            // 异步加载历史数据
            loadChartData(symbol, option, stockPrice, chartContainer, size);
        }
        
        async function loadChartData(symbol, option, stockPrice, chartContainer, size) {
            try {
                // 从API获取历史数据（60天）
                const response = await fetch(`${API_BASE}/stock-history/${symbol}?days=60`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const historyData = await response.json();
                
                if (!historyData.data || historyData.data.length === 0) {
                    throw new Error('没有历史数据');
                }
                
                // 清空容器（移除加载提示，准备创建图表）
                chartContainer.innerHTML = '';
                
                // 创建图表
                const chart = LightweightCharts.createChart(chartContainer, {
                    width: size.width,
                    height: size.height,
                    layout: {
                        background: { color: '#09090B' },
                        textColor: '#9CA3AF',
                    },
                    grid: {
                        vertLines: { color: 'rgba(39, 39, 42, 0.5)' },
                        horzLines: { color: 'rgba(39, 39, 42, 0.5)' },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderColor: 'rgba(39, 39, 42, 0.8)',
                    },
                    timeScale: {
                        borderColor: 'rgba(39, 39, 42, 0.8)',
                        timeVisible: true,
                        secondsVisible: false,
                    },
                });
                
                // 创建K线系列（检查方法是否存在以兼容不同版本）
                let candlestickSeries;
                if (typeof chart.addCandlestickSeries === 'function') {
                    candlestickSeries = chart.addCandlestickSeries({
                        upColor: '#10B981',
                        downColor: '#EF4444',
                        borderVisible: false,
                        wickUpColor: '#10B981',
                        wickDownColor: '#EF4444',
                    });
                } else {
                    throw new Error('chart.addCandlestickSeries 方法不存在，请检查图表库版本');
                }
                
                // 使用从API获取的真实历史数据
                const data = historyData.data.map(item => ({
                    time: item.time,
                    open: item.open,
                    high: item.high,
                    low: item.low,
                    close: item.close
                }));
                
                // 设置数据
                candlestickSeries.setData(data);
                
                // 添加价格水平线：执行价和止损价
                const strikePrice = parseFloat(option.strike) || 0;
                
                // 计算止损价（根据期权类型）
                // 对于卖出看跌期权：止损价 = 行权价 * 1.25（股价上涨25%触发止损）
                // 对于卖出看涨期权：止损价 = 行权价 * 0.75（股价下跌25%触发止损）
                const optionType = option.put_call || 'PUT';
                let stopLoss;
                if (optionType === 'PUT') {
                    stopLoss = strikePrice * 1.25;  // 卖出看跌：股价上涨25%触发止损
                } else {
                    stopLoss = strikePrice * 0.75;  // 卖出看涨：股价下跌25%触发止损
                }
                
                // 添加执行价虚线
                candlestickSeries.createPriceLine({
                    price: strikePrice,
                    color: '#3B82F6',
                    lineWidth: 2,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: true,
                    title: `执行价: $${strikePrice.toFixed(2)}`,
                });
                
                // 添加止损价虚线
                candlestickSeries.createPriceLine({
                    price: stopLoss,
                    color: '#EAB308',
                    lineWidth: 2,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: true,
                    title: `止损价: $${stopLoss.toFixed(2)}`,
                });
                
                // 自适应缩放
                chart.timeScale().fitContent();
                
                // 保存图表引用
                optionDetailChart = chart;
                
                // 处理窗口大小变化
                const resizeHandler = () => {
                    if (optionDetailChart && chartContainer) {
                        const newWidth = chartContainer.clientWidth || 800;
                        optionDetailChart.applyOptions({
                            width: newWidth
                        });
                    }
                };
                
                // 移除旧的监听器（如果存在）
                window.removeEventListener('resize', resizeHandler);
                window.addEventListener('resize', resizeHandler);
                
            } catch (error) {
                console.error('Error loading chart data:', error);
                chartContainer.innerHTML = '<p style="color: #EF4444; padding: 2rem; text-align: center;">图表加载失败: ' + error.message + '</p>';
            }
        }

        function generateCandlestickData(startPrice, strikePrice, latestPrice) {
            const data = [];
            const days = 365;
            let currentPrice = startPrice;
            const baseDate = new Date();
            baseDate.setFullYear(baseDate.getFullYear() - 1);
            
            for (let i = 0; i < days; i += 5) {
                const date = new Date(baseDate);
                date.setDate(date.getDate() + i);
                
                // 模拟价格波动
                const volatility = 0.02;
                const change = (Math.random() - 0.5) * volatility * currentPrice;
                const open = currentPrice;
                const close = currentPrice + change;
                const high = Math.max(open, close) + Math.random() * volatility * currentPrice * 0.5;
                const low = Math.min(open, close) - Math.random() * volatility * currentPrice * 0.5;
                
                // 确保价格趋势向最新价靠近
                if (i > days * 0.7) {
                    const targetPrice = latestPrice;
                    const progress = (i - days * 0.7) / (days * 0.3);
                    currentPrice = currentPrice + (targetPrice - currentPrice) * 0.1 * progress;
                }
                
                currentPrice = close;
                
                data.push({
                    time: Math.floor(date.getTime() / 1000),
                    open: open,
                    high: high,
                    low: low,
                    close: close
                });
            }
            
            return data;
        }

        // 点击模态框外部关闭
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('optionDetailModal');
            if (modal && e.target === modal) {
                closeOptionDetailModal();
            }
        });



        // ==================== 高级选项控制 ====================
        function toggleAdvancedOptions() {
            const advancedOptions = document.getElementById('advancedOptions');
            const toggleBtn = document.getElementById('toggleAdvancedBtn');
            const isVisible = advancedOptions.style.display !== 'none';
            
            advancedOptions.style.display = isVisible ? 'none' : 'block';
            if (toggleBtn) {
                toggleBtn.textContent = isVisible ? t('form.advanced.expand') : t('form.advanced.collapse');
            }
        }

        function clearAdvancedFilters() {
            document.getElementById('minAnnualReturn').value = '';
            document.getElementById('maxAnnualReturn').value = '';
            document.getElementById('minPremium').value = '';
            document.getElementById('maxPremium').value = '';
            document.getElementById('maxBidAskSpread').value = '';
        }

        // ==================== 筛选函数 ====================
        function filterOptions(options, tradeType) {
            let filtered = [...options]; // 创建副本避免修改原数组

            // 应用高级筛选
            const minAnnualReturnInput = document.getElementById('minAnnualReturn').value;
            const maxAnnualReturnInput = document.getElementById('maxAnnualReturn').value;
            const minPremiumInput = document.getElementById('minPremium').value;
            const maxPremiumInput = document.getElementById('maxPremium').value;
            const maxSpreadInput = document.getElementById('maxBidAskSpread').value;

            const minAnnualReturn = minAnnualReturnInput ? parseFloat(minAnnualReturnInput) : 0;
            const maxAnnualReturn = maxAnnualReturnInput ? parseFloat(maxAnnualReturnInput) : Infinity;
            const minPremium = minPremiumInput ? parseFloat(minPremiumInput) : 0;
            const maxPremium = maxPremiumInput ? parseFloat(maxPremiumInput) : Infinity;
            const maxSpread = maxSpreadInput ? parseFloat(maxSpreadInput) : Infinity;

            filtered = filtered.filter(option => {
                const scores = option.scores || {};
                
                // 年化收益率筛选（后端返回的已经是百分比格式，如15.5表示15.5%）
                const annualReturn = parseFloat(scores.annualized_return) || 0;
                const annualReturnPercent = annualReturn; // 已经是百分比格式，不需要再乘以100
                
                // 权利金筛选
                const premium = parseFloat(scores.premium_income) || 0;
                
                // 买卖价差筛选
                const bidPrice = parseFloat(option.bid_price) || 0;
                const askPrice = parseFloat(option.ask_price) || 0;
                const spread = Math.abs(askPrice - bidPrice);

                // 应用所有筛选条件
                const passAnnualReturn = annualReturnPercent >= minAnnualReturn && annualReturnPercent <= maxAnnualReturn;
                const passPremium = premium >= minPremium && premium <= maxPremium;
                const passSpread = spread <= maxSpread;

                return passAnnualReturn && passPremium && passSpread;
            });

            return filtered;
        }

        async function apiCall(endpoint) {
            const response = await fetch(`${API_BASE}${endpoint}`);
            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }
            return response.json();
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            hideLoading();
        }

        function formatNumber(num, decimals = 2) {
            return num ? parseFloat(num).toFixed(decimals) : '-';
        }

        function formatPercent(num, decimals = 2) {
            if (num === null || num === undefined || num === 0) return '-';
            if (decimals === 1) {
                return parseFloat(num).toFixed(1) + '%';
            }
            return (parseFloat(num) * 100).toFixed(decimals) + '%';
        }

        // 格式化已经是百分比的值（后端返回的年化收益已经是百分比格式）
        function formatPercentDirect(num, decimals = 1) {
            if (num === null || num === undefined) return '-';
            const value = parseFloat(num);
            if (isNaN(value)) return '-';
            return value.toFixed(decimals) + '%';
        }

        // 格式化胜率（0-100的百分比值）
        function formatWinRate(winRate) {
            if (winRate === null || winRate === undefined || isNaN(winRate)) return '-';
            const value = parseFloat(winRate);
            return value.toFixed(0) + '%';
        }

        function formatCurrency(amount) {
            if (!amount || amount === 0) return '-';
            return '$' + parseFloat(amount).toLocaleString();
        }

        function getReturnClass(returnValue) {
            if (!returnValue || returnValue === 0) return '';
            const value = parseFloat(returnValue);
            if (value > 20) return 'score-high';      // >20% annual return = high
            if (value > 10) return 'score-medium';    // >10% annual return = medium
            return 'score-low';                       // <10% annual return = low
        }

        function formatAssignmentPercent(assignmentProb) {
            // Return "- %" when data is missing to avoid misleading users
            if (assignmentProb === null || assignmentProb === undefined) return '-%';
            if (assignmentProb === 0) return '0.0%';
            return parseFloat(assignmentProb).toFixed(1) + '%';
        }

        function getAssignmentClass(assignmentProb) {
            if (!assignmentProb || assignmentProb === 0) return '';
            const value = parseFloat(assignmentProb);
            if (value > 70) return 'score-high';      // >70% assignment probability = high risk
            if (value > 30) return 'score-medium';    // >30% assignment probability = medium risk
            return 'score-low';                       // <30% assignment probability = low risk
        }

        function formatScore(score, decimals = 4) {
            if (!score || score === 0) return '-';
            return parseFloat(score).toFixed(decimals);
        }

        // 格式化流动性显示（只显示文字等级）
        function formatLiquidity(liquidity) {
            if (!liquidity || liquidity === 0) return '-';
            const value = parseFloat(liquidity);
            
            // 根据流动性值确定等级：良好、中等、较低
            if (value >= 0.8) {
                return t('liquidity.good');
            } else if (value >= 0.4) {
                return t('liquidity.medium');
            } else {
                return t('liquidity.low');
            }
        }

        function scrollTable(tableType, amount) {
            const containerId = tableType + 'TableContainer';
            const container = document.getElementById(containerId);

            console.log(`Scrolling ${tableType} by ${amount}px`);

            if (container) {
                container.scrollLeft += amount;
                console.log(`New scrollLeft: ${container.scrollLeft}`);

                // 强制更新指示器
                setTimeout(() => {
                    updateScrollIndicator(tableType);
                }, 50);
            } else {
                console.error(`Container not found: ${containerId}`);
            }
        }

        function updateScrollIndicator(tableType) {
            const containerId = tableType + 'TableContainer';
            const indicatorId = tableType + 'ScrollIndicator';
            const leftBtnId = tableType + 'ScrollLeft';
            const rightBtnId = tableType + 'ScrollRight';

            const container = document.getElementById(containerId);
            const indicator = document.getElementById(indicatorId);
            const leftBtn = document.getElementById(leftBtnId);
            const rightBtn = document.getElementById(rightBtnId);

            console.log(`Updating ${tableType} indicators - Container:`, !!container, 'Indicator:', !!indicator, 'Buttons:', !!leftBtn, !!rightBtn);

            if (!container) {
                console.error(`Container not found: ${containerId}`);
                return;
            }

            const scrollLeft = container.scrollLeft;
            const scrollWidth = container.scrollWidth;
            const clientWidth = container.clientWidth;
            const maxScroll = Math.max(0, scrollWidth - clientWidth);

            console.log(`${tableType} scroll info: left=${scrollLeft}, width=${scrollWidth}, client=${clientWidth}, max=${maxScroll}`);

            // Update button states
            if (leftBtn) {
                leftBtn.disabled = scrollLeft <= 5; // 留一点余量
                leftBtn.style.opacity = leftBtn.disabled ? '0.5' : '1';
            }

            if (rightBtn) {
                rightBtn.disabled = scrollLeft >= (maxScroll - 5); // 留一点余量
                rightBtn.style.opacity = rightBtn.disabled ? '0.5' : '1';
            }

            // Update indicator text
            if (indicator) {
                if (maxScroll <= 10) {
                    indicator.textContent = '所有列已显示';
                } else {
                    const percentage = Math.round((scrollLeft / maxScroll) * 100);
                    indicator.textContent = `已滚动 ${percentage}%`;
                }
            }
        }

        function getScoreClass(score, type = 'general') {
            if (!score || score === 0) return '';

            const value = parseFloat(score);
            if (type === 'sprv' || type === 'scrv' || type === 'bcrv' || type === 'bprv') {
                if (value > 0.01) return 'score-high';
                if (value > 0.005) return 'score-medium';
                return 'score-low';
            } else if (type === 'ivr') {
                if (value > 70) return 'score-high';
                if (value > 30) return 'score-medium';
                return 'score-low';
            } else if (type === 'liq') {
                if (value > 0.8) return 'score-high';
                if (value > 0.6) return 'score-medium';
                return 'score-low';
            }
            return '';
        }

        // 胜率等级分类
        function getWinRateClass(winRate) {
            if (!winRate || winRate === 0) return '';
            const value = parseFloat(winRate);
            if (value >= 70) return 'score-high';
            if (value >= 50) return 'score-medium';
            return 'score-low';
        }

        // 计算价差（最新价格和行权价的差）
        // 计算价差：股票当前价格和行权价之间的价差
        function calculatePriceDiff(stockPrice, strike, optionType = 'call') {
            if (!stockPrice || !strike) return '-';
            const diff = parseFloat(stockPrice) - parseFloat(strike);
            // 对于看涨期权，价差 = 股票价格 - 行权价（正数表示实值，负数表示虚值）
            // 对于看跌期权，价差 = 行权价 - 股票价格（正数表示实值，负数表示虚值）
            if (optionType === 'put') {
                return formatNumber(parseFloat(strike) - parseFloat(stockPrice));
            }
            return formatNumber(diff);
        }

        // 计算胜率（盈利概率）
        function calculateWinRate(option, scores, stockPrice, optionType = 'call', tradeType = 'sell') {
            if (!scores || !stockPrice) return 0;
            
            const strike = parseFloat(option.strike) || 0;
            const assignmentProb = parseFloat(scores.assignment_probability) || 0;
            const currentPrice = parseFloat(stockPrice) || 0;
            
            // 根据交易类型和期权类型计算胜率
            if (tradeType === 'sell') {
                // 卖出期权：胜率 = 1 - 行权概率（股价不触及行权价就盈利）
                if (!assignmentProb && assignmentProb !== 0) return 0; // 如果行权概率为空，返回0
                return Math.max(0, Math.min(100, (1 - assignmentProb / 100) * 100));
            } else {
                // 买入期权：需要计算股价达到盈亏平衡点的概率
                // 对于买入期权，权利金是期权的价格（latest_price），不是premium_income
                const optionPrice = parseFloat(option.latest_price) || 0;
                if (!optionPrice || optionPrice <= 0) return 0; // 如果没有期权价格，无法计算
                
                if (optionType === 'call') {
                    // 买入看涨：盈亏平衡点 = 行权价 + 权利金
                    // 胜率 = 股价超过盈亏平衡点的概率（简化：基于当前价差和波动率估算）
                    const breakEven = strike + optionPrice;
                    if (currentPrice >= breakEven) {
                        // 如果当前价格已经超过盈亏平衡点，胜率较高
                        return Math.max(60, Math.min(100, 60 + (currentPrice - breakEven) / strike * 20));
                    } else {
                        // 如果当前价格低于盈亏平衡点，胜率较低
                        const distance = (breakEven - currentPrice) / currentPrice;
                        return Math.max(0, Math.min(60, 60 - distance * 100));
                    }
                } else {
                    // 买入看跌：盈亏平衡点 = 行权价 - 权利金
                    const breakEven = strike - optionPrice;
                    if (currentPrice <= breakEven) {
                        // 如果当前价格已经低于盈亏平衡点，胜率较高
                        return Math.max(60, Math.min(100, 60 + (breakEven - currentPrice) / strike * 20));
                    } else {
                        // 如果当前价格高于盈亏平衡点，胜率较低
                        const distance = (currentPrice - breakEven) / currentPrice;
                        return Math.max(0, Math.min(60, 60 - distance * 100));
                    }
                }
            }
        }

        // 计算推荐值（基于Alpha GBM五大支柱，优化后的算法 v2.0）
        function calculateRecommendation(option, scores, stockPrice, optionType = 'call', tradeType = 'sell') {
            if (!scores) return { value: 0, text: '0', class: '', highlight: false };
            
            const annualReturn = parseFloat(scores.annualized_return) || 0;
            const annualReturnPercent = annualReturn; // 后端返回的已经是百分比格式，不需要再乘以100
            const assignmentProb = parseFloat(scores.assignment_probability) || 0;
            const liquidity = parseFloat(scores.liquidity_factor) || 0;
            const bidPrice = parseFloat(option.bid_price) || 0;
            const askPrice = parseFloat(option.ask_price) || 0;
            const openInterest = parseInt(option.open_interest) || 0;
            
            // ========== 价差率计算（Spread Ratio） ==========
            // 新逻辑：价差率 = (Ask - Bid) / MidPrice
            // 理由：$100的期权价差$0.5和$1的期权价差$0.5完全不同，比例更能反映交易磨损成本
            const midPrice = (bidPrice + askPrice) / 2 || option.latest_price || 0;
            const spreadRatio = midPrice > 0 ? (askPrice - bidPrice) / midPrice : 0;
            const spreadPercent = spreadRatio * 100; // 转换为百分比用于显示
            
            // ========== 一票否决机制（优化后） ==========
            // 不符合以下任一条件，直接返回0分
            if (liquidity < 0.3) {
                return { value: 0, text: '0', class: 'score-low', highlight: false, reason: '流动性太低' };
            }
            if (annualReturnPercent < 3) {
                return { value: 0, text: '0', class: 'score-low', highlight: false, reason: '收益太低' };
            }
            // 风险阈值收紧：行权概率 > 75% 即视为过度风险（旧逻辑：>80%）
            // 理由：实盘中，一旦概率超过75%，Gamma风险急剧上升，且此时往往已深度实值，流动性枯竭
            if (assignmentProb > 75) {
                return { value: 0, text: '0', class: 'score-low', highlight: false, reason: '风险太高' };
            }
            // OI一票否决：如果 OI < 10张，直接过滤，无论价差多小（防止做市商钓鱼单）
            if (openInterest > 0 && openInterest < 10) {
                return { value: 0, text: '0', class: 'score-low', highlight: false, reason: '未平仓量不足' };
            }
            // 价差率 > 10% 一票否决
            if (spreadPercent > 10) {
                return { value: 0, text: '0', class: 'score-low', highlight: false, reason: '交易成本太高' };
            }
            
            // ========== 评分计算（使用线性插值，更精准） ==========
            let score = 0;
            
            // 1. 量化决策 - 年化收益（权重 25%，最高25分）
            // 使用线性插值：3%->5分, 5%->10分, 8%->15分, 12%->20分, 15%->25分
            if (annualReturnPercent >= 15) {
                score += 25;
            } else if (annualReturnPercent >= 12) {
                // 12-15%之间线性插值：20-25分
                const ratio = (annualReturnPercent - 12) / (15 - 12);
                score += 20 + ratio * 5;
            } else if (annualReturnPercent >= 8) {
                // 8-12%之间线性插值：15-20分
                const ratio = (annualReturnPercent - 8) / (12 - 8);
                score += 15 + ratio * 5;
            } else if (annualReturnPercent >= 5) {
                // 5-8%之间线性插值：10-15分
                const ratio = (annualReturnPercent - 5) / (8 - 5);
                score += 10 + ratio * 5;
            } else if (annualReturnPercent >= 3) {
                // 3-5%之间线性插值：5-10分
                const ratio = (annualReturnPercent - 3) / (5 - 3);
                score += 5 + ratio * 5;
            }
            // <3% 已经在否决机制中排除
            
            // 2. 事前验尸 - 行权概率（权重 25%，最高25分，越低越好）
            // 使用线性插值：<15%->25分, 15-25%->20-25分, 25-35%->15-20分, 35-50%->10-15分, 50-70%->5-10分
            if (assignmentProb < 15) {
                score += 25;
            } else if (assignmentProb < 25) {
                // 15-25%之间线性插值：20-25分（概率越低分数越高）
                const ratio = (25 - assignmentProb) / (25 - 15);
                score += 20 + ratio * 5;
            } else if (assignmentProb < 35) {
                // 25-35%之间线性插值：15-20分
                const ratio = (35 - assignmentProb) / (35 - 25);
                score += 15 + ratio * 5;
            } else if (assignmentProb < 50) {
                // 35-50%之间线性插值：10-15分
                const ratio = (50 - assignmentProb) / (50 - 35);
                score += 10 + ratio * 5;
            } else if (assignmentProb < 70) {
                // 50-70%之间线性插值：5-10分
                const ratio = (70 - assignmentProb) / (70 - 50);
                score += 5 + ratio * 5;
            }
            // ≥70% 已经在否决机制中排除
            
            // 3. 严格风控 - 流动性（权重 25%，最高25分）
            // 流动性因子由后端计算：复合因子 = 40% 价差得分 + 60% OI得分
            // OI是判断流动性深度的"金标准"，特别是在盘前或交易清淡时
            // 使用线性插值：0.3->10分, 0.4->15分, 0.6->20分, 0.8->25分
            if (liquidity >= 0.8) {
                score += 25;
            } else if (liquidity >= 0.6) {
                // 0.6-0.8之间线性插值：20-25分
                const ratio = (liquidity - 0.6) / (0.8 - 0.6);
                score += 20 + ratio * 5;
            } else if (liquidity >= 0.4) {
                // 0.4-0.6之间线性插值：15-20分
                const ratio = (liquidity - 0.4) / (0.6 - 0.4);
                score += 15 + ratio * 5;
            } else if (liquidity >= 0.3) {
                // 0.3-0.4之间线性插值：10-15分
                const ratio = (liquidity - 0.3) / (0.4 - 0.3);
                score += 10 + ratio * 5;
            }
            // <0.3 已经在否决机制中排除
            
            // 4. 怀疑主义 - 买卖价差率（权重 15%，最高15分，越小越好）
            // 新逻辑：价差率 = (Ask - Bid) / MidPrice（比例更能反映交易磨损成本）
            // 使用线性插值：<1%->15分, 1-3%->12-15分, 3-5%->8-12分, 5-10%->4-8分
            if (spreadPercent < 1) {
                score += 15;
            } else if (spreadPercent < 3) {
                // 1-3%之间线性插值：12-15分（价差越小分数越高）
                const ratio = (3 - spreadPercent) / (3 - 1);
                score += 12 + ratio * 3;
            } else if (spreadPercent < 5) {
                // 3-5%之间线性插值：8-12分
                const ratio = (5 - spreadPercent) / (5 - 3);
                score += 8 + ratio * 4;
            } else if (spreadPercent < 10) {
                // 5-10%之间线性插值：4-8分
                const ratio = (10 - spreadPercent) / (10 - 5);
                score += 4 + ratio * 4;
            }
            // ≥10% 已经在否决机制中排除
            
            // ========== 确定推荐等级和显示 ==========
            // 总分现在是80分（年化收益25分 + 行权概率25分 + 流动性25分 + 买卖价差15分）
            let scoreClass, highlight;
            
            if (score >= 60) {  // 60/80 = 75%
                // 特别推荐：高亮显示
                scoreClass = 'score-high';
                highlight = true;
            } else if (score >= 52) {  // 52/80 = 65%
                // 推荐：黄色
                scoreClass = 'score-medium';
                highlight = false;
            } else if (score >= 40) {  // 40/80 = 50%
                // 一般：灰色
                scoreClass = 'score-medium';
                highlight = false;
            } else {
                // 不推荐：红色
                scoreClass = 'score-low';
                highlight = false;
            }
            
            // 显示分数而不是文字（保留2位小数）
            return { 
                value: score, 
                text: score.toFixed(2), 
                class: scoreClass, 
                highlight: highlight 
            };
        }

        async function loadExpirations() {
            const symbol = document.getElementById('symbol').value.toUpperCase().trim();
            if (!symbol) {
                alert(t('error.enterSymbol'));
                return;
            }

            showLoading();

            try {
                const data = await apiCall(`/expirations/${symbol}`);

                const expirySelect = document.getElementById('expiry');
                const previousValue = expirySelect.value; // 保存之前选中的值
                expirySelect.innerHTML = `<option value="">${t('form.selectExpiry')}</option>`;

                data.expirations.forEach(exp => {
                    const option = document.createElement('option');
                    option.value = exp.date;
                    option.textContent = `${exp.date} (${exp.period_tag === 'm' ? t('alert.monthly') : t('alert.weekly')})`;
                    expirySelect.appendChild(option);
                });

                // 如果之前有选中的到期日期，尝试恢复选中状态
                if (previousValue && data.expirations.some(exp => exp.date === previousValue)) {
                    expirySelect.value = previousValue;
                }
                
                // 检查是否可以启用查询按钮
                checkQueryButtonState();
                
                hideLoading();

            } catch (error) {
                showError(`${t('error.loadExpirations')}: ${error.message}`);
                hideLoading();
            }
        }

        // 检查查询按钮状态
        function checkQueryButtonState() {
            const symbol = document.getElementById('symbol').value.toUpperCase().trim();
            const expiry = document.getElementById('expiry').value;
            const tradeType = document.getElementById('tradeType').value;
            const queryBtn = document.getElementById('queryBtn');
            
            // 必须同时有股票代码、到期日期和交易类型才能查询
            if (symbol && expiry && tradeType && tradeType !== 'all') {
                queryBtn.disabled = false;
            } else {
                queryBtn.disabled = true;
            }
        }

        async function loadOptionChain() {
            const symbol = document.getElementById('symbol').value.toUpperCase().trim();
            const expiry = document.getElementById('expiry').value;
            const tradeType = document.getElementById('tradeType').value;

            if (!symbol || !expiry) {
                alert(t('error.selectExpiry'));
                return;
            }
            
            if (!tradeType || tradeType === 'all') {
                alert(t('error.selectTradeType'));
                return;
            }

            showLoading();

            try {
                const data = await apiCall(`/options/${symbol}/${expiry}`);

                // 应用筛选
                let filteredCalls = filterOptions(data.calls, tradeType);
                let filteredPuts = filterOptions(data.puts, tradeType);

                // 根据交易类型决定显示哪些表格
                const showCalls = tradeType === 'all' || tradeType === 'sell_call' || tradeType === 'buy_call';
                const showPuts = tradeType === 'all' || tradeType === 'sell_put' || tradeType === 'buy_put';

                // 更新结果标题
                document.getElementById('resultsTitle').textContent = `${data.symbol} ${t('results.title')}`;
                document.getElementById('resultsMeta').textContent =
                    `${t('meta.expiration')}: ${data.expiry_date} | ${showCalls ? filteredCalls.length : 0} ${t('meta.calls')} | ${showPuts ? filteredPuts.length : 0} ${t('meta.puts')}`;

                // 根据交易类型更新表格标题
                const callsTitle = document.getElementById('callsTitle');
                const putsTitle = document.getElementById('putsTitle');
                
                if (callsTitle) {
                    if (tradeType === 'sell_call') {
                        callsTitle.setAttribute('data-i18n', 'table.calls.title.quality');
                        callsTitle.textContent = t('table.calls.title.quality');
                    } else if (tradeType === 'buy_call') {
                        callsTitle.setAttribute('data-i18n', 'table.calls.title.growth');
                        callsTitle.textContent = t('table.calls.title.growth');
                    } else {
                        callsTitle.setAttribute('data-i18n', 'table.calls.title');
                        callsTitle.textContent = t('table.calls.title');
                    }
                }
                
                if (putsTitle) {
                    if (tradeType === 'sell_put') {
                        putsTitle.setAttribute('data-i18n', 'table.puts.title.value');
                        putsTitle.textContent = t('table.puts.title.value');
                    } else {
                        putsTitle.setAttribute('data-i18n', 'table.puts.title');
                        putsTitle.textContent = t('table.puts.title');
                    }
                }

                // 更新股票价格指示器
                const stockPrice = data.real_stock_price || data.stock_price || 'N/A';
                const priceDisplay = stockPrice !== 'N/A' ? `$${formatNumber(stockPrice)}` : 'N/A';
                document.getElementById('callsStockPrice').innerHTML = `<span data-i18n="table.current">${t('table.current')}</span>: ${priceDisplay}`;
                document.getElementById('putsStockPrice').innerHTML = `<span data-i18n="table.current">${t('table.current')}</span>: ${priceDisplay}`;

                // 显示/隐藏表格
                const callsSection = document.querySelector('.option-section.calls');
                const putsSection = document.querySelector('.option-section.puts');
                if (callsSection) callsSection.style.display = showCalls ? 'block' : 'none';
                if (putsSection) putsSection.style.display = showPuts ? 'block' : 'none';

                // 更新选项表格布局
                const optionTables = document.querySelector('.option-tables');
                if (optionTables) {
                    if (showCalls && showPuts) {
                        optionTables.style.gridTemplateColumns = '1fr 1fr';
                    } else {
                        optionTables.style.gridTemplateColumns = '1fr';
                    }
                }

                // 填充 CALL 期权表格
                const callsTable = document.getElementById('callsTable');
                callsTable.innerHTML = '';
                const callsStockPrice = parseFloat(data.real_stock_price || data.stock_price || 0);
                currentStockPrice = callsStockPrice; // 保存当前股票价格供事前验尸使用
                
                // 确定交易类型：根据筛选条件判断，默认推荐卖出策略
                let callTradeType = 'sell'; // 默认卖出（更安全）
                if (tradeType === 'buy_call') {
                    callTradeType = 'buy';
                } else if (tradeType === 'sell_call' || tradeType === 'all') {
                    callTradeType = 'sell';
                }
                
                // 应用排序
                const callsSortState = sortState.calls;
                if (callsSortState.column && callsSortState.direction) {
                    filteredCalls = sortOptions(filteredCalls, callsSortState.column, callsSortState.direction, callsStockPrice, 'call', callTradeType);
                }
                
                filteredCalls.forEach(option => {
                    const scores = option.scores || {};
                    const priceDiff = calculatePriceDiff(callsStockPrice, option.strike, 'call');
                    const recommendation = calculateRecommendation(option, scores, callsStockPrice, 'call', callTradeType);
                    const row = callsTable.insertRow();
                    // 如果特别推荐，添加高亮样式
                    if (recommendation.highlight) {
                        row.classList.add('recommended-row');
                    }
                    row.style.cursor = 'pointer';
                    row.onclick = () => showOptionDetailModal(option, scores, 'call', callsStockPrice, data.symbol, data.expiry_date);
                    row.innerHTML = `
                        <td class="strike sticky-col sticky-col-1">$${formatNumber(option.strike)}</td>
                        <td class="price sticky-col sticky-col-2">$${formatNumber(option.latest_price)}</td>
                        <td class="market-data sticky-col sticky-col-3">$${priceDiff}</td>
                        <td class="score sticky-col sticky-col-4 ${getAssignmentClass(scores.assignment_probability)}">${formatAssignmentPercent(scores.assignment_probability)}</td>
                        <td class="score ${getReturnClass(scores.annualized_return)}">${formatPercentDirect(scores.annualized_return, 1)}</td>
                        <td class="score">${formatCurrency(scores.margin_requirement)}</td>
                        <td class="market-data">$${formatNumber(option.bid_price)}</td>
                        <td class="market-data">$${formatNumber(option.ask_price)}</td>
                        <td class="score ${getScoreClass(scores.liquidity_factor, 'liq')}">${formatLiquidity(scores.liquidity_factor)}</td>
                        <td class="score ${recommendation.class} ${recommendation.highlight ? 'recommended-score' : ''}">${recommendation.text}分</td>
                    `;
                });

                // 填充 PUT 期权表格
                const putsTable = document.getElementById('putsTable');
                putsTable.innerHTML = '';
                const putsStockPrice = parseFloat(data.real_stock_price || data.stock_price || 0);
                if (!currentStockPrice) currentStockPrice = putsStockPrice; // 如果还没有设置，则保存
                
                // 确定交易类型：根据筛选条件判断，默认推荐卖出策略
                let putTradeType = 'sell'; // 默认卖出（更安全）
                if (tradeType === 'buy_put') {
                    putTradeType = 'buy';
                } else if (tradeType === 'sell_put' || tradeType === 'all') {
                    putTradeType = 'sell';
                }
                
                // 应用排序
                const putsSortState = sortState.puts;
                if (putsSortState.column && putsSortState.direction) {
                    filteredPuts = sortOptions(filteredPuts, putsSortState.column, putsSortState.direction, putsStockPrice, 'put', putTradeType);
                }
                
                filteredPuts.forEach(option => {
                    const scores = option.scores || {};
                    const priceDiff = calculatePriceDiff(putsStockPrice, option.strike, 'put');
                    const recommendation = calculateRecommendation(option, scores, putsStockPrice, 'put', putTradeType);
                    const row = putsTable.insertRow();
                    // 如果特别推荐，添加高亮样式
                    if (recommendation.highlight) {
                        row.classList.add('recommended-row');
                    }
                    row.style.cursor = 'pointer';
                    row.onclick = () => showOptionDetailModal(option, scores, 'put', putsStockPrice, data.symbol, data.expiry_date);
                    row.innerHTML = `
                        <td class="strike sticky-col sticky-col-1">$${formatNumber(option.strike)}</td>
                        <td class="price sticky-col sticky-col-2">$${formatNumber(option.latest_price)}</td>
                        <td class="market-data sticky-col sticky-col-3">$${priceDiff}</td>
                        <td class="score sticky-col sticky-col-4 ${getAssignmentClass(scores.assignment_probability)}">${formatAssignmentPercent(scores.assignment_probability)}</td>
                        <td class="score ${getReturnClass(scores.annualized_return)}">${formatPercentDirect(scores.annualized_return, 1)}</td>
                        <td class="score">${formatCurrency(scores.margin_requirement)}</td>
                        <td class="market-data">$${formatNumber(option.bid_price)}</td>
                        <td class="market-data">$${formatNumber(option.ask_price)}</td>
                        <td class="score ${getScoreClass(scores.liquidity_factor, 'liq')}">${formatLiquidity(scores.liquidity_factor)}</td>
                        <td class="score ${recommendation.class} ${recommendation.highlight ? 'recommended-score' : ''}">${recommendation.text}分</td>
                    `;
                });

                document.getElementById('results').style.display = 'block';
                hideLoading();

                // Initialize table features (horizontal scroll support)
                initializeTableFeatures();
                
                // Initialize sorting functionality
                initializeSorting();
                
                // 更新排序图标状态
                if (sortState.calls.column) {
                    updateSortIcons('calls', sortState.calls.column, sortState.calls.direction);
                }
                if (sortState.puts.column) {
                    updateSortIcons('puts', sortState.puts.column, sortState.puts.direction);
                }

            } catch (error) {
                showError(`${t('error.loadOptions')}: ${error.message}`);
            }
        }

        // Initialize with AAPL data on page load
        window.addEventListener('load', () => {
            // 自动加载默认股票代码的到期日期
            loadExpirations();
            // Setup improved scrolling early
            setupImprovedScrolling();
        });

        // 输入股票代码后，失焦时自动加载到期日期（不自动查询）
        document.getElementById('symbol').addEventListener('blur', () => {
            const symbol = document.getElementById('symbol').value.toUpperCase().trim();
            if (symbol) {
                loadExpirations();
            } else {
                checkQueryButtonState();
            }
        });

        // 允许 Enter 键加载到期日期
        document.getElementById('symbol').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.target.blur(); // 触发失焦事件，自动加载日期
            }
        });

        // 选择到期日期后，检查查询按钮状态（不自动查询）
        document.getElementById('expiry').addEventListener('change', () => {
            checkQueryButtonState();
        });
        
        // 选择交易类型后，检查查询按钮状态
        document.getElementById('tradeType').addEventListener('change', () => {
            checkQueryButtonState();
        });

        // Enable Shift+scroll for horizontal scrolling on tables
        function enableHorizontalScroll() {
            // Use setTimeout to ensure DOM is fully rendered
            setTimeout(() => {
                const tableContainers = document.querySelectorAll('.table-container');
                console.log('Found table containers:', tableContainers.length);

                tableContainers.forEach((container, index) => {
                    console.log(`Setting up container ${index}:`, container);

                    // Remove any existing listeners to avoid duplicates
                    container.removeEventListener('wheel', container._wheelHandler);

                    // Create the wheel handler function
                    container._wheelHandler = (e) => {
                        console.log('Wheel event:', e.shiftKey, e.deltaY, e.deltaX);

                        // Always handle Shift+scroll for horizontal scrolling
                        if (e.shiftKey) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Shift+scroll detected, scrolling horizontally');
                            container.scrollLeft += e.deltaY;
                            return false;
                        }

                        // Also handle natural horizontal scroll
                        if (Math.abs(e.deltaX) > 0) {
                            container.scrollLeft += e.deltaX;
                        }
                    };

                    // Add the wheel event listener
                    container.addEventListener('wheel', container._wheelHandler, { passive: false });

                    // Add visual feedback
                    container.addEventListener('mouseenter', () => {
                        if (container.scrollWidth > container.clientWidth) {
                            container.style.cursor = 'grab';
                            container.title = 'Hold Shift and scroll to scroll horizontally';
                        }
                    });

                    container.addEventListener('mouseleave', () => {
                        container.style.cursor = 'default';
                        container.title = '';
                    });

                    console.log(`Container ${index} setup complete`);
                });
            }, 100);
        }

        // Improved horizontal scroll handling
        let scrollHandlerSetup = false;
        function setupImprovedScrolling() {
            if (scrollHandlerSetup) return;
            scrollHandlerSetup = true;

            console.log('Setting up improved scroll handlers');

            document.addEventListener('wheel', (e) => {
                // Check if Shift key is pressed
                if (e.shiftKey) {
                    // Find the closest table container
                    let target = e.target;
                    let tableContainer = null;

                    while (target && target !== document) {
                        if (target.classList && target.classList.contains('table-container')) {
                            tableContainer = target;
                            break;
                        }
                        target = target.parentElement;
                    }

                    // If we found a table container, handle horizontal scroll
                    if (tableContainer) {
                        e.preventDefault();
                        e.stopPropagation();

                        // Apply horizontal scroll immediately
                        const scrollAmount = e.deltaY > 0 ? 100 : -100;
                        tableContainer.scrollLeft += scrollAmount;

                        return false;
                    }
                }

                // Also handle horizontal scroll on table containers without Shift
                let target = e.target;
                let tableContainer = null;

                while (target && target !== document) {
                    if (target.classList && target.classList.contains('table-container')) {
                        tableContainer = target;
                        break;
                    }
                    target = target.parentElement;
                }

                if (tableContainer && Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
                    e.preventDefault();
                    tableContainer.scrollLeft += e.deltaX;
                    return false;
                }
            }, { passive: false });

            console.log('Improved scroll handler setup complete');
        }

        // Call this function after tables are populated
        function initializeTableFeatures() {
            setupImprovedScrolling();
        }

        function setupScrollIndicators() {
            setTimeout(() => {
                const containers = ['callsTableContainer', 'putsTableContainer'];
                const types = ['calls', 'puts'];

                containers.forEach((containerId, index) => {
                    const container = document.getElementById(containerId);
                    const tableType = types[index];

                    if (container) {
                        // Make container focusable for keyboard navigation
                        container.setAttribute('tabindex', '0');

                        // Initial indicator update
                        updateScrollIndicator(tableType);

                        // Add scroll event listener for real-time updates
                        container.addEventListener('scroll', () => {
                            updateScrollIndicator(tableType);
                        });

                        // Add keyboard navigation
                        container.addEventListener('keydown', (e) => {
                            if (e.key === 'ArrowLeft') {
                                e.preventDefault();
                                scrollTable(tableType, -100);
                            } else if (e.key === 'ArrowRight') {
                                e.preventDefault();
                                scrollTable(tableType, 100);
                            }
                        });

                        // Visual focus indicator
                        container.addEventListener('focus', () => {
                            container.style.outline = '2px solid hsl(178, 78%, 32%)';
                        });

                        container.addEventListener('blur', () => {
                            container.style.outline = 'none';
                        });

                        console.log(`Scroll indicators setup for ${tableType}`);
                    }
                });
            }, 200);
        }
    </script>
</body>
</html>