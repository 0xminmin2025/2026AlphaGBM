# 股票研究报告生成逻辑详细文档

本文档详细说明 AlphaGBM 系统生成股票投资研究报告的完整逻辑和流程。

## 📋 目录

- [整体流程概述](#整体流程概述)
- [第一阶段：数据获取](#第一阶段数据获取)
- [第二阶段：量化分析](#第二阶段量化分析)
- [第三阶段：AI报告生成](#第三阶段ai报告生成)
- [报告结构与内容](#报告结构与内容)
- [特殊场景处理](#特殊场景处理)
- [错误处理与降级策略](#错误处理与降级策略)

---

## 整体流程概述

股票研究报告生成是一个**多阶段、多数据源、多模型融合**的复杂流程，主要分为三个阶段：

```
用户请求 → 数据获取 → 量化分析 → AI报告生成 → 返回结果
```

### 核心流程

1. **用户请求验证** (`app.py: /api/analyze`)
   - 用户身份验证（JWT）
   - 查询次数限制检查
   - 参数验证（ticker, style）

2. **数据获取阶段** (`analysis_engine.py: get_market_data()`)
   - 股票代码标准化
   - 基础市场数据获取
   - 宏观经济数据获取
   - 期权市场数据获取
   - 中国市场情绪数据获取（A股/港股）

3. **量化分析阶段** (`analysis_engine.py`)
   - 风险评分计算 (`analyze_risk_and_position()`)
   - 市场情绪评分计算 (`calculate_market_sentiment()`)
   - 目标价格计算 (`calculate_target_price()`)
   - 动态止损价格计算 (`calculate_atr_stop_loss()`)
   - EV模型计算 (`ev_model.py: calculate_ev_model()`)

4. **AI报告生成阶段** (`ai_service.py: get_gemini_analysis()`)
   - Prompt构建
   - Gemini AI调用
   - 报告格式化

5. **结果返回**
   - 数据序列化
   - 数据库记录
   - JSON响应

---

## 第一阶段：数据获取

### 1.1 股票代码标准化

**函数**: `analysis_engine.py: normalize_ticker()`

**识别规则**：

```python
# 优先级顺序：
1. 港股：4-5位数字 → 添加 .HK（去掉前导0）
   - 输入 09988 或 9988 → 标准化为 9988.HK
   - 输入 02525 或 2525 → 标准化为 2525.HK

2. A股上海：6位数字，600/601/603/688开头 → 添加 .SS
   - 输入 600519 → 标准化为 600519.SS

3. A股深圳：6位数字，000/001/002/300开头 → 添加 .SZ
   - 输入 000001 → 标准化为 000001.SZ

4. 美股：默认不加后缀
   - 输入 AAPL → 保持 AAPL
```

**特殊处理**：
- 港股代码必须去掉前导0（yfinance要求）
- 支持多种输入格式（带/不带后缀）
- 自动识别市场类型

### 1.2 基础市场数据获取

**函数**: `analysis_engine.py: get_market_data()`

**数据源**：
- **主要数据源**: Yahoo Finance (yfinance)
- **备用数据源**: Alpha Vantage（仅美股，当yfinance失败时）

**获取的数据**：

#### 1.2.1 价格数据
- 当前价格 (`price`)
- 52周最高价 (`week52_high`)
- 52周最低价 (`week52_low`)
- 历史价格数据（用于技术分析）

#### 1.2.2 财务指标
- 市盈率 PE (`pe`)
- 远期PE (`forward_pe`)
- PEG比率 (`peg`)
- 营收增长率 (`growth`)
- 利润率 (`margin`)
- 市值 (`market_cap`)

#### 1.2.3 技术指标
- 50日均线 MA50 (`ma50`)
- 200日均线 MA200 (`ma200`)
- 成交量数据
- 成交量异常检测 (`volume_anomaly`)

#### 1.2.4 公司信息
- 公司名称 (`name`)
- 业务描述 (`description`)
- 行业分类 (`sector`, `industry`)
- 最新新闻（最多5条）

#### 1.2.5 事件数据

**财报日期** (`earnings_dates`) - **⚠️ 波动率事件（Binary Event）**

财报日期是极其重要的**二元事件（Binary Event）**风险点，必须在数据获取阶段高亮显示。

**数据获取要求**：
- 获取未来财报发布日期列表
- 计算距离当前日期的天数（倒计时）
- 标记为"波动率事件"类型

**倒计时预警逻辑**：
- **< 7天（高危）**：财报即将发布，波动率风险极高
  - 系统应高亮显示，标记为红色警告
  - 在风险评分中增加额外风险分（+1分）
  - 在AI报告中强制提示避险建议
- **7-14天（中危）**：财报临近，需要关注
  - 系统应标记为黄色提醒
  - 在AI报告中提示提前规划
- **> 14天（低危）**：财报较远，正常显示

**数据展示要求**：
- 在数据获取阶段，财报日期必须独立显示
- 显示格式：`财报日期: YYYY-MM-DD (X天后) [高危/中危/低危]`
- 高危财报日期必须在数据顶部高亮显示

**期权到期日**（从宏观经济数据获取）

**数据获取优化**：
- 支持重试机制（默认3次，指数退避）
- ETF数据获取时抑制不必要的ERROR日志
- 自动处理网络错误和速率限制
- 自动切换备用数据源

### 1.3 宏观经济数据获取

**函数**: `analysis_engine.py: get_market_data()` → 内部调用

**获取的宏观指标**：

#### 1.3.1 利率与流动性指标
- **10年期美债收益率** (`treasury_10y`)
  - 数据源：`^TNX`
  - 用途：反映市场对利率和通胀的预期，影响成长股估值

#### 1.3.2 汇率指标
- **美元指数** (`dxy`)
  - 数据源：`DX-Y.NYB` 或 `^DXY`
  - 用途：反映美元强弱，影响全球流动性和新兴市场

#### 1.3.3 商品价格
- **黄金价格** (`gold`)
  - 数据源：`GC=F`
  - 用途：避险情绪指标

- **原油价格** (`oil`)
  - 数据源：`CL=F`
  - 用途：通胀和经济增长预期

#### 1.3.4 重要经济事件

**🇺🇸 美国经济事件**：
- **美联储利率决议** (`fed_meetings`)
  - 包含点阵图信息
  - 距离当前天数
  - 影响：直接影响市场流动性和风险偏好

- **美国CPI数据发布** (`cpi_releases`)
  - 数据月份
  - 距离当前天数
  - 影响：通胀预期和货币政策

**🇨🇳 中国经济事件** (`china_events`)：
- GDP数据发布
- PMI数据发布
- 央行利率决议
- 其他重要经济指标

**🌍 其他国家**：
- 其他重要经济事件（可扩展）

**期权到期日** (`options_expirations`)：
- 月度期权到期日
- 季度期权到期日（四重到期日）
- 影响：市场级别的波动性风险

**地缘政治风险指数** (`geopolitical_risk`)：
- 0-10分风险评分
- 影响：市场避险情绪

### 1.4 期权市场数据获取

**函数**: `analysis_engine.py: get_options_market_data()`

**获取的数据**：

- **VIX恐慌指数** (`vix`)
  - 数据源：`^VIX`
  - 用途：市场波动率指标，反映恐慌情绪
  - 危险阈值：VIX > 30（极高恐慌）

- **Put/Call比率** (`put_call_ratio`)
  - 用途：看跌/看涨期权持仓量比率
  - 危险阈值：P/C > 1.2（极度看跌）

- **期权到期日** (`options_expirations`)
  - 用途：识别市场级别的波动性风险

**风险提示**：
- VIX > 30：存在Vanna crush风险（波动率下降时做市商需要调整对冲）
- Put/Call > 1.2：负Gamma风险（价格下跌时需要卖出更多标的资产对冲）

### 1.5 中国市场情绪数据获取（A股/港股专用）

**函数**: `china_sentiment.py: get_china_sentiment_data()`

**数据源**: AkShare

**获取的数据**：

#### 1.5.1 个股新闻与舆情
- 最新政策和舆情（东方财富）
- 新闻关键词提取

#### 1.5.2 资金流向
- **主力资金流向** (`main_fund_flow`)
  - 主力/散户资金净流入/流出
  - 影响情绪评分：±1.5-2.0分

#### 1.5.3 龙虎榜数据
- 游资炒作热度（投机情绪）
- 上榜理由、买入额、卖出额
- 影响情绪评分：±1.0-1.5分

#### 1.5.4 宏观政策信号
- 政策风向标（财联社）
- 关键词识别（国务院、央行、证监会等）
- 影响情绪评分：±2.0分（权重最高）

**中国市场特殊规则**：
- **政策 > 一切** (Policy is King)
- 政策面权重 > 基本面权重
- 如果出现"国务院印发"、"央行宣布"级别新闻，政策权重应高于P/E估值

### 1.6 IPO与解禁监控

**函数**: `analysis_engine.py: get_ipo_lockup_data()`

**重要性**：次新股解禁期（Lock-up Period）结束通常伴随着巨大的抛压，是重要的供给侧冲击风险点。

#### 1.6.1 美股/港股逻辑

**数据获取方法**：
- 从Yahoo Finance获取IPO日期（`ipoDate`字段）
- 采用 **"IPO日期 + 180天"** 的规则进行推算
- 美股通常是标准的180天锁定期
- 港股通常是6个月（约180天）锁定期

**计算逻辑**：
```python
# 获取IPO日期
ipo_date = info.get('ipoDate')  # 格式：YYYY-MM-DD

# 计算解禁日期
if ipo_date:
    from datetime import datetime, timedelta
    ipo_dt = datetime.strptime(ipo_date, '%Y-%m-%d').date()
    lockup_expiry_date = ipo_dt + timedelta(days=180)
    
    # 计算距离解禁期的天数
    today = datetime.now().date()
    days_until_lockup = (lockup_expiry_date - today).days
```

**返回数据**：
- `ipo_date`: IPO日期
- `lockup_expiry_date`: 解禁日期
- `days_until_lockup`: 距离解禁期的天数
- `is_lockup_risk`: 是否处于解禁风险期（< 14天）

#### 1.6.2 A股逻辑

**数据获取方法**：
- 使用 **AkShare** 数据抓取（A股规则复杂）
- A股解禁规则包括：
  - **1年期解禁**：IPO原始股东锁定期1年
  - **3年期解禁**：IPO原始股东锁定期3年
  - **定增解禁**：定向增发股份解禁（通常6个月或1年）
  - **限售股解禁**：其他限售股解禁

**数据源**：
- AkShare接口：`ak.stock_restricted_shares_summary_em()`（限售股解禁汇总）
- 或：`ak.stock_ipo_info()`（IPO信息）

**计算逻辑**：
```python
# A股解禁数据获取（使用AkShare）
import akshare as ak

# 获取限售股解禁数据
lockup_data = ak.stock_restricted_shares_summary_em(stock_code)

# 解析解禁日期和解禁股数
for item in lockup_data:
    expiry_date = item['解禁日期']
    lockup_shares = item['解禁股数']
    # 计算距离解禁期的天数
    days_until = calculate_days_until(expiry_date)
```

**返回数据**：
- `lockup_events`: 解禁事件列表（包含日期、股数、类型）
- `next_lockup_date`: 最近一次解禁日期
- `days_until_lockup`: 距离最近解禁期的天数
- `lockup_shares_ratio`: 解禁股数占总股本比例
- `is_lockup_risk`: 是否处于解禁风险期（< 14天）

#### 1.6.3 风控联动

**供给侧冲击警告触发条件**：
- 距离解禁期 < 14天：系统自动触发 **"供给侧冲击警告"**
- 警告级别：
  - **< 7天（高危）**：解禁即将到来，抛压风险极高
  - **7-14天（中危）**：解禁临近，需要关注

**风险评分联动**：
- 距离解禁期 < 14天：风险评分 +1.5分
- 距离解禁期 < 7天：风险评分 +2.5分
- 添加风险标志："解禁期风险：解禁将在X天后到来，可能面临巨大抛压"

**数据展示要求**：
- 在数据获取阶段，解禁日期必须独立显示
- 显示格式：`解禁日期: YYYY-MM-DD (X天后) [高危/中危]`
- 高危解禁日期必须在数据顶部高亮显示
- A股需要显示解禁股数和占总股本比例

---

## 第二阶段：量化分析

### 2.1 风险评分计算

**函数**: `analysis_engine.py: analyze_risk_and_position()`

**评分范围**: 0-10分（分数越高，风险越大）

**评分维度**：

#### 2.1.1 基本面风险（B维度）

**营收增长风险**：
- 营收增长率 < 0%：+3分（营收衰退）
- 营收增长率 < 5%：+1分（增长缓慢）

**盈利能力风险**：
- 利润率 < 5%：+2分（薄利/亏损）
- 利润率 < 10%：+1分（盈利能力弱）

**估值风险**：
- PEG > 2.5：+1分（估值过高）
- PE > 40（成长股）或 PE > 25（价值股）：+1分

**债务风险**：
- 债务权益比 > 1.0：+2分（高杠杆）

#### 2.1.2 技术面风险

**价格位置风险**：
- 价格位置 > 80%（52周区间）：+1分（追高风险）
- 价格位置 < 20%（52周区间）：+0.5分（超卖，但可能是机会）

**趋势风险**：
- 价格 < MA200：+1分（长期空头趋势）
- 价格 < MA50：+0.5分（短期空头趋势）

**成交量异常**：
- 成交量异常萎缩：+1分（流动性风险）

**财报日风险**：
- 财报日期 < 7天（高危）：+1分（财报前波动率风险）
- 财报日期 7-14天（中危）：+0.5分（财报临近风险）

**解禁期风险（供给侧冲击）**：
- 距离解禁期 < 7天（高危）：+2.5分（解禁即将到来，抛压风险极高）
- 距离解禁期 7-14天（中危）：+1.5分（解禁临近，可能面临抛压）
- 风险标志："解禁期风险：解禁将在X天后到来，可能面临巨大抛压"

#### 2.1.3 市场情绪风险（M维度）

**VIX恐慌指数**：
- VIX > 30：+2分（极高恐慌）
- VIX > 25：+1分（高恐慌）

**Put/Call比率**：
- P/C > 1.5：+2分（极度看跌）
- P/C > 1.2：+1分（看跌情绪强烈）

#### 2.1.4 宏观风险

**利率环境**：
- 美债收益率 > 4.5%：+1分（高利率环境，对成长股不利）

**地缘政治风险**：
- 地缘政治风险指数 >= 7：+2分（极高风险）
- 地缘政治风险指数 >= 6：+1分（高风险）

#### 2.1.5 风险等级分类

```python
if risk_score < 3:
    risk_level = "低"
elif risk_score < 6:
    risk_level = "中"
elif risk_score < 8:
    risk_level = "高"
else:
    risk_level = "极高"
```

**熔断规则**：
- 风险评分 >= 6：不建议建仓（`suggested_position = 0%`）
- 风险评分 >= 8：强烈不建议建仓

### 2.2 仓位建议计算

**函数**: `analysis_engine.py: analyze_risk_and_position()`

**基础仓位上限**（根据投资风格）：

| 投资风格 | 最大仓位 | 说明 |
|---------|---------|------|
| Quality | 20% | 财务稳健，适合长期持有 |
| Value | 10% | 低估值，追求安全边际 |
| Growth | 15% | 高增长，容忍较高估值 |
| Momentum | 5% | 快进快出，高风险 |

**仓位计算公式**：

```python
# 基础仓位
base_position = {
    'quality': 20,
    'value': 10,
    'growth': 15,
    'momentum': 5
}[style]

# 风险调整
if risk_score >= 6:
    suggested_position = 0  # 熔断
elif risk_score >= 4:
    suggested_position = base_position * 0.5  # 减半
elif risk_score >= 2:
    suggested_position = base_position * 0.75  # 减少25%
else:
    suggested_position = base_position  # 满仓
```

### 2.3 市场情绪评分计算

**函数**: `analysis_engine.py: calculate_market_sentiment()`

**评分范围**: 0-10分（分数越高，市场情绪越乐观）

**评分维度**：

#### 2.3.1 技术面情绪（权重：30%）

**趋势指标**：
- 价格 > MA50 > MA200：+2分（多头排列）
- 价格 < MA200：-2分（长期空头）

**价格位置**：
- 价格位置 < 30%：+1分（超卖反弹机会）
- 价格位置 > 70%：-1分（追高风险）

#### 2.3.2 估值情绪（权重：30%）

**PE估值**：
- PE < 15：+2分（估值偏低）
- PE > 40：-2分（估值过高）

**PEG估值**：
- PEG < 1.0：+1.5分（增长匹配估值）
- PEG > 2.0：-1.5分（估值过高）

#### 2.3.3 期权市场情绪（权重：20%）

**VIX恐慌指数**：
- VIX < 15：+1.5分（市场平静）
- VIX > 30：-2.0分（极高恐慌）

**Put/Call比率**：
- P/C < 0.8：+1.0分（看涨情绪）
- P/C > 1.2：-1.5分（看跌情绪强烈）

#### 2.3.4 宏观经济情绪（权重：20%）

**美债收益率**：
- 美债收益率 < 2%：+1.0分（低利率环境）
- 美债收益率 > 4.5%：-1.0分（高利率环境）

**美元指数**：
- 美元指数走强：-0.5分（资金流出新兴市场）

#### 2.3.5 中国市场情绪（A股/港股专用，权重：40%）

**混合计算**：
- 60%传统指标 + 40%中国市场指标

**中国市场情绪评分调整**：
- 主力资金大幅净流入：+1.5-2.0分
- 主力资金大幅净流出：-1.5-2.0分
- 政策面利好：+2.0分（权重最高）
- 政策面利空：-2.0分（权重最高）
- 龙虎榜游资炒作：+1.0-1.5分
- 龙虎榜游资出货：-1.0-1.5分

### 2.4 目标价格计算

**函数**: `analysis_engine.py: calculate_target_price()`

**计算方法**：多维度估值模型

#### 2.4.1 PEG估值法（优先）

**适用条件**：
- PEG数据可用
- PEG > 0 且 PEG < 3.0

**计算公式**：

```python
# 基础目标价格
target_price_peg = current_price * (1 + growth_rate) / peg_ratio

# 如果当前价格已经超过目标价格，调整为目标价格的95%（止盈参考点）
if current_price >= target_price_peg:
    original_target_price = target_price_peg
    target_price = current_price * 0.95  # 止盈参考点
else:
    target_price = target_price_peg
```

#### 2.4.2 增长率折现法（备用）

**适用条件**：
- PEG数据不可用
- 营收增长率 > 0

**计算公式**：

```python
# 增长率折现
growth_discount_factor = 0.6  # 保守折现
target_price_growth = current_price * (1 + growth_rate * growth_discount_factor)
```

#### 2.4.3 技术面分析（辅助）

**适用条件**：
- 52周高点可用

**计算公式**：

```python
# 基于52周高点
target_price_technical = week52_high * 0.9  # 保守估计
```

#### 2.4.4 最终目标价格

```python
# 优先级：PEG估值 > 增长率折现 > 技术面分析
if peg_available:
    target_price = target_price_peg
elif growth_rate > 0:
    target_price = target_price_growth
else:
    target_price = target_price_technical

# 风险调整：如果风险过高，目标价格 = 当前价格（不建议买入）
if risk_score >= 6:
    target_price = current_price
```

#### 2.4.5 目标价格周期定义

**周期定义：6-12个月的中期目标价**

**周期说明**：
- **华尔街标准**：基于基本面（PEG/PE）的目标价，华尔街的标准通常是**12个月**
- **AlphaGBM模型调整**：考虑到模型结合了**动量（M）**维度，我们将目标价周期定义为**"6-12个月的中期目标价"**

**周期合理性**：
- **3-6个月太短**：容易受短期噪音影响，不适合基本面价值回归
- **基本面价值回归**：通常需要**2个季度以上**的验证周期
- **动量因素**：结合动量（M）维度后，价值回归可能更快，但至少需要6个月验证

**使用建议**：
- 在AI报告中必须明确说明："本目标价格为6-12个月的中期目标价"
- 提醒投资者：目标价不是短期交易信号，而是基于基本面价值回归的中期预期
- 如果当前价格已经接近或超过目标价，需要重新评估基本面变化

### 2.5 动态止损价格计算

**函数**: `analysis_engine.py: calculate_atr_stop_loss()`

**计算方法**：基于ATR（Average True Range）的动态止损

#### 2.5.1 ATR计算

```python
# 计算True Range
tr = max(
    high - low,
    abs(high - prev_close),
    abs(low - prev_close)
)

# 计算ATR（14周期）
atr = sma(tr, period=14)
```

#### 2.5.2 止损价格计算

```python
# 基础止损价格
atr_multiplier = 2.5  # 默认倍数
stop_loss_price = buy_price - (atr * atr_multiplier)

# Beta调整（高Beta股票需要更宽的止损）
if beta > 1.5:
    atr_multiplier = 3.0
elif beta < 0.8:
    atr_multiplier = 2.0

# 最小止损幅度（5%）
min_stop_loss_pct = 0.05
min_stop_loss_price = buy_price * (1 - min_stop_loss_pct)

# 最终止损价格（取更保守的）
stop_loss_price = max(stop_loss_price, min_stop_loss_price)
```

#### 2.5.3 固定止损（降级方案）

**适用条件**：
- ATR数据不足（历史数据 < 15天）
- ATR计算失败

**计算公式**：

```python
# 固定15%止损
stop_loss_price = current_price * 0.85
stop_loss_method = '固定15%止损（数据不足）'
```

### 2.6 EV模型计算

**函数**: `ev_model.py: calculate_ev_model()`

**用途**：短期波动风险评估（1周至3个月）

**计算内容**：

- **加权期望值** (`ev_weighted_pct`)
  - 基于风险评分、市场情绪、技术面的综合期望值
  - 范围：-100% 到 +100%

- **短期概率分布** (`ev_1week`)
  - 上涨概率 (`prob_up`)
  - 下跌概率 (`prob_down`)

- **风险评估** (`recommendation`)
  - 操作建议（BUY/HOLD/SELL）
  - 置信度（high/medium/low）
  - 原因说明

**使用场景**：
- 对于Quality/Value风格：短期波动不应过度影响核心决策，但需要作为风险提示
- 对于Growth/Momentum风格：需要重点关注短期风险指标

---

## 第三阶段：AI报告生成

### 3.1 报告生成流程

**函数**: `ai_service.py: get_gemini_analysis()`

**流程**：

1. **检查AI可用性**
   - 如果Gemini API不可用，使用备用分析 (`get_fallback_analysis()`)

2. **构建Prompt**
   - 根据投资风格构建不同的Prompt模板
   - 针对ETF和普通股票使用不同的分析框架

3. **调用Gemini AI**
   - 模型：`gemini-1.5-flash`
   - 生成Markdown格式报告

4. **格式化输出**
   - 确保报告结构完整
   - 验证必需部分是否存在

### 3.2 Prompt构建逻辑

#### 3.2.1 基础Prompt结构

**普通股票Prompt**：

```
你是一位精通"AlphaGBM投资模型(G=B+M)"和"五大支柱投资框架"的资深基金经理。

### 重要：投资风格与原则
- 当前投资风格：[style]
- 风格核心原则：[style_principles]
- 仓位限制：[suggested_position]%

### 1. 上下文数据
- 当前价格、52周区间
- 基本面数据（营收增长、利润率、PE、PEG）
- 技术面数据（MA50、MA200）
- 系统风控评分
- 主要风险点

### 2. 宏观经济环境
- 美债收益率、美元指数、黄金、原油
- 重要经济事件（美联储会议、CPI发布）
- 期权到期日
- 地缘政治风险

### 3. 中国市场特有情绪面（A股/港股）
- 最新政策与舆情
- 主力资金流向
- 龙虎榜数据
- 宏观政策风向
- 情绪评分调整

### 4. 期权市场数据
- VIX恐慌指数
- Put/Call比率
- 期权市场风险提示

### 5. 成交量异常
- 成交量异常放大/萎缩

### 6. 财报日期（⚠️ 波动率事件 - Binary Event）
- 未来财报发布日期列表
- 距离当前日期的天数（倒计时）
- 预警级别（<7天高危 / 7-14天中危 / >14天低危）
- **重要提示**：财报日期是二元事件风险点，必须在交易策略中强制检查避险
```

#### 3.2.2 ETF专用Prompt

**特殊说明**：
- ETF不适用公司财务指标（营收、利润、PE等）
- 分析重点：跟踪标的指数、跟踪误差、管理费率、流动性
- 杠杆ETF需要特别标注风险

#### 3.2.3 中国市场Prompt增强

**特殊规则**：
- **政策 > 一切** (Policy is King)
- 政策面权重 > 基本面权重
- 如果出现"国务院印发"、"央行宣布"级别新闻，政策权重应高于P/E估值
- 关键词触发器："印发"、"规划"、"立案调查"等

### 3.3 报告结构要求

**AI必须严格按照以下7个部分输出**：

1. **## 第一部分：投资风格与原则重申**
   - 重申当前投资风格
   - 说明风格核心原则
   - 强调仓位限制

2. **## 第二部分：公司概况（必须包含）**
   - **公司业务介绍**（不超过4句话）
   - **最新动态**（3-5条重要新闻）
   - 即使系统未提供新闻数据，也要说明"当前无法获取到最新新闻动态"

3. **## 第三部分：AlphaGBM (G=B+M) 深度解构**
   - **G (价格差异)**: 当前价格相对于内在价值是便宜还是贵？结合52周区间分析价格位置
   - **B (基本面)**: 营收增长、利润率、财务健康状况
   - **M (动量)**: 市场情绪、估值水平、技术面趋势

4. **## 第四部分：五大支柱检查**
   - **怀疑主义 (Skepticism)**: 充当"空头律师"，列出2-3个如果不买这只股票的理由
   - **事前验尸 (Pre-mortem)**: 假设买入后一年亏损50%，最可能的原因是什么？

5. **## 第四.五部分：风险控制评估（必须包含）**
   - **风险评分**: 系统综合评估风险评分 X/10 (等级: Y)
   - **主要风险因素**: 列出所有风险点
   - **短期波动风险（基于量化模型）**:
     - 加权期望值
     - 风险评估
     - 短期概率分布（上涨概率/下跌概率）
     - 投资风格说明
   - **风险控制建议**: 2-3条具体建议（仓位限制、止损设置、退出条件）

6. **## 第五部分：估值分析与交易策略（必须包含）**
   - **估值分析**:
     - 基于PE、PEG、增长率等指标的估值评估
     - 目标价格的计算依据和合理性
     - 当前价格相对于合理估值的偏离程度
     - **宏观环境对估值的影响**（美债收益率、美元指数、VIX等如何影响估值）
   - **交易策略**:
     - **操作建议**: 明确给出（强力买入/分批建仓/观望/减仓/卖出）
       - 重要：必须考虑当前价格与目标价格的关系
       - 如果当前价格 >= 目标价格：绝对不能建议"增持"或"买入"
       - 如果当前价格 >= 目标价格 * 1.2：强烈建议"卖出"锁定利润
     - **目标价格**: 系统计算的目标价格，说明合理性
       - **⚠️ 周期定义**：必须明确说明"本目标价格为6-12个月的中期目标价"
       - 提醒投资者：目标价不是短期交易信号，而是基于基本面价值回归的中期预期
     - **止损价格**: 系统计算的止损价格（ATR动态止损或固定15%止损），说明合理性
     - **建仓策略**: 详细说明如何建仓（一次性/分批，分批的话分几批，每批多少，时间间隔）
     - **持有周期**: 根据投资风格建议持有多长时间
     - **仓位管理**: 重申建议仓位，说明仓位管理原则
     - **⚠️ 财报日避险检查（强制规则）**:
       - 如果财报日期 < 7天（高危）：**强烈建议在财报前3天避险或减仓**
         - 理由：财报是二元事件，可能导致大幅波动，建议提前避险
       - 如果财报日期 7-14天（中危）：**建议提前规划，考虑在财报前适当减仓**
       - 如果财报日期 > 14天（低危）：**正常持有，但需关注财报日期**
       - **避险规则**：财报前3天建议减仓30-50%，或全部卖出避险，待财报后再决定是否重新建仓
       - **例外情况**：如果基本面非常强劲且预期财报利好，可以保留部分仓位，但必须设置止损

7. **## 第六部分：卖出策略（⚠️ 必须包含，最重要的风险控制部分）**
   - **止盈策略**:
     - 当前价格与目标价格的关系
     - 当价格达到目标价格时如何操作（一次性卖出/分批卖出）
     - 如果当前价格 >= 目标价格：立即评估是否需要止盈或减仓
     - 根据投资风格给出具体的止盈点建议
   - **止损策略**:
     - 系统已设置的止损价格和止损幅度
     - 解释止损价格的合理性
     - 是否需要在止损前设置预警点
     - 严格执行止损的纪律说明
   - **分阶段卖出策略**:
     - 如果采用分批建仓，对应的分批卖出策略
     - 建议在什么价位分阶段减仓（例如：达到目标价格的80%/100%/120%分别卖出多少比例）
     - 根据投资风格的持有周期，何时应该完全退出
   - **特殊情况卖出**:
     - 基本面恶化（营收负增长、利润率大幅下降）时如何应对
     - 估值过高（PE异常升高）时是否提前卖出
     - 市场情绪变化（VIX飙升、市场系统性风险）时如何调整
   - **卖出时机建议**:
     - **⚠️ 财报日避险（强制规则）**：
       - **财报前3天强制检查**：如果财报日期 < 7天，必须评估是否在财报前3天避险
       - **避险建议**：
         - 如果财报日期 < 7天（高危）：**强烈建议在财报前3天减仓30-50%或全部卖出避险**
         - 如果财报日期 7-14天（中危）：**建议提前规划，考虑在财报前适当减仓**
         - 如果财报日期 > 14天（低危）：**正常持有，但需关注财报日期**
       - **避险理由**：财报是二元事件（Binary Event），可能导致大幅波动，提前避险是风险控制的核心
       - **例外情况**：如果基本面非常强劲且预期财报利好，可以保留部分仓位，但必须设置止损
     - 避免在期权到期日附近卖出（市场波动可能影响成交价格）
     - 根据重要经济事件（美联储会议、CPI发布等）调整卖出时机
   - **风险规避原则**:
     - 严格执行止损，不要因为"再等等"而犹豫
     - 达到目标价格后，根据投资风格决定是全部卖出还是分批卖出
     - 如果市场出现系统性风险（VIX>30、地缘政治风险>7），建议提前减仓或全部卖出
     - 如果基本面恶化（营收转负、利润率大幅下降），立即卖出，不要等待
     - 如果估值过高（PE超过合理范围50%以上），考虑提前卖出锁定利润

**⚠️ 特别强调**：
- 卖出策略必须具体、可执行，不能使用"根据情况决定"、"灵活调整"等模糊表述
- 必须给出具体的价格点位、时间节点和操作比例
- 语气要求：客观、专业、犀利、不论情面，严格遵守纪律

### 3.4 备用分析（Fallback Analysis）

**函数**: `ai_service.py: get_fallback_analysis()`

**触发条件**：
- Gemini API不可用
- API密钥未配置
- API调用失败

**生成内容**：
- 基础的投资分析报告
- 包含G=B+M模型分析
- 包含风险评分和建议
- 包含目标价格和止损价格
- 不包含AI生成的深度分析

---

## 报告结构与内容

### 报告格式

- **格式**: Markdown
- **编码**: UTF-8
- **语言**: 中文（简体）

### 报告各部分详细说明

#### 第一部分：投资风格与原则重申

**目的**：确保AI分析符合用户选择的投资风格

**内容**：
- 当前投资风格名称
- 风格核心原则说明
- 仓位限制说明

**示例**：
```markdown
### 投资风格与原则

**当前投资风格**: 质量 (Quality)

**风格核心原则**: 关注财务稳健、盈利能力强、债务水平低、护城河深的优质公司，适合长期持有，最大仓位20%

**仓位限制**: 根据质量风格，建议最大仓位为18%
```

#### 第二部分：公司概况

**目的**：提供公司基本信息和最新动态

**内容**：
- 公司业务介绍（不超过4句话）
- 最新动态（3-5条重要新闻）

**数据来源**：
- Yahoo Finance公司信息
- Yahoo Finance最新新闻（最多5条）

#### 第三部分：AlphaGBM (G=B+M) 深度解构

**目的**：基于G=B+M模型进行深度分析

**G (价格差异)维度**：
- 当前价格在52周区间的位置
- 价格相对于内在价值的偏离程度
- 技术面分析（MA50、MA200、价格位置）

**B (基本面)维度**：
- 营收增长率分析
- 利润率分析
- 财务健康状况评估
- 债务水平评估

**M (动量)维度**：
- 市场情绪评分
- 估值水平（PE、PEG）
- 期权市场数据（VIX、Put/Call比率）
- 宏观经济环境
- 中国市场情绪（A股/港股）

#### 第四部分：五大支柱检查

**目的**：从多个角度验证投资决策

**怀疑主义 (Skepticism)**：
- 充当"空头律师"
- 列出2-3个不买这只股票的理由

**事前验尸 (Pre-mortem)**：
- 假设买入后一年亏损50%
- 分析最可能的原因

#### 第四.五部分：风险控制评估

**目的**：全面评估风险并提供控制建议

**风险评分**：
- 系统综合评估风险评分 X/10
- 风险等级（低/中/高/极高）

**主要风险因素**：
- 列出所有风险点（来自`risk_result['flags']`）

**短期波动风险（基于量化模型）**：
- 加权期望值（来自EV模型）
- 风险评估（来自EV模型）
- 短期概率分布（上涨概率/下跌概率）
- 投资风格说明（短期波动对中长期投资的影响）

**风险控制建议**：
- 仓位限制建议
- 止损设置建议
- 退出条件说明

#### 第五部分：估值分析与交易策略

**目的**：提供具体的交易建议

**估值分析**：
- 基于PE、PEG、增长率等指标的估值评估
- 目标价格的计算依据和合理性
- 当前价格相对于合理估值的偏离程度
- **宏观环境对估值的影响**：
  - 美债收益率如何影响估值
  - 美元指数如何影响估值
  - VIX如何影响估值
  - 高利率环境对成长股估值的影响

**交易策略**：
- **操作建议**：
  - 必须考虑当前价格与目标价格的关系
  - 如果当前价格 >= 目标价格：不能建议"买入"
  - 如果当前价格 >= 目标价格 * 1.2：强烈建议"卖出"
- **目标价格**：系统计算的目标价格，说明合理性
  - **⚠️ 周期定义**：必须明确说明"本目标价格为6-12个月的中期目标价"
  - 提醒投资者：目标价不是短期交易信号，而是基于基本面价值回归的中期预期
- **止损价格**：系统计算的止损价格，说明合理性
- **建仓策略**：详细说明如何建仓
- **持有周期**：根据投资风格建议持有时间
- **仓位管理**：重申建议仓位，说明仓位管理原则
- **⚠️ 财报日避险检查（强制规则）**：
  - 如果财报日期 < 7天（高危）：**强烈建议在财报前3天避险或减仓**
  - 如果财报日期 7-14天（中危）：**建议提前规划，考虑在财报前适当减仓**
  - 如果财报日期 > 14天（低危）：**正常持有，但需关注财报日期**
  - **避险规则**：财报前3天建议减仓30-50%，或全部卖出避险，待财报后再决定是否重新建仓

#### 第六部分：卖出策略

**目的**：提供完整的风险控制方案

**止盈策略**：
- 当前价格与目标价格的关系
- 达到目标价格时的操作方案
- 根据投资风格的止盈点建议

**止损策略**：
- 系统设置的止损价格和止损幅度
- 止损价格的合理性说明
- 预警点设置建议
- 严格执行止损的纪律说明

**分阶段卖出策略**：
- 分批建仓对应的分批卖出策略
- 分阶段减仓的价格点位和比例
- 完全退出的时间节点

**特殊情况卖出**：
- 基本面恶化时的应对
- 估值过高时的应对
- 市场情绪变化时的调整

**卖出时机建议**：
- 避免在财报发布前卖出
- 避免在期权到期日附近卖出
- 根据重要经济事件调整卖出时机

**风险规避原则**：
- 严格执行止损
- 达到目标价格后的操作
- 系统性风险的应对
- 基本面恶化的应对
- 估值过高的应对

---

## 特殊场景处理

### ETF/基金识别与处理

**识别方法**：
- 检查公司名称中的关键词（ETF、Fund、Trust、REIT等）
- 检查行业分类
- 检查股票代码特征

**特殊处理**：
- 不使用公司财务指标（营收、利润、PE等）
- 分析重点：跟踪标的指数、跟踪误差、管理费率、流动性
- 杠杆ETF需要特别标注风险（如3x杠杆）

**Prompt调整**：
- 使用ETF专用Prompt模板
- 明确说明ETF不适用公司财务指标

### 中国市场特殊处理（A股/港股）

**数据增强**：
- 获取中国市场特有情绪数据
- 获取政策风向数据
- 获取龙虎榜数据
- 获取主力资金流向数据

**情绪评分调整**：
- 中国市场情绪权重：40%
- 政策面权重最高（政策 > 一切）
- 混合计算：60%传统指标 + 40%中国市场指标

**Prompt增强**：
- 添加"中国市场特有情绪面"章节
- 强调政策面权重 > 基本面权重
- 说明关键词触发器（"印发"、"规划"、"立案调查"等）

### 数据获取失败处理

**重试机制**：
- 默认3次重试
- 指数退避策略
- 自动切换备用数据源

**降级策略**：
- Yahoo Finance失败 → 切换到Alpha Vantage（仅美股）
- 如果所有数据源失败 → 返回错误信息

**部分数据缺失**：
- 如果部分数据缺失，使用默认值或标记为"N/A"
- 不影响整体分析流程

### AI报告生成失败处理

**降级策略**：
- Gemini API失败 → 使用备用分析 (`get_fallback_analysis()`)
- 备用分析提供基础报告，不包含AI深度分析

**错误处理**：
- 捕获所有异常
- 记录错误日志
- 返回友好的错误信息

---

## 错误处理与降级策略

### 数据获取错误

**错误类型**：
- 网络连接错误
- 数据源速率限制
- 股票代码不存在
- 数据格式错误

**处理策略**：
1. 重试机制（3次，指数退避）
2. 切换备用数据源（Alpha Vantage）
3. 使用默认值或标记为"N/A"
4. 返回友好的错误信息

### 量化分析错误

**错误类型**：
- 数据不足导致计算失败
- 数学计算错误（除零等）
- 逻辑错误

**处理策略**：
1. 使用默认值（如风险评分5.0，市场情绪5.0）
2. 标记计算失败的原因
3. 继续执行后续流程
4. 记录错误日志

### AI报告生成错误

**错误类型**：
- Gemini API连接失败
- API密钥无效
- API速率限制
- 响应格式错误

**处理策略**：
1. 使用备用分析 (`get_fallback_analysis()`)
2. 备用分析提供基础报告
3. 记录错误日志
4. 返回基础报告（不包含AI深度分析）

### 用户查询限制

**限制规则**：
- 普通用户：每日5次查询
- 特定用户：可通过环境变量配置（`USER_<USER_ID>_MAX_QUERIES`）

**处理策略**：
- 检查用户查询次数
- 如果达到上限，返回429状态码
- 提供重置时间信息

---

## 数据流图

```
用户请求
  ↓
身份验证 & 查询次数检查
  ↓
股票代码标准化
  ↓
数据获取阶段
  ├─ 基础市场数据 (yfinance)
  ├─ IPO与解禁监控 (美股/港股: IPO+180天, A股: AkShare)
  ├─ 宏观经济数据
  ├─ 期权市场数据
  └─ 中国市场情绪数据 (A股/港股)
  ↓
量化分析阶段
  ├─ 风险评分计算
  ├─ 市场情绪评分计算
  ├─ 目标价格计算
  ├─ 动态止损价格计算
  └─ EV模型计算
  ↓
AI报告生成阶段
  ├─ Prompt构建
  ├─ Gemini AI调用
  └─ 报告格式化
  ↓
结果返回
  ├─ 数据序列化
  ├─ 数据库记录
  └─ JSON响应
```

---

## 关键参数配置

### 风险评分阈值

- **极高风险**: >= 8分（强烈不建议建仓）
- **高风险**: >= 6分（不建议建仓）
- **中等风险**: >= 4分（减半仓位）
- **低风险**: < 4分（正常仓位）

### 仓位上限

- **Quality**: 20%
- **Value**: 10%
- **Growth**: 15%
- **Momentum**: 5%

### 止损参数

- **ATR倍数**: 2.5（默认）
- **最小止损幅度**: 5%
- **固定止损幅度**: 15%（降级方案）

### 市场情绪阈值

- **VIX极高恐慌**: > 30
- **VIX高恐慌**: > 25
- **Put/Call极度看跌**: > 1.5
- **Put/Call看跌**: > 1.2

### 目标价格计算参数

- **增长率折现因子**: 0.6（保守折现）
- **PEG阈值**: 1.5（合理估值）
- **技术面保守系数**: 0.9（基于52周高点）
- **目标价格周期**: 6-12个月（中期目标价）
  - 华尔街标准：12个月
  - AlphaGBM调整：结合动量（M）维度，定义为6-12个月
  - 周期合理性：3-6个月太短，基本面价值回归需要2个季度以上验证

### 解禁期风险参数

- **美股/港股解禁期计算**: IPO日期 + 180天
  - 美股标准锁定期：180天
  - 港股标准锁定期：6个月（约180天）
- **A股解禁期数据源**: AkShare
  - 1年期解禁：IPO原始股东锁定期1年
  - 3年期解禁：IPO原始股东锁定期3年
  - 定增解禁：定向增发股份解禁（通常6个月或1年）
  - 限售股解禁：其他限售股解禁
- **供给侧冲击警告阈值**: < 14天
  - 高危阈值：< 7天（风险评分+2.5分）
  - 中危阈值：7-14天（风险评分+1.5分）
- **风险标志**: "解禁期风险：解禁将在X天后到来，可能面临巨大抛压"

### 财报日期风险参数

- **高危阈值**: < 7天（财报即将发布，波动率风险极高）
  - 风险评分增加：+1分
  - 避险建议：财报前3天减仓30-50%或全部卖出
- **中危阈值**: 7-14天（财报临近，需要关注）
  - 风险评分增加：+0.5分
  - 避险建议：提前规划，考虑在财报前适当减仓
- **低危阈值**: > 14天（财报较远，正常显示）
  - 风险评分增加：0分
  - 避险建议：正常持有，但需关注财报日期
- **避险时间窗口**: 财报前3天（强制检查）

---

## 总结

AlphaGBM 股票研究报告生成系统是一个**多阶段、多数据源、多模型融合**的复杂系统，通过以下方式确保报告质量：

1. **数据完整性**：多数据源获取，自动重试和降级
2. **量化准确性**：基于G=B+M模型的科学计算
3. **AI深度分析**：Gemini AI提供专业的定性分析
4. **风险控制**：全面的风险评分和卖出策略
5. **特殊场景处理**：ETF、中国市场等特殊场景的专门处理

系统设计遵循**"量化+AI"**的双重保障原则，确保报告既科学严谨，又具有深度洞察。

---

**文档版本**: v1.0  
**最后更新**: 2025-01-XX  
**维护者**: AlphaGBM Team
