<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaGBM æ™ºèƒ½ä½“æµ‹è¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }
        .chat-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
        }
        .message.user {
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid #3b82f6;
        }
        .message.assistant {
            background: rgba(16, 185, 129, 0.2);
            border-left: 3px solid #10b981;
        }
        .message.system {
            background: rgba(148, 163, 184, 0.2);
            border-left: 3px solid #94a3b8;
            font-size: 0.9rem;
        }
        .typing-indicator {
            display: none;
        }
        .typing-indicator.active {
            display: block;
        }
    </style>
</head>
<body class="p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-400">
            ğŸ¤– AlphaGBM æ™ºèƒ½ä½“æµ‹è¯•
        </h1>
        <p class="text-slate-400 mb-6">åŸºäº G=B+M æ¨¡å‹çš„AIæŠ•èµ„åˆ†ææ™ºèƒ½ä½“</p>

        <!-- é…ç½®åŒºåŸŸ -->
        <div class="bg-slate-800 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold mb-3">é…ç½®</h2>
            <div class="space-y-2">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">æœåŠ¡åœ°å€</label>
                    <input type="text" id="serviceUrl" value="http://localhost:8001" 
                           class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white">
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Bearer Token (å¯é€‰ï¼Œç”¨äºé‰´æƒ)</label>
                    <input type="text" id="bearerToken" placeholder="Bearer token..." 
                           class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white">
                </div>
            </div>
        </div>

        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="bg-slate-800 rounded-lg p-4 mb-4">
            <div class="chat-container" id="chatContainer">
                <div class="message system">
                    <strong>ç³»ç»Ÿ:</strong> æ™ºèƒ½ä½“æœåŠ¡å·²è¿æ¥ã€‚ä½ å¯ä»¥å¼€å§‹æé—®äº†ï¼
                    <br><small>æç¤ºï¼šè¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ AAPLã€600519ï¼‰æˆ–å‘é€æ–°é—»é“¾æ¥è¿›è¡Œåˆ†æ</small>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="message assistant">
                    <span class="inline-flex items-center">
                        <span class="animate-pulse">â—</span>
                        <span class="ml-2">æ™ºèƒ½ä½“æ­£åœ¨æ€è€ƒ...</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="bg-slate-800 rounded-lg p-4">
            <div class="flex gap-2">
                <input type="text" id="messageInput" 
                       placeholder="è¾“å…¥é—®é¢˜ï¼Œå¦‚ï¼šåˆ†æä¸€ä¸‹AAPL" 
                       class="flex-1 bg-slate-700 border border-slate-600 rounded px-4 py-2 text-white"
                       onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()" 
                        class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded font-semibold">
                    å‘é€
                </button>
            </div>
            <div class="mt-3 flex gap-2 flex-wrap">
                <button onclick="quickQuestion('åˆ†æä¸€ä¸‹AAPL')" 
                        class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded">
                    ğŸ“Š åˆ†æAAPL
                </button>
                <button onclick="quickQuestion('å¯¹æ¯”èŒ…å°å’Œäº”ç²®æ¶²')" 
                        class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded">
                    ğŸ” å¯¹æ¯”è‚¡ç¥¨
                </button>
                <button onclick="quickQuestion('æŸ¥è¯¢SOLé“¾ä¸Šçš„ä»£å¸')" 
                        class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded">
                    ğŸª™ æŸ¥è¯¢ä»£å¸
                </button>
            </div>
        </div>

        <!-- çŠ¶æ€ä¿¡æ¯ -->
        <div class="mt-4 text-center text-sm text-slate-400">
            <span id="statusText">å°±ç»ª</span>
        </div>
    </div>

    <script>
        const serviceUrl = document.getElementById('serviceUrl');
        const bearerToken = document.getElementById('bearerToken');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const typingIndicator = document.getElementById('typingIndicator');
        const statusText = document.getElementById('statusText');

        let messages = [];

        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            if (role === 'user') {
                messageDiv.innerHTML = `<strong>ä½ :</strong> ${content}`;
            } else if (role === 'assistant') {
                messageDiv.innerHTML = `<strong>æ™ºèƒ½ä½“:</strong> ${content}`;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function quickQuestion(question) {
            messageInput.value = question;
            sendMessage();
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            messages.push({ role: 'user', content: message });
            messageInput.value = '';

            // æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨
            typingIndicator.classList.add('active');
            statusText.textContent = 'æ­£åœ¨è¿æ¥æ™ºèƒ½ä½“...';

            try {
                const url = serviceUrl.value + '/api/v1/chat';
                const token = bearerToken.value.trim();

                const headers = {
                    'Content-Type': 'application/json'
                };

                if (token) {
                    headers['Authorization'] = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ messages: messages })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('é‰´æƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥Token');
                    } else if (response.status === 402) {
                        throw new Error('é¢åº¦ä¸è¶³ï¼Œè¯·å‡çº§åˆ°Proä¼šå‘˜');
                    } else {
                        const errorText = await response.text();
                        throw new Error(`è¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`);
                    }
                }

                // å¤„ç†æµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                let assistantMessage = '';
                let assistantDiv = null;

                statusText.textContent = 'æ™ºèƒ½ä½“æ­£åœ¨å›å¤...';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.content) {
                                    if (!assistantDiv) {
                                        assistantDiv = document.createElement('div');
                                        assistantDiv.className = 'message assistant';
                                        assistantDiv.innerHTML = '<strong>æ™ºèƒ½ä½“:</strong> ';
                                        chatContainer.appendChild(assistantDiv);
                                        typingIndicator.classList.remove('active');
                                    }
                                    
                                    assistantMessage += data.content;
                                    assistantDiv.innerHTML = `<strong>æ™ºèƒ½ä½“:</strong> ${assistantMessage}`;
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                } else if (data.done) {
                                    statusText.textContent = 'å›å¤å®Œæˆ';
                                    if (assistantMessage) {
                                        messages.push({ role: 'assistant', content: assistantMessage });
                                    }
                                } else if (data.error) {
                                    throw new Error(data.error);
                                }
                            } catch (e) {
                                // å¿½ç•¥JSONè§£æé”™è¯¯
                            }
                        }
                    }
                }

                typingIndicator.classList.remove('active');
                statusText.textContent = 'å°±ç»ª';

            } catch (error) {
                typingIndicator.classList.remove('active');
                statusText.textContent = 'é”™è¯¯';
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message system';
                errorDiv.innerHTML = `<strong>é”™è¯¯:</strong> ${error.message}`;
                chatContainer.appendChild(errorDiv);
                
                console.error('é”™è¯¯:', error);
            }
        }

        // æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
        async function checkHealth() {
            try {
                const response = await fetch(serviceUrl.value + '/api/v1/health');
                const data = await response.json();
                statusText.textContent = `æœåŠ¡çŠ¶æ€: ${data.status}`;
            } catch (error) {
                statusText.textContent = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å¥åº·çŠ¶æ€
        window.onload = () => {
            checkHealth();
        };
    </script>
</body>
</html>
