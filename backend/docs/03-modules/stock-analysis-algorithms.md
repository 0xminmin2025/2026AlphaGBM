# 股票分析算法 (Stock Analysis Algorithms)

AlphaGBM 股票分析系统核心算法。迁移自 `docs/STOCK_ALGORITHM.md`。

---

## 1. 核心模型：G = B + M

```
G (Gain) = B (Basics: 基本面) + M (Momentum: 市场情绪)
```

| 维度 | 组成 | 数据来源 |
|------|------|----------|
| **B** | PE/PEG、营收增长率、利润率、ROE、FCF | yfinance / defeatbeta-api |
| **M** | VIX、MA50/MA200、Put/Call、宏观环境 | yfinance / Tiger API |

**分析管线**: `analyze_stock(ticker, style)` → get_market_data → get_options_market_data → get_macro_market_data → analyze_risk_and_position → calculate_market_sentiment → calculate_ev_model → calculate_target_price → calculate_atr_stop_loss → get_gemini_analysis

---

## 2. 五大风险支柱

累加制评分，总分 0-10：`估值风险 + 增长风险 + 流动性风险 + 市场风险 + 技术风险`

| 风险支柱 | 触发条件 | 加分 |
|----------|----------|------|
| **估值** | PE > 60 / PE > 40 / PEG > 2.0 / PE+Z-Score 高 | +2.0 / +1.5 / +1.0 / +0.5 |
| **增长** | Growth < -10% / Growth < 0% | +2.0 / +1.0 |
| **流动性** | 成交额 < 市场门槛 | +2.0 |
| **市场** | VIX > 30 / P/C > 1.5 / 10Y > 4.5% | +1.5 / +1.0 / +0.5 |
| **技术** | Price < MA50x90% / Price < MA200 | +0.5 / +1.0 |

**建议仓位**: 0-2 分 → 20%; 2-4 → 15%; 4-6 → 10%; 6-8 → 5%; 8-10 → 0%

---

## 3. 市场情绪计算（11 因子）

| 因子 | 权重 | 因子 | 权重 |
|------|------|------|------|
| PE 情绪 | 30% | 技术面 | 10% |
| 价格位置 | 25% | 美债收益率 | 4% |
| PEG 情绪 | 15% | 美元指数 | 3% |
| VIX | 12% | Polymarket | 3% |
| Put/Call | 8% | 黄金/原油 | 2%/1% |

### PE 情绪

| PE | 分 | PE | 分 |
|-----|-----|-----|-----|
| < 10 | 3.0 | 25-40 | 7.0 |
| 10-15 | 4.0 | 40-60 | 8.5 |
| 15-25 | 5.0 | > 60 | 9.5 |

### PEG 情绪（动态阈值）

```python
threshold = max(0.5, min(2.0, 1.5 * (1 - (yield_10y - 0.03) * 0.15)))
PEG < 0.7*t → 8.0; < t → 6.0; < 1.3*t → 5.0; > 1.3*t → 3.0
```

### 价格位置

```python
pos = (price - low52) / (high52 - low52)
<0.2 → 2.0; 0.2-0.4 → 4.0; 0.4-0.6 → 5.0; 0.6-0.8 → 7.0; >0.8 → 8.5
```

### VIX 情绪

| VIX | 分 | VIX | 分 |
|-----|-----|-----|-----|
| < 15 | 8.0 | 25-30 | 3.5 |
| 15-20 | 6.5 | 30-40 | 2.0 |
| 20-25 | 5.0 | > 40 | 1.0 |

VIX 变化 > 10% 时额外调整: 下降 +1.0, 上升 -1.5

### Put/Call

< 0.7 → 7.5; 0.7-0.9 → 6.0; 0.9-1.1 → 5.0; 1.1-1.3 → 4.0; 1.3-1.5 → 3.0; > 1.5 → 2.0

### 美债收益率

< 2.5% → 7.0; 2.5-3.5% → 6.0; 3.5-4.5% → 5.0; 4.5-5.0% → 4.0; > 5.0% → 2.5

---

## 4. 五种目标价格方法

| # | 方法 | 核心逻辑 |
|---|------|----------|
| 1 | PE 估值法 | `price * (reasonable_pe / current_pe)`，高估/低估/合理分别乘 1.0/0.9/0.95 |
| 2 | PEG 估值法 | `price * min(dynamic_threshold / peg, 1.5)` |
| 3 | 增长折现 | growth > 30%: `1 + g*0.6`; > 15%: `*0.4`; > 0%: `*0.2`; margin > 15% 再 x1.1 |
| 4 | DCF | 5 年 FCF（年递减 10%）+ Gordon Growth 永续值（terminal_growth <= 2.5%） |
| 5 | 技术面 | 基于 52 周位置和均线（pos < 0.3/0.7/0.7+ 分别对应不同目标） |

**行业权重**:

| 行业 | PE | PEG | 增长 | DCF | 技术 |
|------|-----|------|------|------|------|
| 科技/医疗 | 20% | 25% | 25% | 20% | 10% |
| 金融 | 45% | 15% | 15% | 10% | 15% |
| 能源/公用 | 30% | 10% | 15% | 30% | 15% |
| 默认 | 30% | 20% | 20% | 20% | 10% |

**风险调整**: risk >= 6 → x0.85; >= 4 → x0.92; else x1.0

---

## 5. EV 多时间视界模型

```
EV = P(up) * magnitude(up) + P(down) * magnitude(down)
ev_weighted = ev_1w * 0.50 + ev_1m * 0.30 + ev_3m * 0.20
```

### 概率调整因子

| 因子 | 条件 → 调整 |
|------|-------------|
| 价格位置 | pos < 30% → +10%; > 80% → -10% |
| 均线排列 | 多头 → +12%; 金叉 → +8%; 空头 → -12%; 死叉 → -8% |
| 基本面 | PEG < 1 → +8%; PEG > 2 → -5%; Growth > 20% → +5%; < 0% → -8% |
| 风险评分 | >= 4 → -15%; >= 3 → -10%; >= 2 → -5%; <= 1 → +5% |
| 情绪 | (sentiment - 5.0) x 0.02 |

概率范围: **20%-80%**。波动幅度: `annual_vol * sqrt(days/252)`

### EV 评分 & 推荐

```python
score = 5.0 + (ev_weighted * 25) - (risk * 0.3)      # 0-10 分制
```

| EV | 推荐 | EV | 推荐 |
|----|------|----|------|
| > +8% | STRONG_BUY | -8%~-3% | AVOID |
| +3%~+8% | BUY | < -8% | STRONG_AVOID |
| -3%~+3% | HOLD | | |

### 信心度（4 因子加权）

时间一致性 40% + 信号强度 30% + 数据质量 20% + 波动稳定性 10%

---

## 6. ATR 动态止损

```python
ATR(14) = SMA(TrueRange, 14)
stop_loss = price - ATR * multiplier       # 基础 2.5，范围 1.5-4.0
hard_stop = price * 0.85                   # 15% 硬止损
final = min(atr_stop, hard_stop)
```

**Beta 调整**: > 1.5 → x1.2; 1.2-1.5 → x1.1; 0.8-1.0 → x0.9; < 0.8 → x0.8

**VIX 调整**: > 20 → `+min(1.0, (vix-20)/10 * 0.3)`; < 15 → -0.2

---

## 7. 市场预警系统

| 预警 | 条件 | 级别 |
|------|------|------|
| VIX 恐慌/接近/快速上升 | >= 30 / >= 25 / >= 20+变化 > 10% | HIGH/MEDIUM/MEDIUM |
| Put/Call | >= 1.5 / >= 1.2 | HIGH/MEDIUM |
| 美债 | 10Y >= 5.0% / >= 4.5% | HIGH/MEDIUM |
| 黄金暴涨 | 变化 > 3% / > 1.5% | HIGH/MEDIUM |
| 美联储会议 | <= 3 天 / 4-7 天 / 8-14 天 | HIGH/MEDIUM/LOW |
| CPI 发布 | <= 3 天 / 4-7 天 | MEDIUM/LOW |
| 期权到期 | <= 3 天（四重）/ 4-7 天 | HIGH/MEDIUM |
| 财报 | 0-3 天 / 4-7 天 | HIGH/MEDIUM |
| 地缘政治 | 风险指数 >= 7 / >= 6 | HIGH/MEDIUM |

**地缘政治风险指数**: 黄金变化 40% + VIX 30% + 美元指数 20% + 原油波动 10%

---

## 8. 市场差异化

| 参数 | 美股 | 港股 | A 股 |
|------|------|------|------|
| 流动性门槛 | $500 万 | $200 万 | 2000 万元 |
| 风险溢价 | 1.0 | 1.15 | 1.3 |
| PE 高风险阈值 | 40 | 35 | 50 |

**中国市场情绪因子**: 政策面 40% + 北向资金 20% + 融资融券 15% + 技术面 15% + 大宗商品 10%

---

## 9. 核心文件

| 文件 | 职责 |
|------|------|
| `backend/app/services/analysis_engine.py` | 核心分析引擎（3000+ 行） |
| `backend/app/services/ev_model.py` | EV 期望值模型 |
| `backend/app/services/ai_service.py` | AI 分析服务（Gemini） |
| `backend/app/services/data_provider.py` | 数据源抽象 |
| `backend/app/constants.py` | 配置参数与阈值 |

---

*文档版本: 2026.02 | 迁移自 docs/STOCK_ALGORITHM.md 并结构化重写*
