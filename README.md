# AlphaG - 基于 Gemini AI 的智能股票分析系统

一个集成了 Google Gemini AI 的股票投资分析系统，采用 **Alpha P (P=F+S) 模型**和**五大支柱投资框架**，为投资者提供专业的股票分析和投资建议。

## 📋 目录

- [功能特性](#功能特性)
- [技术架构](#技术架构)
- [安装指南](#安装指南)
- [配置说明](#配置说明)
- [使用方法](#使用方法)
- [投资模型说明](#投资模型说明)
- [API 接口](#api-接口)
- [项目结构](#项目结构)
- [注意事项](#注意事项)
- [常见问题](#常见问题)

## ✨ 功能特性

### 核心功能

1. **多市场支持**
   - 美股（如：AAPL, TSLA）
   - 港股（如：2525, 2525.HK）
   - A股（如：600519, 000001）

2. **智能股票代码识别**
   - 自动识别市场类型并添加相应后缀
   - 支持多种输入格式
   - **支持模糊搜索**：港股代码前面有0的情况（如：02525 自动识别为 02525.HK）
   - 自动优先识别A股（6位数字），然后识别港股（4-5位数字）

3. **Alpha P (P=F+S) 模型分析**
   - **P (价格 Price)**: 当前价格、52周区间、技术指标
   - **F (基本面 Fundamentals)**: 营收增长、利润率、PE/PEG 估值
   - **S (市场情绪 Sentiment)**: 市场情绪评分、VIX恐慌指数、期权市场数据、宏观经济指标

4. **风险评分系统**
   - 0-10 分风险评分
   - 风险等级分类（低/中/高/极高）
   - 风险点标识

5. **仓位建议**
   - 根据投资风格和风险评分计算建议仓位
   - 支持四种投资风格：
     - **质量 (Quality)**: 最大仓位 20%
     - **价值 (Value)**: 最大仓位 10%
     - **成长 (Growth)**: 最大仓位 15%
     - **趋势 (Momentum)**: 最大仓位 5%

6. **AI 投资分析报告**
   - 使用 Google Gemini AI 生成专业的投资分析报告
   - 包含投资风格分析、Alpha P (P=F+S) 深度解构、五大支柱检查、具体交易策略

7. **目标价格计算**
   - 多维度估值模型（PE/PEG估值、增长率折现、技术面分析）
   - 根据公司类别和投资风格调整权重

8. **市场预警系统**
   - VIX 恐慌指数预警
   - Put/Call 比率预警
   - 美债收益率预警
   - **重要经济事件提醒**（按国家分类）：
     - 🇺🇸 **美国**：美联储利率决议、CPI数据发布、期权到期日
     - 🇨🇳 **中国**：央行货币政策会议、CPI/PPI发布、GDP发布、PMI发布
     - 🌍 **其他国家**：其他重要经济事件
   - 财报日期提醒
   - 成交量异常检测
   - 地缘政治风险指数

9. **宏观经济数据**
   - 10年期美债收益率
   - 美元指数 (DXY)
   - 黄金价格
   - 原油价格
   - Polymarket 预测市场数据

10. **期权市场分析**
    - VIX 恐慌指数
    - Put/Call 比率
    - Vanna crush 和负 Gamma 风险检测

11. **ETF/基金识别与特殊分析**
    - 自动识别ETF和基金（包括杠杆ETF、REIT等）
    - ETF专用分析框架（不适用公司财务指标）
    - 针对ETF的技术面分析和跟踪误差评估

12. **行业智能推断**
    - 对于新上市公司或数据源缺失的情况
    - 根据公司名称和股票代码自动推断行业分类
    - 支持中英文关键词匹配

13. **📊 EV 期望值模型** ⭐ **新功能**
    - **数学期望计算**：EV = (上涨概率 × 上涨幅度) + (下跌概率 × 下跌幅度)
    - **多时间视界分析**：
      - 1周期望值（权重 50%）
      - 1月期望值（权重 30%）
      - 3月期望值（权重 20%）
    - **概率计算引擎**：
      - 基于历史相似度匹配
      - 考虑价格位置（52周高低点）
      - 技术面（均线关系）
      - 基本面（PE、PEG、增长率）
      - 风险评分
      - 市场情绪
    - **涨跌幅度估算**：
      - 优先使用期权隐含波动率
      - 备用历史波动率
      - 结合技术面支撑/阻力位
    - **交易推荐系统**：
      - 强烈买入（EV > 8%）
      - 买入（3% < EV < 8%）
      - 观望（-3% < EV < 3%）
      - 回避（-8% < EV < -3%）
      - 强烈回避（EV < -8%）
    - **量化指标**：
      - EV 评分（0-10分）
      - 盈亏比（Risk-Reward Ratio）
      - 夏普比率（简化版）
    - **可视化展示**：
      - 加权综合 EV 卡片
      - 三个时间视界对比
      - 概率分布显示
      - 推荐徽章（颜色编码）

14. **完整卖出策略**
    - 止盈策略（目标价格到达时的操作）
    - 止损策略（动态止损价格和预警点）
    - 分阶段卖出策略（分批卖出计划）
    - 特殊情况卖出（基本面恶化、估值过高、市场风险）
    - 卖出时机建议（避免在财报前、期权到期日等特殊时期卖出）

15. **用户反馈系统**
    - 反馈Bug报告
    - 功能建议/新指标需求
    - 模型有效性反馈（包括准确性评分、胜率估计、投资结果）
    - 其他反馈

## 🏗️ 技术架构

### 后端技术栈

- **Flask**: Web 框架
- **Flask-CORS**: 跨域支持
- **yfinance**: 股票数据获取
- **pandas & numpy**: 数据处理
- **google-generativeai**: Gemini AI 集成
- **python-dotenv**: 环境变量管理
- **requests**: HTTP 请求

### 前端技术栈

- HTML5 + CSS3
- JavaScript (原生)
- Chart.js (图表展示)
- Bootstrap 5 (模态框和UI组件)

### 系统架构

```
┌─────────────┐
│  前端界面    │
│ (index.html) │
└──────┬───────┘
       │ HTTP/JSON
       ▼
┌─────────────┐
│  Flask API  │
│   (app.py)   │
└──────┬───────┘
       │
       ├──► analysis_engine.py (数据分析引擎)
       │    ├── 数据获取
       │    ├── 风险评分
       │    ├── 市场情绪计算
       │    └── 目标价格计算
       │
       └──► ai_service.py (AI 服务)
            └── Gemini AI 分析报告生成
```

## 📦 安装指南

### 环境要求

- Python 3.8+
- pip

### 安装步骤

1. **克隆仓库**

```bash
git clone git@github.com:0xminmin2025/AlphaG.git
cd AlphaG
```

2. **创建虚拟环境**

```bash
python3 -m venv venv
source venv/bin/activate  # macOS/Linux
# 或
venv\Scripts\activate  # Windows
```

3. **安装依赖**

```bash
pip install -r requirements.txt
```

4. **配置环境变量**

创建 `.env` 文件（在项目根目录）：

```env
GOOGLE_API_KEY=your_gemini_api_key_here
ALPHA_VANTAGE_API_KEY=your_alpha_vantage_api_key_here  # 可选：备用数据源
```

获取 API Key：

**Gemini API Key（必需）**：
1. 访问 [Google AI Studio](https://makersuite.google.com/app/apikey)
2. 创建新的 API Key
3. 将 API Key 复制到 `.env` 文件中

**Alpha Vantage API Key（可选，备用数据源）**：
1. 访问 [Alpha Vantage](https://www.alphavantage.co/support/#api-key)
2. 注册免费账户并获取 API Key
3. 将 API Key 添加到 `.env` 文件中
4. **注意**：Alpha Vantage 仅支持美股数据，作为 Yahoo Finance 的备用数据源使用

## ⚙️ 配置说明

### 环境变量

| 变量名 | 说明 | 必需 |
|--------|------|------|
| `GOOGLE_API_KEY` | Google Gemini API 密钥 | 是 |

### 端口配置

默认端口：**5002**

> 注意：macOS 系统上端口 5000 被 Apple AirPlay 占用，因此使用 5002 端口。

如需修改端口，编辑 `app.py`：

```python
app.run(debug=True, port=5002, host='0.0.0.0', threaded=True)
```

### 查询次数限制

系统支持每日查询次数限制（可在前端配置）：
- 默认限制：10次/天
- 可在 `templates/index.html` 中修改 `MAX_QUERIES_PER_DAY` 常量
- 使用 localStorage 存储查询次数，每天自动重置

## 🚀 使用方法

### 启动服务器

```bash
python app.py
```

服务器启动后，访问：`http://127.0.0.1:5002`

### 使用界面

1. 在输入框中输入股票代码（如：AAPL, 2525, 600519）
2. 选择投资风格（质量/价值/成长/趋势）
3. 点击"分析"按钮
4. 等待分析完成（通常需要 5-15 秒）
5. 查看分析结果：
   - 股票基本信息
   - 风险评分和仓位建议
   - AI 生成的投资分析报告
   - 目标价格和止损价格
   - 市场预警信息

### 命令行测试

使用 curl 测试 API：

```bash
curl -X POST http://127.0.0.1:5002/api/analyze \
  -H "Content-Type: application/json" \
  -d '{"ticker": "AAPL", "style": "quality"}'
```

## 📊 投资模型说明

### Alpha P (P=F+S) 模型

**Alpha P 投资模型**，将股票价格分解为两个核心维度：

- **P (价格 Price)**: 当前市场价格
- **F (基本面 Fundamentals)**: 公司的财务健康状况和盈利能力
- **S (市场情绪 Sentiment)**: 市场对股票的估值和情绪

**核心理念**: 价格 = 内在价值 + 市场情绪溢价

### 五大支柱投资框架

1. **怀疑主义 (Skepticism)**: 充当"空头律师"，列出不买这只股票的理由
2. **事前验尸 (Pre-mortem)**: 假设买入后亏损 50%，分析最可能的原因
3. **风险控制**: 严格的仓位管理和止损纪律
4. **投资风格一致性**: 确保所有建议符合所选投资风格
5. **数据驱动**: 基于硬数据和逻辑，而非情绪

### 风险评分系统

风险评分范围：0-10 分

| 分数 | 风险等级 | 建议仓位调整 |
|------|---------|------------|
| 0-2 | 低 | 100% 基础仓位 |
| 2-4 | 中 | 70% 基础仓位 |
| 4-6 | 高 | 40% 基础仓位 |
| 6-10 | 极高 | 0% (不建议建仓) |

### 投资风格说明

#### 质量 (Quality)
- **核心原则**: 关注财务稳健、盈利能力强、债务水平低、护城河深的优质公司
- **最大仓位**: 20%
- **持有周期**: 长期 (1-3年)
- **适合**: 追求稳定收益的投资者

#### 价值 (Value)
- **核心原则**: 寻找被市场低估的股票，关注低PE、低PEG，追求安全边际
- **最大仓位**: 10%
- **持有周期**: 中期 (6-12个月)
- **适合**: 追求安全边际的价值投资者

#### 成长 (Growth)
- **核心原则**: 追求高营收增长和盈利增长的公司，容忍较高估值但要求持续增长
- **最大仓位**: 15%
- **持有周期**: 中短期 (3-6个月)
- **适合**: 追求高增长的成长投资者

#### 趋势 (Momentum)
- **核心原则**: 跟随市场趋势和价格动量，快进快出，关注技术面突破
- **最大仓位**: 5%
- **持有周期**: 短期 (1-3个月)
- **适合**: 追求短期收益的趋势投资者

## 🔌 API 接口

### POST /api/analyze

分析股票并返回投资建议。

**请求体**:

```json
{
  "ticker": "AAPL",
  "style": "quality"
}
```

**参数说明**:

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| ticker | string | 是 | 股票代码（支持美股、港股、A股） |
| style | string | 是 | 投资风格：quality/value/growth/momentum |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "symbol": "AAPL",
    "name": "Apple Inc.",
    "price": 175.50,
    "pe": 28.5,
    "growth": 0.15,
    "margin": 0.25,
    "market_sentiment": 6.5,
    "target_price": 185.00
  },
  "risk": {
    "score": 3,
    "level": "中",
    "flags": [],
    "suggested_position": 14.0
  },
  "report": "## 投资分析报告...\n\n[AI 生成的详细分析]"
}
```

### POST /api/feedback

提交用户反馈。

**请求体**:

```json
{
  "type": "bug|feature|model|other",
  "ticker": "AAPL",
  "content": "反馈内容",
  "contact": "user@example.com",
  "modelFeedback": {
    "accuracy": 5,
    "winRate": 75,
    "investmentResult": "profitable"
  }
}
```

**响应示例**:

```json
{
  "success": true,
  "message": "反馈提交成功"
}
```

**说明**:
- 反馈数据保存到 `feedback/feedback_YYYY-MM-DD.jsonl` 文件
- 支持反馈类型：bug（Bug报告）、feature（功能建议）、model（模型反馈）、other（其他）
- 模型反馈类型需要包含准确性评分（1-5分）

## 📁 项目结构

```
AlphaG/
├── app.py                 # Flask 应用主文件
├── analysis_engine.py     # 数据分析引擎
├── ai_service.py          # AI 服务（Gemini 集成）
├── requirements.txt      # Python 依赖
├── .env                  # 环境变量（需自行创建）
├── .gitignore           # Git 忽略文件
├── README.md            # 项目说明文档
├── templates/
│   └── index.html       # 前端界面
├── feedback/            # 用户反馈数据目录
│   └── feedback_*.jsonl # 按日期存储的反馈文件
├── logs/                # 日志目录
│   └── app.log          # 应用日志
├── venv/                # 虚拟环境（不提交到 Git）
├── __pycache__/         # Python 缓存（不提交到 Git）
└── 选股买卖逻辑与算法.md  # 详细的算法文档
```

## ⚠️ 注意事项

### 数据来源

- 股票数据来自 **Yahoo Finance** (yfinance)
- 数据可能存在延迟（通常 15-20 分钟）
- 部分股票可能无法获取完整数据

### API 限制

- **Gemini API**: 有免费额度限制，超出后需要付费
- 如果 Gemini API 不可用，系统会自动使用备用分析功能

### 投资建议

- **本系统仅供学习和研究使用，不构成投资建议**
- 所有投资决策应基于您自己的研究和判断
- 投资有风险，入市需谨慎
- 建议结合其他数据源和专家意见

### 数据准确性

- 系统尽力确保数据准确性，但不保证 100% 准确
- 建议定期验证关键数据
- 对于重要投资决策，请使用多个数据源验证

## ❓ 常见问题

### Q1: 为什么某些股票代码无法识别？

**A**: 系统会自动识别市场类型，支持模糊搜索：
- **港股**：支持前面有0的情况（如：02525 自动识别为 02525.HK）
- **A股**：6位数字自动识别（600/601/603/688开头 → .SS，000/001/002/300开头 → .SZ）
- 系统会优先识别A股，然后识别港股
- 如果自动识别失败，可以手动添加后缀：
- 港股：添加 `.HK`（如：2525.HK）
- A股上海：添加 `.SS`（如：600519.SS）
- A股深圳：添加 `.SZ`（如：000001.SZ）

### Q2: Gemini API 报错怎么办？

**A**: 
1. 检查 `.env` 文件中的 `GOOGLE_API_KEY` 是否正确
2. 确认 API Key 是否有效且有足够额度
3. 如果 API 不可用，系统会自动使用备用分析功能

### Q3: 分析结果不准确怎么办？

**A**: 
- 系统基于公开数据进行分析，可能存在数据延迟
- 建议结合其他数据源验证
- 可以尝试不同的投资风格，查看不同角度的分析

### Q4: 如何修改端口？

**A**: 编辑 `app.py` 文件，修改 `app.run()` 中的 `port` 参数。

### Q5: 支持哪些市场？

**A**: 目前支持：
- 美股（NYSE, NASDAQ）
- 港股（HKEX）
- A股（上交所、深交所）

### Q6: 如何获取更多市场数据？

**A**: 系统使用 yfinance 库，支持所有 Yahoo Finance 覆盖的市场。如需添加其他数据源，可以修改 `analysis_engine.py` 中的 `get_market_data()` 函数。

### Q7: ETF和普通股票的分析有什么区别？

**A**: 
- ETF不适用公司财务指标（营收、利润、PE等）
- ETF分析重点在于：跟踪标的指数、流动性、管理费率、跟踪误差、技术面表现
- 杠杆ETF会特别标注风险（如TQQQ的3x杠杆风险）

### Q8: 新上市公司的行业显示为"数据不足"怎么办？

**A**: 系统已实现行业智能推断功能：
- 对于新上市公司，会根据公司名称和股票代码自动推断行业
- 支持中英文关键词匹配
- 对于688开头的科创板股票，通常识别为科技类

### Q9: 如何提交反馈？

**A**: 
- 点击页面右下角的"💬 反馈建议"按钮
- 选择反馈类型（Bug报告、功能建议、模型反馈、其他）
- 填写详细描述
- 如果是模型反馈，还可以评分和填写胜率估计
- 反馈数据会保存到 `feedback/` 目录

### Q10: 卖出策略在哪里？

**A**: 在"六、投资建议"部分包含完整的卖出策略：
- 止盈策略
- 止损策略
- 分阶段卖出策略
- 特殊情况卖出
- 卖出时机建议

## 📝 更新日志

### v1.3.0 (2025-12-18)
- 🐛 **Bug修复**：
  - 修复ETF数据获取时的ERROR日志问题（抑制yfinance fundamentals 404错误，ETF没有财报数据是正常的）
  - 修复港股代码标准化问题：支持09988和9988两种格式输入，自动识别为9988.HK
  - 修复前端pricePosition.toFixed错误：确保价格位置计算为数字类型
  - 修复ETF估值显示问题：ETF不显示PE/PEG等不适用指标，改为显示ETF专用说明
- ✨ **功能增强**：
  - **ETF完整支持**：优化ETF识别、估值计算和前端显示，正确处理ETF特有属性
  - **Alpha Vantage备用数据源**：集成Alpha Vantage作为Yahoo Finance的备用数据源（仅支持美股）
  - **忘记密码功能**：添加密码重置功能，通过邮箱验证码重置密码
  - **公司概况增强**：AI报告中新增公司业务介绍和最新新闻动态（中文翻译）
  - **目标价格优化**：ETF使用技术面和52周区间估值，而非PE/PEG估值
  - **动态仓位调整**：根据当前价格与目标价格的关系，动态调整建议仓位
- 🔧 **代码优化**：
  - 优化yfinance日志输出，减少不必要的ERROR日志
  - 改进错误处理，提供更友好的错误提示
  - 优化前端代码，修复类型错误

### v1.2.0 (2025-12)
- 🎨 **UI优化**：
  - 优化投资理念部分UI设计（紧凑的可视化布局）
  - 改进查询次数上限模态框的按钮文字颜色，提升可读性
  - 优化核心模型文本显示（合并为单行显示）
- 🔧 **Bug修复**：
  - 修复API URL硬编码问题，改为相对路径，支持本地开发和生产环境
- ✨ **功能增强**：
  - 中国市场情绪数据集成（通过AkShare获取新闻、资金流向、政策信号）
  - 配置管理优化（提取魔法数字到config.py）
  - 动态PEG阈值（基于美债收益率调整）
  - 流动性风险检查（日均成交额阈值）
  - PE分位点计算框架（待历史数据源完善）

### v1.1.0 (2025-12)
- ✨ **ETF/基金识别与特殊分析**：自动识别ETF和基金，使用专用分析框架
- ✨ **股票代码模糊搜索**：支持港股前面有0的情况（如02525）
- ✨ **行业智能推断**：新上市公司根据名称和代码自动推断行业
- ✨ **经济事件分类显示**：按美国、中国、其他国家分组显示
- ✨ **完整卖出策略**：在投资建议中添加详细的卖出策略（止盈、止损、分阶段卖出等）
- ✨ **用户反馈系统**：添加反馈按钮和API，收集用户反馈、Bug报告、功能建议和模型有效性反馈
- 🔧 **亏损公司估值优化**：PE=0的公司不再直接判断为"不好"，考虑增长和市值
- 🔧 **每日查询次数限制**：可配置的查询限制（默认10次/天）
- 🐛 **修复**：重要经济事件显示格式问题
- 🐛 **修复**：ETF分析显示"财务分析"的问题

### v1.0.0 (2025-01)
- 初始版本发布
- 支持 Alpha P (P=F+S) 模型分析
- 集成 Gemini AI 生成投资报告
- 支持四种投资风格
- 市场预警系统
- 多市场股票数据支持

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

本项目仅供学习和研究使用。

## 👤 作者

- **minmin** - [GitHub](https://github.com/0xminmin2025)
- **Email**: nftventure@gmail.com

## 🙏 致谢

- [Yahoo Finance](https://finance.yahoo.com/) - 股票数据源
- [Google Gemini AI](https://ai.google.dev/) - AI 分析能力
- [Flask](https://flask.palletsprojects.com/) - Web 框架
- [yfinance](https://github.com/ranaroussi/yfinance) - 股票数据获取库

---

**免责声明**: 本系统仅供学习和研究使用，不构成任何投资建议。投资有风险，入市需谨慎。使用本系统进行投资决策的所有后果由用户自行承担。

