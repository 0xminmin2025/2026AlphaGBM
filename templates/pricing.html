{% extends "base.html" %}

{% block title %}定价 - AlphaGBM{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<script src="https://js.stripe.com/v3/"></script>
<style>
    :root {
        --primary: #3b82f6;
        --primary-dark: #2563eb;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --bg-dark: #0f172a;
        --card-bg: #1e293b;
        --text-primary: #e2e8f0;
        --text-muted: #94a3b8;
    }

    body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        min-height: 100vh;
        color: var(--text-primary);
    }

    .pricing-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .pricing-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .pricing-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .pricing-header p {
        font-size: 1.1rem;
        color: var(--text-muted);
    }

    .toggle-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-bottom: 3rem;
    }

    .toggle-switch {
        position: relative;
        width: 60px;
        height: 30px;
        background: var(--card-bg);
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid var(--primary);
    }

    .toggle-switch.active {
        background: var(--primary);
    }

    .toggle-slider {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 22px;
        height: 22px;
        background: white;
        border-radius: 50%;
        transition: all 0.3s;
    }

    .toggle-switch.active .toggle-slider {
        transform: translateX(30px);
    }

    .pricing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .pricing-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 2rem;
        border: 2px solid transparent;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }

    .pricing-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary);
        box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2);
    }

    .pricing-card.featured {
        border-color: var(--warning);
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    }

    .pricing-card.featured::before {
        content: '推荐';
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: var(--warning);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .plan-name {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .plan-price {
        font-size: 3rem;
        font-weight: 700;
        margin: 1rem 0;
        color: var(--primary);
    }

    .plan-price .period {
        font-size: 1rem;
        color: var(--text-muted);
        font-weight: 400;
    }

    .plan-description {
        color: var(--text-muted);
        margin-bottom: 1.5rem;
        min-height: 3rem;
    }

    .plan-features {
        list-style: none;
        padding: 0;
        margin: 1.5rem 0;
    }

    .plan-features li {
        padding: 0.75rem 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .plan-features li i {
        color: var(--success);
        font-size: 1.2rem;
    }

    .plan-button {
        width: 100%;
        padding: 1rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 1rem;
    }

    .plan-button.primary {
        background: var(--primary);
        color: white;
    }

    .plan-button.primary:hover {
        background: var(--primary-dark);
        transform: scale(1.02);
    }

    .plan-button.secondary {
        background: var(--card-bg);
        color: var(--text-primary);
        border: 2px solid var(--primary);
    }

    .plan-button.secondary:hover {
        background: var(--primary);
        color: white;
    }

    .plan-button.disabled {
        background: #334155;
        color: var(--text-muted);
        cursor: not-allowed;
    }

    .topup-section {
        margin-top: 4rem;
        padding-top: 3rem;
        border-top: 1px solid #334155;
    }

    .topup-section h2 {
        text-align: center;
        font-size: 2rem;
        margin-bottom: 2rem;
    }

    .topup-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        max-width: 800px;
        margin: 0 auto;
    }

    .topup-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        border: 2px solid transparent;
        transition: all 0.3s;
    }

    .topup-card:hover {
        border-color: var(--warning);
        transform: translateY(-3px);
    }

    .topup-card .badge {
        display: inline-block;
        background: var(--success);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        margin-bottom: 1rem;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 2rem;
    }

    .loading.active {
        display: block;
    }

    .spinner {
        border: 3px solid var(--card-bg);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .credits-info {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        text-align: center;
    }

    .credits-info h3 {
        margin-bottom: 1rem;
        color: var(--primary);
    }

    .credits-stats {
        display: flex;
        justify-content: space-around;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .credits-stat {
        flex: 1;
        min-width: 150px;
    }

    .credits-stat .value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
    }

    .credits-stat .label {
        color: var(--text-muted);
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="pricing-container">
    <div class="pricing-header">
        <h1>选择适合您的计划</h1>
        <p>灵活的定价方案，满足不同需求</p>
    </div>

    <!-- 用户额度信息 -->
    <div class="credits-info" id="creditsInfo" style="display: none;">
        <h3>我的额度</h3>
        <div class="credits-stats">
            <div class="credits-stat">
                <div class="value" id="totalCredits">0</div>
                <div class="label">总剩余额度</div>
            </div>
            <div class="credits-stat">
                <div class="value" id="dailyFree">0</div>
                <div class="label">今日免费额度</div>
            </div>
            <div class="credits-stat">
                <div class="value" id="subscriptionStatus">免费版</div>
                <div class="label">当前订阅</div>
            </div>
        </div>
    </div>

    <!-- 订阅计划 -->
    <div class="toggle-container">
        <span>月度</span>
        <div class="toggle-switch" id="periodToggle">
            <div class="toggle-slider"></div>
        </div>
        <span>年度 <span style="color: var(--success);">节省17%</span></span>
    </div>

    <div class="pricing-grid">
        <!-- 免费版 -->
        <div class="pricing-card">
            <div class="plan-name">免费版</div>
            <div class="plan-price">¥0</div>
            <div class="plan-description">适合偶尔使用的用户</div>
            <ul class="plan-features">
                <li><i class="bi bi-check-circle-fill"></i> 每天 2 次股票分析</li>
                <li><i class="bi bi-check-circle-fill"></i> 基础分析报告</li>
                <li><i class="bi bi-x-circle" style="color: var(--text-muted);"></i> 无期权分析</li>
                <li><i class="bi bi-x-circle" style="color: var(--text-muted);"></i> 无深度研报</li>
            </ul>
            <button class="plan-button disabled" disabled>当前计划</button>
        </div>

        <!-- Plus会员 -->
        <div class="pricing-card featured">
            <div class="plan-name">Plus 会员</div>
            <div class="plan-price">
                <span id="plusPrice">¥399</span>
                <span class="period" id="plusPeriod">/月</span>
            </div>
            <div class="plan-description" id="plusDescription">1000次查询/月，适合活跃投资者</div>
            <ul class="plan-features">
                <li><i class="bi bi-check-circle-fill"></i> <span id="plusCredits">1000</span> 次查询/月</li>
                <li><i class="bi bi-check-circle-fill"></i> AI 深度分析</li>
                <li><i class="bi bi-check-circle-fill"></i> 期权分析</li>
                <li><i class="bi bi-check-circle-fill"></i> 优先支持</li>
            </ul>
            <button class="plan-button primary" onclick="checkout('plus_monthly')" id="plusButton">订阅 Plus</button>
        </div>

        <!-- Pro会员 -->
        <div class="pricing-card">
            <div class="plan-name">Pro 会员</div>
            <div class="plan-price">
                <span id="proPrice">¥999</span>
                <span class="period" id="proPeriod">/月</span>
            </div>
            <div class="plan-description" id="proDescription">5000次查询/月，适合专业投资者</div>
            <ul class="plan-features">
                <li><i class="bi bi-check-circle-fill"></i> <span id="proCredits">5000</span> 次查询/月</li>
                <li><i class="bi bi-check-circle-fill"></i> 所有功能</li>
                <li><i class="bi bi-check-circle-fill"></i> 深度研报</li>
                <li><i class="bi bi-check-circle-fill"></i> 专属支持</li>
            </ul>
            <button class="plan-button secondary" onclick="checkout('pro_monthly')" id="proButton">订阅 Pro</button>
        </div>
    </div>

    <!-- 额度加油包 -->
    <div class="topup-section">
        <h2>额度加油包</h2>
        <p style="text-align: center; color: var(--text-muted); margin-bottom: 1rem;">
            为付费用户（Plus/Pro会员）用完月度额度后，单独购买的额外额度
        </p>
        <p style="text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 2rem;">
            一次性购买，3个月有效，不受月度限制
        </p>
        <div class="topup-grid" style="max-width: 400px;">
            <div class="topup-card">
                <div class="badge">100次</div>
                <div style="font-size: 2rem; font-weight: 700; margin: 1rem 0;">¥29</div>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem;">适合Plus/Pro会员</p>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">3个月有效，不受月度限制</p>
                <button class="plan-button secondary" onclick="checkout('topup_100')">立即充值</button>
            </div>
        </div>
    </div>

    <!-- 加载提示 -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 1rem;">正在跳转到支付页面...</p>
    </div>
</div>

<script>
    // 初始化Stripe（需要从后端获取公钥）
    const stripe = Stripe('pk_test_51...'); // 实际使用时从后端获取

    // 周期切换
    let isYearly = false;
    document.getElementById('periodToggle').addEventListener('click', function () {
        isYearly = !isYearly;
        this.classList.toggle('active');

        // 更新价格显示
        if (isYearly) {
            document.getElementById('plusPrice').textContent = '¥3990';
            document.getElementById('plusPeriod').textContent = '/年';
            document.getElementById('plusDescription').textContent = '12000次查询/年，适合活跃投资者';
            document.getElementById('plusCredits').textContent = '12000';
            document.getElementById('plusButton').setAttribute('onclick', "checkout('plus_yearly')");

            document.getElementById('proPrice').textContent = '¥9990';
            document.getElementById('proPeriod').textContent = '/年';
            document.getElementById('proDescription').textContent = '60000次查询/年，适合专业投资者';
            document.getElementById('proCredits').textContent = '60000';
            document.getElementById('proButton').setAttribute('onclick', "checkout('pro_yearly')");
        } else {
            document.getElementById('plusPrice').textContent = '¥399';
            document.getElementById('plusPeriod').textContent = '/月';
            document.getElementById('plusDescription').textContent = '1000次查询/月，适合活跃投资者';
            document.getElementById('plusCredits').textContent = '1000';
            document.getElementById('plusButton').setAttribute('onclick', "checkout('plus_monthly')");

            document.getElementById('proPrice').textContent = '¥999';
            document.getElementById('proPeriod').textContent = '/月';
            document.getElementById('proDescription').textContent = '5000次查询/月，适合专业投资者';
            document.getElementById('proCredits').textContent = '5000';
            document.getElementById('proButton').setAttribute('onclick', "checkout('pro_monthly')");
        }
    });

    // 创建支付会话
    async function checkout(priceKey) {
        const { data: { session } } = await window.supabaseClient.auth.getSession();
        if (!session) {
            alert('请先登录');
            window.showLoginModal();
            return;
        }

        document.getElementById('loading').classList.add('active');

        try {
            const headers = await window.getAuthHeaders();
            const response = await fetch('/api/payment/create-checkout-session', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    price_key: priceKey,
                    success_url: window.location.origin + '/pricing?success=true',
                    cancel_url: window.location.origin + '/pricing?canceled=true'
                })
            });

            if (!response.ok) {
                // 处理HTTP错误
                let errorMessage = '支付请求失败';

                if (response.status === 404) {
                    errorMessage = '支付功能暂未启用\n\n可能原因：\n1. 支付模块未正确加载\n2. Stripe未配置\n3. 服务器需要重启\n\n请联系管理员检查配置';
                } else if (response.status === 401) {
                    errorMessage = '登录已过期，请重新登录';
                    window.handleLogout(); // Clear local state
                    window.showLoginModal();
                    document.getElementById('loading').classList.remove('active');
                    return;
                } else if (response.status === 500) {
                    errorMessage = '服务器错误\n\n可能原因：\n1. Stripe未配置\n2. 支付服务初始化失败\n\n请检查服务器日志';
                } else {
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || `请求失败 (HTTP ${response.status})`;
                    } catch (e) {
                        errorMessage = `请求失败 (HTTP ${response.status}: ${response.statusText})`;
                    }
                }

                alert(errorMessage);
                console.error('支付请求失败详情:', {
                    status: response.status,
                    statusText: response.statusText,
                    url: response.url
                });
                document.getElementById('loading').classList.remove('active');
                return;
            }

            const data = await response.json();

            if (data.error) {
                alert(data.error);
                document.getElementById('loading').classList.remove('active');
                return;
            }

            // 跳转到Stripe支付页面
            if (data.checkout_url) {
                window.location.href = data.checkout_url;
            } else if (data.session_id) {
                // 使用Stripe.js重定向
                try {
                    const result = await stripe.redirectToCheckout({ sessionId: data.session_id });
                    if (result.error) {
                        alert(result.error.message);
                        document.getElementById('loading').classList.remove('active');
                    }
                } catch (stripeError) {
                    console.error('Stripe错误:', stripeError);
                    alert('Stripe未配置，请联系管理员');
                    document.getElementById('loading').classList.remove('active');
                }
            } else {
                alert('支付会话创建失败，请稍后重试');
                document.getElementById('loading').classList.remove('active');
            }
        } catch (error) {
            console.error('支付错误:', error);
            alert('支付请求失败，请稍后重试。如果问题持续，请检查网络连接或联系管理员。');
            document.getElementById('loading').classList.remove('active');
        }
    }

    // 加载用户额度信息
    async function loadCreditsInfo() {
        const { data: { session } } = await window.supabaseClient.auth.getSession();
        if (!session) {
            return;
        }

        try {
            const headers = await window.getAuthHeaders();
            const response = await fetch('/api/payment/credits', {
                headers: headers
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById('totalCredits').textContent = data.total_credits || 0;
                document.getElementById('dailyFree').textContent = data.daily_free?.remaining || 0;

                if (data.subscription?.has_subscription) {
                    document.getElementById('subscriptionStatus').textContent =
                        data.subscription.plan_tier === 'plus' ? 'Plus会员' : 'Pro会员';
                }

                document.getElementById('creditsInfo').style.display = 'block';
            }
        } catch (error) {
            console.error('加载额度信息失败:', error);
        }
    }

    // 检查URL参数
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
        alert('支付成功！额度已到账');
        loadCreditsInfo();
    } else if (urlParams.get('canceled') === 'true') {
        // 用户取消了支付，不显示提示
    }

    // 页面加载时获取额度信息
    loadCreditsInfo();
</script>
{% endblock %}